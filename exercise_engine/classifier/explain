תרשים זרימה (ASCII) — בחירת תרגיל יציבה ללא ריצוד
         קלט: canonical metrics (מה-Normalizer)
                       │
                       ▼
            [1] הסקת ציוד (רכה)
        ("barbell"/"none"/"other")
                       │
                       ▼
           [2] סינון מועמדים לפי ציוד
          (מתוך exercise_library)
                       │
                       ▼
           [3] ניקוד התאמה לכל מועמד
    - must_have קיימים?        +נק'
    - ערכים בטווח?             +נק'
    - pose_view (אם קיים)?     +נק'
    → ציון 0..1 לכל מועמד
                       │
                       ▼
           [4] דירוג מועמדים + ספים
    top1 ≥ S_MIN_ACCEPT ?  (ברירת מחדל 0.40)
           │                 │
           │ כן              │ לא
           ▼                 ▼
 [5] Hysteresis & Sticky     [6] Fallback
  - אם margin<0.10 ⇒ שמור    - אם יש בחירה קודמת יציבה ⇒ שמור
    תרגיל קודם               - אחרת ⇒ Bodyweight/none
  - אם margin≥0.20 וה־freeze לא פעיל ⇒ החלף
  - confidence עם EMA (α=0.25)
                       │
                       ▼
              [7] פלט PickResult
exercise_id, confidence, reason,
stability (kept_previous/margin/freeze),
candidates[], diagnostics[]
                       │
                       ▼
           Runtime → validate → score → report

הסבר קצר לפי שלבים

הסקת ציוד (רכה)
מסתכלים על מדדים (למשל objdet, bar.*). אם אין ראיות – equipment="none" (Bodyweight).

סינון מועמדים
מתוך הספרייה, שומרים רק תרגילים עם אותו ציוד משוער.

ניקוד התאמה (0..1)
לכל מועמד:

must_have (קיימים בקנוני) = נקודות.

ranges (האם הערך בטווח) = נקודות.

pose_view (אם יש view_mode) = נקודות.
סכום משוקלל → נרמול ל־0..1.

דירוג + סף קבלה
ממיינים בירידה. אם top1.score < 0.40 → אין מועמד תקף.

Hysteresis & Sticky (יציבות, בלי ריצוד)

אם הפער בין מקום 1 ל־2 קטן מ־0.10 ⇒ נשארים עם התרגיל הקודם.

אם הפער ≥ 0.20 ואין freeze של חזרה ⇒ מחליפים.

confidence לא נקודתי — מחושב כ־EMA (α=0.25).

אם confidence_ema < 0.30 ל־>1.0s ⇒ מותר fallback.

Fallback חכם

אין מועמד תקף? אם יש בחירה קודמת יציבה — משאירים.

אחרת, נופלים ל־Bodyweight הבסיסי/none ומפיקים אינדיקציה.

פלט שקוף
מחזירים: exercise_id, confidence, reason, stability{kept_previous, margin, freeze_active}, רשימת candidates עם ציונים, ו־diagnostics (ל־Admin).

איפה זה יושב בתיקיות (מצומצם)
exercise_engine/
└─ classifier/
   ├─ classifier.py   # כל הלוגיקה בשלב ראשון (MVP)
   └─ schema.md       # תיאור קלט/פלט + ספים והסברים


בהמשך, אם תרצה: אפשר לפרק ל־matcher.py (חוקי ניקוד), hysteresis.py (ייצוב), equipment.py (ציוד).

ספי ברירת מחדל (שנשמרים בקובץ settings)

S_MIN_ACCEPT = 0.40 — סף קבלה למועמד.

H_MARGIN_KEEP = 0.10 — פער קטן → שומרים את הקודם.

H_MARGIN_SWITCH = 0.20 — פער גדול → מותר להחליף.

CONF_EMA_ALPHA = 0.25 — החלקת ביטחון (EMA).

LOW_CONF_EPS = 0.30 + LOW_CONF_T = 1.0s — נפילה מתמשכת.

FREEZE_DURING_REP = True — לא מחליפים בין bottom→top.

(תואם לעקרונות No-Flicker שקבענו קודם.)

מה יופיע בדו״ח (כדאי להציג)
"classifier": {
  "exercise_id": "squat.bodyweight",
  "confidence": 0.82,
  "reason": "kept_previous|best_match_rules|fallback_bodyweight",
  "stability": { "kept_previous": true, "margin": 0.06, "freeze_active": false }
}


וב־diagnostics:

classifier_kept_previous (info)

classifier_switched (info)

classifier_low_confidence (warn)

classifier_no_candidate (warn)

freeze_on_rep_window (info)

classifier_fallback_bodyweight (info)

צ’ק-ליסט בדיקות קצר

פער קטן (margin<0.10) → נשאר תרגיל קודם + classifier_kept_previous.

פער גדול (≥0.20) וללא freeze → מחליף תרגיל + classifier_switched.

ניתוק רגעי במדדים (<0.5s) → אין החלפה, confidence_ema לא נופל בחדות.

אין מועמד ≥0.40 → נשאר קודם או fallback ל־Bodyweight + classifier_no_candidate.

freeze בין bottom→top → אין החלפה גם אם הגיע top2 קרוב.