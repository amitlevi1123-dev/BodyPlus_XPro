# -*- coding: utf-8 -*-
# ===================================================================
# <family>.base.yaml — בסיס גנרי לכל המשפחות (Lower/Upper/Core)
# ===================================================================
# זרימה: Camera → Pose/ObjDet → Normalizer+Aliases → Canonical Payload
#                                 └→ Classifier (משפחה+ווריאנטים)
# עקרונות:
# • קובץ בסיס: selectable:false — לא נבחר ישירות; הווריאנטים יורשים.
# • מדדים קנוניים בלבד (ראה aliases.yaml).
# • אין Grade באותיות — רק ציון מספרי עם תקרות בטיחות (safety caps).
# • policy.missing=skip → קריטריון שאינו רלוונטי/חסר לא מפיל את כל הציון.
# • “hooks” למדיניות ייחודית למשפחה/וריאנט (top/lockout, rom_policy וכו’).
# ===================================================================

id: <family>.base               # דוגמה: squat.base / hinge.base / push.base
family: <family>                # דוגמה: squat / hinge / push / pull / lunge / core

meta:
  selectable: false
  display_name: "<Family> (Base)"
  notes: >
    בסיס גנרי לכל המשפחות. הווריאנטים יגדירו ציוד (equipment), זווית צפייה
    ו”מדיניות טופ“ (נעילה/מתח), וידרשו את מדדי ה-ROM הרלוונטיים (ברך/ירך/מרפק/כתף).

# ------------------------------------------------------------
# 🗣️ מרחב מסרים (כדי למנוע התנגשויות בין משפחות/ווריאנטים)
# ------------------------------------------------------------
phrases:
  namespace: "<family>.common"

# ------------------------------------------------------------
# 🎯 יעדי ROM ברירת מחדל (ניתן לדרוס בווריאנטים)
# ------------------------------------------------------------
targets:
  lower:
    from_floor:    { hip_deg: 60, torso_deg: 35 }   # hinge/דדליפט
    from_standing: { hip_deg: 48, torso_deg: 30 }   # RDL/SLDL
    squat_knee:    { knee_deg_target: 90 }          # עומק סקוואט טיפוסי
  upper:
    press:  { elbow_rom_deg: 70, shoulder_rom_deg: 45 }
    pull:   { elbow_rom_deg: 70, shoulder_rom_deg: 45 }

# ------------------------------------------------------------
# 🧪 קריטריונים גנריים — המנוע ידלג אוטומטית על לא-רלוונטיים
# ------------------------------------------------------------
criteria:
  # בטיחות עמוד־שדרה/גו (כל המשפחות)
  spine_rounding:     { requires: [spine_flexion_deg] }
  lateral_bend:       { requires: [spine_curvature_side_deg] }
  head_spine:         { requires: [head_pitch_deg, torso_forward_deg] }
  posture:            { requires: [torso_forward_deg] }

  # יישור וגיאומטריית גפיים תחתונות (Lower; יתעלם ב-Upper/Core)
  knee_valgus:        { requires: [knee_foot_alignment_left_deg, knee_foot_alignment_right_deg] }
  stance_width:       { requires: [features.stance_width_ratio] }
  toe_angle:          { requires: [toe_angle_left_deg, toe_angle_right_deg] }
  heel_contact:       { requires: [heel_lift_left, heel_lift_right] }
  foot_contact:       { requires: [foot_contact_left, foot_contact_right] }

  # ROM — שני מסלולים גנריים ל-Lower, ושניים ל-Upper
  depth_knee:         { requires: [knee_left_deg, knee_right_deg] }           # squat/lunge
  rom_joint_lower:    { requires: [hip_left_deg, hip_right_deg, torso_forward_deg] }  # hinge
  rom_joint_upper:    { requires: [elbow_left_deg, elbow_right_deg, shoulder_right_deg, shoulder_left_deg] } # push/pull

  # טמפו/פאזות (כולם)
  tempo:              { requires: [rep.timing_s] }
  phase_control:      { requires: [rep.ecc_s, rep.con_s, rep.pause_bottom_s, rep.pause_top_s] }
  turn_quality:       { requires: [rep.dir, rep.state, rep.phase] }

  # Hooks למדיניות ייחודית (יורחבו בווריאנטים)
  top_quality_hook:   { requires: [rep.pause_top_s, spine_flexion_deg, torso_forward_deg] }
  grip_width_hook:    { requires: [shoulders_width_px] }   # לשימוש עתידי ב-barbell/neutral

# ------------------------------------------------------------
# ⚠️ קריטיים — תנאי סף לניקוד חזרה (הווריאנט יוכל לדרוס)
# ------------------------------------------------------------
critical:
  # ברירת מחדל ניטרלית:
  - posture
  # אחד ממדדי ROM חייב להיות זמין (המערכת בוחרת אוטומטית לפי המשפחה/וריאנט):
  - any_of: [depth_knee, rom_joint_lower, rom_joint_upper]

# ------------------------------------------------------------
# ⚖️ SCORING — כללי ניקוד + תקרות בטיחות
# ------------------------------------------------------------
scoring:
  policy:
    missing: skip
    min_criteria_for_full_quality: 3

  criteria:

    # --- בטיחות (גבוה) ---
    spine_rounding:
      weight: 1.6
      rule: { kind: symmetric_threshold, input: spine_flexion_deg, ok: 10, warn: 20, bad: 30 }

    lateral_bend:
      weight: 1.2
      rule: { kind: symmetric_threshold, input: spine_curvature_side_deg, ok: 5, warn: 10, bad: 20 }

    head_spine:
      weight: 0.8
      rule: { kind: symmetric_threshold, input: "abs(head_pitch_deg - torso_forward_deg)", ok: 10, warn: 20, bad: 30 }

    # --- תבנית תחתון (ידולג ב-Upper/Core) ---
    knee_valgus:
      weight: 1.4
      rule: { kind: symmetric_threshold, input: "max(abs(knee_foot_alignment_left_deg),abs(knee_foot_alignment_right_deg))", ok: 5, warn: 10, bad: 20 }

    stance_width:
      weight: 0.5
      rule: { kind: band_center, input: features.stance_width_ratio, min_ok: 0.90, max_ok: 1.20, cutoff_min: 0.70, cutoff_max: 1.50 }

    toe_angle:
      weight: 0.4
      rule: { kind: symmetric_band_pair, input: "(toe_angle_left_deg,toe_angle_right_deg)", pair_ok_min: 5, pair_ok_max: 20, asymmetry_max: 10, cutoff_total_max: 40 }

    heel_contact:
      weight: 0.8
      rule: { kind: boolean_flag, input: "(heel_lift_left or heel_lift_right)", good_when: false, penalty: 0.30 }

    foot_contact:
      weight: 0.6
      rule: { kind: boolean_flag, input: "not (foot_contact_left and foot_contact_right)", good_when: false, penalty: 0.25 }

    # --- ROM Lower ---
    depth_knee:
      weight: 1.2
      rule: { kind: threshold_window, input: "min(knee_left_deg,knee_right_deg)", target_max: 90, cutoff_max: 150, direction: lower_is_better }

    rom_joint_lower:
      weight: 1.5
      rule: { kind: dual_angle_rom, hip: "(hip_left_deg,hip_right_deg)", torso: torso_forward_deg, target_hip_deg: 60, target_torso_deg: 35 }

    # --- ROM Upper ---
    rom_joint_upper:
      weight: 1.4
      rule: { kind: paired_rom, elbow_ok: 70, shoulder_ok: 45 }  # דוגמתי; הווריאנטים יעדכנו

    # --- טמפו ופאזות (כולם) ---
    tempo:
      weight: 0.6
      rule: { kind: tempo_window, input: rep.timing_s, min: 0.7, max: 2.5, cutoff_min: 0.4, cutoff_max: 4.0 }

    phase_control:
      weight: 1.0
      rule: { kind: phase_balance, ecc_min: 0.3, con_min: 0.2 }

    turn_quality:
      weight: 0.5
      rule: { kind: jerk_guard, allow_bounce: false }

    # --- Hooks (ימופו בווריאנטים) ---
    top_quality_hook:
      weight: 1.0
      rule: { kind: passthrough }

    grip_width_hook:
      weight: 0.4
      rule: { kind: passthrough }  # ימומש כשיתווסף מדד רוחב אחיזה אמיתי

  aggregate:
    method: weighted_mean
    weights_source: inline

  safety_caps:
    - { when: "spine_rounding <= 0.6", cap: 0.85 }
    - { when: "knee_valgus   <= 0.6", cap: 0.90 }
    - { when: "heel_contact  <= 0.5", cap: 0.90 }
    - { when: "head_spine    <= 0.5", cap: 0.90 }

# ------------------------------------------------------------
# 🧭 רמזים למסווג — בסיס דק; הווריאנטים ירחיבו
# ------------------------------------------------------------
match_hints:
  must_have: [pose.available]

# ------------------------------------------------------------
# 🔁 אות חזרה (Rep Signal) — angle-first עם Auto-Pick
# ------------------------------------------------------------
rep_signal:
  # מקור ברירת מחדל: זוויות; הווריאנט יכול לדרוס (למשל bar_y_px/hand_y אם מועיל)
  source: "angle|auto|min"
  # auto: עבור Lower → hip/knee; עבור Upper → elbow/shoulder; Core → torso
  candidates:
    lower:  ["hip_left_deg","hip_right_deg","knee_left_deg","knee_right_deg","torso_forward_deg"]
    upper:  ["elbow_left_deg","elbow_right_deg","shoulder_left_deg","shoulder_right_deg"]
    core:   ["torso_forward_deg","spine_flexion_deg"]
  thresholds:
    phase_delta: 5         # שינוי מינ’ כדי להתחיל פאזה
    min_turn_ms: 100       # השהיה מינ’ כדי לאשר turn
    min_rep_ms: 500
    max_rep_ms: 6000
    min_rom_good: 25       # דרישת ROM מינימלית ל-good
    min_rom_partial: 18    # מתחת ל-good אך נספר partial

# ------------------------------------------------------------
# 🔄 מקורות גיבוי לפאזות/ספירה אם אין זוויות יציבות
# ------------------------------------------------------------
fallback_sources:
  any_of: ["object_y","hands_center_y","hip_y_px"]

# ------------------------------------------------------------
# 📌 הערות מימוש
# • הווריאנט קובע: equipment, pose_view, start_mode, rom_policy, top_policy.
# • כל כלל כאן ניתן לדריסה בווריאנט (targets/weights/rules/thresholds).
# • שמור את ה-phrases בשם namespace ייחודי לווריאנט: <family>.<variant>.*
# ------------------------------------------------------------
