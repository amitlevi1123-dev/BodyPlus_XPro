# -*- coding: utf-8 -*-
# ===================================================================
# <family>.base.yaml â€” ×ª×‘× ×™×ª ×‘×¡×™×¡ ×’× ×¨×™×ª ×œ××©×¤×—×” ×—×“×©×” (×¢× ×”×¡×‘×¨×™×)
# ===================================================================
# ××™×š ×–×” ××©×ª×œ×‘ ×‘×–×¨×™××”?
# Camera â†’ Pose/ObjDet â†’ Normalizer+Aliases â†’ Canonical Payload â†’ Classifier
#                                         \â†’ (×§×‘×¦×™ YAML: ××©×¤×—×”+×•×•×¨×™×× ×˜×™×)
#
# â€¢ ×§×•×‘×¥ "×‘×¡×™×¡" ×œ××©×¤×—×”: ×œ× × ×‘×—×¨ ×‘××™××•×Ÿ (selectable:false). ×”×•×•×¨×™×× ×˜×™× ×™×•×¨×©×™×.
# â€¢ ×›×œ ×”××¤×ª×—×•×ª ×›××Ÿ ×”× ×§× ×•× ×™×™× ×œ×¤×™ aliases.yaml â€” ××œ ×ª×©× ×” ×©××•×ª, ×¨×§ ×”×•×¡×£/×”×¡×¨ ×§×¨×™×˜×¨×™×•× ×™×.
# â€¢ grading ×‘××•×ª×™×•×ª ×œ× ×‘×©×™××•×©. ×™×© ×¦×™×•×Ÿ ××¡×¤×¨×™ + ×ª×§×¨×•×ª ×‘×˜×™×—×•×ª (caps) ×‘×œ×‘×“.
# â€¢ policy.missing=skip ××‘×˜×™×— ×©×§×¨×™×˜×¨×™×•× ×™× ×©××™× × ×¨×œ×•×•× ×˜×™×™× ×¤×©×•×˜ ×™×“×•×œ×’×•.
#
# ×–×™×”×•×™ ×ª×¨×’×™×œ (×‘×’×“×•×œ):
# 1) ×”××¡×•×•×’ ××¡×™×§ ×¦×™×•×“ ××”Ö¾payload (objdet.*_present) ××• ×¢×¤×´×™ fallback ×ª× ×•×—×ª×™.
# 2) ××¡× ×Ÿ ××”×¡×¤×¨×™×™×” ×¨×§ ×ª×¨×’×™×œ×™× ×¢× meta.equipment ×ª×•××.
# 3) ×× ×§×“ ×›×œ ××•×¢××“ ×œ×¤×™ match_hints ×©×œ×• (must_have / must_not_have / any_of / ranges / pose_view).
# 4) ××—×œ×™×˜ ×‘×¦×•×¨×” ×™×¦×™×‘×” (hysteresis/freeze).
#
# ××™×¤×” ××’×“×™×¨×™× ××ª ×ª× ××™ ×”×–×™×”×•×™?
# â€¢ ×›××Ÿ (×‘×‘×¡×™×¡) ×¨×§ ×”××™× ×™××•×. ××ª ×”×›×œ×œ×™× ×”×¡×¤×¦×™×¤×™×™× (must_have/must_not/equipment/pose_view)
#   ×¨×•×©××™× ×‘×•×•×¨×™×× ×˜×™× (×œ××©×œ: bodyweight/dumbbell/barbell). ×”×‘×¡×™×¡ × ×©××¨ ×’× ×¨×™.
# ===================================================================

# ××–×”×” ×‘×¡×™×¡ + ×©× ××©×¤×—×”
id: <family>.base                 # ×“×•×’××”: squat.base / hinge.base / push.base
family: <family>                  # ×“×•×’××”: squat

meta:
  selectable: false               # ×§×•×‘×¥ ×‘×¡×™×¡: ×œ× × ×™×ª×Ÿ ×œ×‘×—×™×¨×” ×™×©×™×¨×”
  display_name: "<Family> (Base)" # ×©× ×ª×¦×•×’×” ×›×œ×œ×™; ×”×•×•×¨×™×× ×˜×™× ×™×—×œ×™×¤×•

# -------------------------------------------------------------------
# ğŸ§  ×§×¨×™×˜×¨×™×•× ×™× (××” ××•×“×“×™×) â€” ×’× ×¨×™ ×œ×›×œ ×”××©×¤×—×•×ª
# -------------------------------------------------------------------
# ×˜×™×¤: ×× ×œ××©×¤×—×” ××™×Ÿ ××“×“ ××¡×•×™× (×œ××©×œ toe_angle ×‘×¤×•×©-××¤), ×œ× × ×•×¨× â€” ×”×× ×•×¢ ×™×“×œ×’ (missing: skip).
criteria:
  # ×‘×˜×™×—×•×ª ×¢××•×“-×©×“×¨×”/×’×•
  spine_rounding: { requires: [spine_flexion_deg] }              # ×›×™×¤×•×£/×¢×’×™×œ×ª ×’×‘ (×¡×’×™×˜×œ×™)
  lateral_bend:   { requires: [spine_curvature_side_deg] }       # ×¢×™×§×•× ×¦×“×“×™ (×¤×¨×•× ×˜×œ×™)
  posture:        { requires: [torso_forward_deg] }              # ×”×˜×™×™×ª ×’×• ××•×œ ×× ×›×™
  head_spine:     { requires: [head_pitch_deg, torso_forward_deg] }  # ×¨××© ×‘×§×• ×”×’×•

  # ×‘×¨×›×™×™×/×›×¤×•×ª-×¨×’×œ×™×™× (×¨×œ×•×•× ×˜×™ ×œ-Lower; ×™×“×•×œ×’ ×‘-Upper)
  knee_valgus:    { requires: [knee_foot_alignment_left_deg, knee_foot_alignment_right_deg] }
  stance_width:   { requires: [features.stance_width_ratio] }
  toe_angle:      { requires: [toe_angle_left_deg, toe_angle_right_deg] }
  heel_contact:   { requires: [heel_lift_left, heel_lift_right] }
  foot_contact:   { requires: [foot_contact_left, foot_contact_right] }

  # ×¢×•××§/ROM (×”×ª×××” ×‘×•×•×¨×™×× ×˜×™×: ×‘×¨×š/×™×¨×š/××¨×¤×§)
  depth:          { requires: [knee_left_deg, knee_right_deg] }  # ×‘×¨×™×¨×ª-××—×“×œ ×œ-Lower

  # ×˜××¤×•/×§×¦×‘
  tempo:          { requires: [rep.timing_s] }

# -------------------------------------------------------------------
# âš ï¸ ×§×¨×™×˜×™×™× â€” ×× ×—×¡×¨ ××—×“ ××”×, ×œ× × ×™×ª×Ÿ ×œ× ×§×“ (Unscored)
# -------------------------------------------------------------------
# ××¤×©×¨ ×œ×”×ª××™× ×‘×•×•×¨×™×× ×˜×™×: ×œ××©×œ ×‘-Upper ×œ×”×¤×•×š depth ×œ×§×¨×™×˜×™ ×¢× ××¨×¤×§/×›×ª×£.
critical: [posture, depth]

# -------------------------------------------------------------------
# âš–ï¸ SCORING â€” ××“×™× ×™×•×ª + ×›×œ×œ×™ × ×™×§×•×“ ×œ×›×œ ×§×¨×™×˜×¨×™×•×Ÿ
# -------------------------------------------------------------------
scoring:

  # ××“×™× ×™×•×ª ×›×œ×œ×™×ª
  policy:
    missing: skip                    # ×§×¨×™×˜×¨×™×•×Ÿ ×—×¡×¨ ×©××™× ×• ×§×¨×™×˜×™ â†’ ××“×œ×’×™× ×¢×œ×™×• ×‘×©×§×œ×•×œ
    min_criteria_for_full_quality: 3 # <3 ×§×¨×™×˜×¨×™×•× ×™× ×–××™× ×™× â†’ × ×¨×©××ª ××™×›×•×ª ×—×œ×§×™×ª (×œ×•×’/×“×•×—)

  # ×©×•×¤×˜×™× ×œ×¤×™ ×§×¨×™×˜×¨×™×•× ×™×
  criteria:

    # --- ×‘×˜×™×—×•×ª (××©×§×œ ×’×‘×•×”) ---
    spine_rounding:
      weight: 1.6
      rule:
        kind: symmetric_threshold
        input: spine_flexion_deg     # ×›×™×¤×•×£/×¢×’×™×œ×”: ×§×˜×Ÿ=×˜×•×‘
        ok:   10                     # â‰¤10Â° â†’ ×˜×•×‘
        warn: 20                     # 10â€“20Â° â†’ ×‘×™× ×•× ×™
        bad:  30                     # â‰¥30Â° â†’ ×’×¨×•×¢ (0)

    lateral_bend:
      weight: 1.2
      rule:
        kind: symmetric_threshold
        input: spine_curvature_side_deg
        ok:   5
        warn: 10
        bad:  20

    knee_valgus:
      weight: 1.4
      rule:
        kind: symmetric_threshold
        input: max(abs(knee_foot_alignment_left_deg), abs(knee_foot_alignment_right_deg))
        ok:   5                      # |×¡×˜×™×™×”| â‰¤5Â° â†’ ×˜×•×‘
        warn: 10
        bad:  20

    heel_contact:
      weight: 0.8
      rule:
        kind: boolean_flag           # ×“×’×œ ×‘×•×œ×™×× ×™: trueâ†’×¢× ×™×©×” ×§×œ×”, falseâ†’×˜×•×‘
        input: (heel_lift_left or heel_lift_right)
        good_when: false             # ×× ×—× ×• ×¨×•×¦×™× ×©×”×“×’×œ ×œ× ×™×“×œ×•×§ (××™×Ÿ ×”×¨××ª ×¢×§×‘)
        penalty: 0.30                # ×”×•×¨×“×ª ×¦×™×•×Ÿ ×”×§×¨×™×˜×¨×™×•×Ÿ ×›×©×”×“×’×œ true

    foot_contact:
      weight: 0.6
      rule:
        kind: boolean_flag
        input: not (foot_contact_left and foot_contact_right)
        good_when: false             # ×˜×•×‘ ×›×©×™×© ××’×¢ ××œ× (×•×œ×›×Ÿ ×”×‘×™×˜×•×™ ×¦×¨×™×š ×œ×”×™×•×ª false)
        penalty: 0.25

    # --- ×˜×›× ×™×§×”/×‘×™×¦×•×¢ ---
    posture:
      weight: 1.0
      rule:
        kind: linear_band
        input: torso_forward_deg
        good_max: 15                 # â‰¤15Â° â†’ 1.0
        ok_max:   25                 # 15â€“25Â° â†’ ×©×œ×‘ ×‘×™× ×™×™×
        bad_max:  45                 # â‰¥45Â° â†’ 0.0

    head_spine:
      weight: 0.8
      rule:
        kind: symmetric_threshold
        input: abs(head_pitch_deg - torso_forward_deg)  # ×¨××© ×‘×§×• ×¢× ×”×’×•
        ok:   10
        warn: 20
        bad:  30

    depth:
      weight: 1.2
      rule:
        kind: threshold_window
        input: min(knee_left_deg, knee_right_deg)
        # × ××•×š=×¢××•×§=×˜×•×‘ ×¢×“ 90Â° (×¦×™×•×Ÿ ××œ×); ××¢×‘×¨ ×œ-90Â° ×œ× ××•×¡×™×£ ×¢×•×“ × ×™×§×•×“:
        target_max:  90
        cutoff_max: 150              # â‰¥150Â° â†’ 0
        direction: lower_is_better

    tempo:
      weight: 0.6
      rule:
        kind: tempo_window
        input: rep.timing_s
        min: 0.7
        max: 2.5
        cutoff_min: 0.4
        cutoff_max: 4.0

    stance_width:
      weight: 0.5
      rule:
        kind: band_center
        input: features.stance_width_ratio
        min_ok: 0.90
        max_ok: 1.20
        cutoff_min: 0.70
        cutoff_max: 1.50

    toe_angle:
      weight: 0.4
      rule:
        kind: symmetric_band_pair
        input: (toe_angle_left_deg, toe_angle_right_deg)
        pair_ok_min: 5               # 5â€“20Â° ×œ×›×œ ×¨×’×œ â†’ "×¤×™×©×•×Ÿ ××ª×•×Ÿ" ×¨×¦×•×™
        pair_ok_max: 20
        asymmetry_max: 10            # ×¢×“ 10Â° ×”×‘×“×œ ×‘×™×Ÿ ×”×¦×“×“×™× × ×¡×‘×œ
        cutoff_total_max: 40

  # ×©×§×œ×•×œ ×œ×¦×™×•×Ÿ ×¡×•×¤×™ (×××•×¦×¢ ××©×•×§×œ×œ ×©×œ ×”×§×¨×™×˜×¨×™×•× ×™× ×”×–××™× ×™×)
  aggregate:
    method: weighted_mean
    weights_source: inline

  # ×ª×§×¨×•×ª ×‘×˜×™×—×•×ª (××’×‘×™×œ×•×ª ×¦×™×•×Ÿ ×¡×•×¤×™ ×›×©×‘×˜×™×—×•×ª × ××•×›×” â€” ×œ× ××•×—×§×•×ª ×”×™×©×’×™× ××—×¨×™×)
  safety_caps:
    - when: "spine_rounding <= 0.6" # ×’×‘ ××¢×•×’×œ ×‘×¦×•×¨×” ××•×¨×’×©×ª
      cap: 0.85
    - when: "knee_valgus   <= 0.6"  # ×§×¨×™×¡×ª ×‘×¨×›×™×™× ××•×¨×’×©×ª
      cap: 0.90
    - when: "heel_contact  <= 0.5"  # ×¢×§×‘×™× ×¢×•×œ×™× ×œ×¢×™×ª×™× ×ª×›×•×¤×•×ª
      cap: 0.90

# -------------------------------------------------------------------
# ğŸ§­ ×¨××–×™× ×œ××¡×•×•×’ â€” ×‘×¡×™×¡ ×‘×œ×‘×“ (×•×•×¨×™×× ×˜×™× ×™×¨×—×™×‘×•)
# -------------------------------------------------------------------
match_hints:
  must_have: [pose.available]
  # ×‘×•×•×¨×™×× ×˜×™× (exercise YAML) ×ª×’×“×™×¨:
  #   meta.equipment: "none" | "dumbbell" | "barbell" | "kettlebell"
  #   must_have:     [objdet.<equip>_present] ×›×©×™×© ×¦×™×•×“
  #   must_not_have: [objdet.<other>_present] ×œ×¤×¡×™×œ×” ××”×™×¨×”
  #   pose_view:     ["front","front_left","front_right"] (××• ×–×•×•×™×ª ××—×¨×ª)
  #   any_of:        [<signals...>] ×× ×™×© ×“×’×œ×™× ×—×œ×•×¤×™×™× ×©××¡×¤×™×§ ××—×“ ××”×
  #   ranges:        { key: [lo,hi], ... } ×œ××¤×™×•× ×™× ×§×™× ××˜×™×™× ×“×§×™×
  #   weight:        1.0 (×—×™×–×•×§/×”×—×œ×©×” ×©×œ ××•×¢××“ ×‘×ª×•×š ××•×ª×” ×—×‘×•×¨×”)

# -------------------------------------------------------------------
# ğŸ” ××™×ª×•×ª ×—×–×¨×•×ª â€” ×‘×¨×™×¨×ª ××—×“×œ (× ×™×ª×Ÿ ×œ×”×—×œ×™×£ ×‘×•×•×¨×™×× ×˜)
# -------------------------------------------------------------------
rep_signal:
  source: "value|min|wrist_left_y_px,wrist_right_y_px"  # ×¢×•×’× ×™ ×™×“×™×™× × ×•×—×™× ×œ×¡×¤×™×¨×”
  thresholds:
    min_rom_good: 30            # ××™× ×™××•× ROM ×›×“×™ ×œ×”×™×—×©×‘ ×—×–×¨×”
    min_rep_ms: 400             # ×§×¦×¨ ××“×™ â†’ ×¤×¡×™×œ×”
    max_rep_ms: 6000            # ××¨×•×š ××“×™ â†’ ×¤×¡×™×œ×”

# -------------------------------------------------------------------
# âŒ ××™×Ÿ grade_bands â€” ×œ× ××©×ª××©×™× ×‘-A/B/C
# -------------------------------------------------------------------

# ===================================================================
# ğŸ“Œ ×”×¡×‘×¨ ×§×¦×¨ ×¢×œ ×–×™×”×•×™ ×ª×¨×’×™×œ (××” ×§×•×¨×” ×‘×–××Ÿ ×¨×™×¦×”) â€” ×œ×¢×™×•×Ÿ ××”×™×¨
# ===================================================================
# â€¢ ×”-Normalizer+Aliases ××—×–×™×¨ payload ×§× ×•× ×™ (××¤×ª×—×•×ª ×›××•: pose.available, knee_left_deg, objdet.dumbbell_present).
# â€¢ ×”××¡×•×•×’:
#   1) ××¡×™×§ ×¦×™×•×“: ×× objdet.bar_present â†’ "barbell"; ×× objdet.dumbbell_present â†’ "dumbbell"; ××—×¨×ª "none"
#      (×•×™×© ×’× fallback ×ª× ×•×—×ª×™ ×œ××•×˜ ×× ×”×•×’×“×¨ ×‘×”×’×“×¨×•×ª ×”×× ×•×¢).
#   2) ××¡× ×Ÿ ×¡×¤×¨×™×™×”: × ×©××¨×™× ×¨×§ ×ª×¨×’×™×œ×™× ×¢× meta.equipment ×ª×•×× (selectable:true).
#   3) ×× ×§×“ ×›×œ ××•×¢××“: must_have/not/any_of/ranges/pose_view â†’ ×¦×™×•×Ÿ 0..1 (×¢× weight).
#   4) ××—×œ×™×˜ ×™×¦×™×‘ ×¢× hysteresis/freeze: ××¨×•×•×—×™× ×œ×©××™×¨×ª ×ª×¨×’×™×œ ×§×•×“×/×”×—×œ×¤×” ×•×“××™×ª.
#
# â€¢ ××™×¤×” ×›×•×ª×‘×™× ××ª "××™ ×–×” ×”×ª×¨×’×™×œ ×”×–×”"? â€” ×‘×§×•×‘×¥ ×”×•×•×¨×™×× ×˜:
#   meta.equipment + match_hints (×›×•×œ×œ must_not_have/pose_view/ranges).
#   ×”×‘×¡×™×¡ ×›××Ÿ × ×©××¨ ×›×œ×œ×™ ×•××“×’×™×© ××ª ×›×œ×œ×™ ×”×¦×™×•×Ÿ/×‘×˜×™×—×•×ª.
