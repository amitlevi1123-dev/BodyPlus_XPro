# -*- coding: utf-8 -*-
# ===================================================================
# squat.base.yaml â€” ××©×¤×—×ª ×¡×§×•×•××˜ (Base)
# ===================================================================
# ğŸ§  ××˜×¨×ª ×”×§×•×‘×¥:
#  ×§×•×‘×¥ ×‘×¡×™×¡ ×©××’×“×™×¨ ××ª ×›×œ×œ×™ ×”×¦×™×•×Ÿ ×•×”×‘×˜×™×—×•×ª ×©×œ ××©×¤×—×ª ×”Ö¾Squat.
#  ×”×•× ×œ× × ×‘×—×¨ ×™×©×™×¨×•×ª ×‘××™××•×Ÿ (selectable:false) â€” ××œ× ××©××© ×‘×¡×™×¡
#  ×©×›×œ ×”×•×¨×™×× ×˜×™× (Bodyweight / Dumbbell / Barbell) ×™×•×¨×©×™× ××× ×•.
#
# ğŸ“¡ ×–×¨×™××ª ×–×™×”×•×™:
#  1) ObjDet ××–×”×” ×¦×™×•×“ (barbell/dumbbell/kettlebell/none)
#  2) ×”××¡×•×•×’ ×‘×•×—×¨ ××ª ×”×•×¨×™×× ×˜ ×”× ×›×•×Ÿ ×œ×¤×™ match_hints
#  3) ×§×•×‘×¥ base ××¡×¤×§ ××ª ×—×•×§×™ ×”× ×™×§×•×“ ×”××©×•×ª×¤×™× ×œ×›×•×œ×
#
# ğŸ’¡ ×—×©×•×‘:
#  â€¢ ×›×œ ×”××¤×ª×—×•×ª ×›××Ÿ ×—×™×™×‘×™× ×œ×”×™×•×ª ×§× ×•× ×™×™× ×œ×¤×™ aliases.yaml.
#  â€¢ policy.missing=skip ××•× ×¢ ×¢× ×™×©×” ×¢×œ × ×ª×•× ×™× ×©×—×¡×¨×™× ×‘×ª×¨×’×™×œ×™× ×©××™× × ×¨×œ×•×•× ×˜×™×™×.
# ===================================================================

id: squat.base
family: squat

meta:
  selectable: false
  display_name: "Squat (Base)"

# -------------------------------------------------------------------
# ğŸ§© ×§×¨×™×˜×¨×™×•× ×™× â€” ××™×œ×• × ×ª×•× ×™× ×“×¨×•×©×™× ×œ×›×œ ××“×“
# -------------------------------------------------------------------
criteria:
  # --- ×‘×˜×™×—×•×ª ---
  spine_rounding:      { requires: [spine_flexion_deg] }                                  # ×¢×’×™×œ×ª ×’×‘
  knee_valgus:         { requires: [knee_foot_alignment_left_deg, knee_foot_alignment_right_deg] }  # ×§×¨×™×¡×ª ×‘×¨×›×™×™×
  spine_sidebend:      { requires: [spine_curvature_side_deg] }                           # ×¢×™×§×•× ×¦×“×“×™

  # --- ×˜×›× ×™×§×” ---
  depth:               { requires: [knee_left_deg, knee_right_deg] }                      # ×¢×•××§ ×¡×§×•×•××˜
  stance_width:        { requires: [features.stance_width_ratio] }                        # ×¨×•×—×‘ ×¢××™×“×”
  foot_angle:          { requires: [toe_angle_left_deg, toe_angle_right_deg] }            # ×–×•×•×™×ª ×›×¤×•×ª ×¨×’×œ×™×™×
  head_alignment:      { requires: [head_pitch_deg, spine_flexion_deg] }                  # ×¨××© ×‘×§×• ×”×’×‘
  heels_grounded:      { requires: [heel_lift_left, heel_lift_right] }                    # ×¢×§×‘×™× ×¢×œ ×”×§×¨×§×¢
  tempo:               { requires: [rep.timing_s] }                                       # ××”×™×¨×•×ª ×—×–×¨×”

  # --- ××™×“×¢ × ×•×¡×£ (×¤×™×“×‘×§ ×‘×œ×‘×“) ---
  posture:             { requires: [torso_forward_deg] }                                  # ×–×•×•×™×ª ×’×• ×›×œ×œ×™×ª
  dorsiflexion:        { requires: [ankle_dorsi_left_deg, ankle_dorsi_right_deg] }        # ×ª× ×•×¢×ª ×§×¨×¡×•×œ

# ×§×¨×™×˜×¨×™×•× ×™× ×§×¨×™×˜×™×™× â€” ×‘×œ×¢×“×™×”× ×œ× × ×™×ª×Ÿ ×œ× ×§×“ ×ª×¨×’×™×œ
critical: [spine_rounding, knee_valgus, depth]

# -------------------------------------------------------------------
# âš–ï¸ ×‘×œ×•×§ ×”× ×™×§×•×“ (scoring)
# -------------------------------------------------------------------
scoring:

  policy:
    missing: skip                         # ××“×“ ×—×¡×¨ ×©××™× ×• ×§×¨×™×˜×™ â†’ ××“×œ×’×™× ×¢×œ×™×•
    min_criteria_for_full_quality: 3       # ×¤×—×•×ª ×Ö¾3 ×§×¨×™×˜×¨×™×•× ×™× ×–××™× ×™× â†’ ××™×›×•×ª ×—×œ×§×™×ª

  criteria:

    # --- ×‘×˜×™×—×•×ª ---
    spine_rounding:
      weight: 2.0
      rule:
        kind: linear_band
        input: spine_flexion_deg
        good_max: 10
        ok_max: 20
        bad_max: 35

    knee_valgus:
      weight: 2.0
      rule:
        kind: symmetric_threshold
        input: "max(abs(knee_foot_alignment_left_deg), abs(knee_foot_alignment_right_deg))"
        ok: 5
        warn: 10
        bad: 20

    spine_sidebend:
      weight: 1.5
      rule:
        kind: symmetric_threshold
        input: "abs(spine_curvature_side_deg)"
        ok: 5
        warn: 10
        bad: 20

    # --- ×˜×›× ×™×§×” ---
    depth:
      weight: 1.2
      rule:
        kind: threshold_window
        input: "min(knee_left_deg, knee_right_deg)"
        target_max: 90       # â‰¤90Â° â†’ ×¢×•××§ ×˜×•×‘
        cutoff_max: 150      # â‰¥150Â° â†’ ×’×¨×•×¢
        direction: lower_is_better

    stance_width:
      weight: 0.8
      rule:
        kind: band_center
        input: features.stance_width_ratio
        min_ok: 0.9
        max_ok: 1.2
        cutoff_min: 0.7
        cutoff_max: 1.5

    foot_angle:
      weight: 0.8
      rule:
        kind: band_center
        input: "mean(abs(toe_angle_left_deg), abs(toe_angle_right_deg))"
        min_ok: 8
        max_ok: 20
        cutoff_min: 0
        cutoff_max: 30

    head_alignment:
      weight: 0.8
      rule:
        kind: symmetric_threshold
        input: "abs(head_pitch_deg - spine_flexion_deg)"
        ok: 10
        warn: 20
        bad: 30

    heels_grounded:
      weight: 0.6
      rule:
        kind: boolean_flag
        input: "(heel_lift_left or heel_lift_right)"   # True ×× ×™×© ×”×¨××ª ×¢×§×‘
        good_when: false                               # ×× ×—× ×• ×¨×•×¦×™× False â†’ ×¢×§×‘×™× × ×¢×•×¦×™×
        penalty: 0.4                                   # ×× True â†’ ××•×¨×™×“ ×¦×™×•×Ÿ ×‘Ö¾40%

    tempo:
      weight: 0.5
      rule:
        kind: tempo_window
        input: rep.timing_s
        min: 0.7
        max: 2.5
        cutoff_min: 0.4
        cutoff_max: 4.0

    dorsiflexion:
      weight: 0.0    # ×¤×™×“×‘×§ ×‘×œ×‘×“, ×œ× ××©×¤×™×¢ ×¢×œ ×¦×™×•×Ÿ
      rule:
        kind: threshold_window
        input: "min(ankle_dorsi_left_deg, ankle_dorsi_right_deg)"
        target_min: 25
        cutoff_min: 15
        direction: higher_is_better

  aggregate:
    method: weighted_mean
    weights_source: inline

  safety_caps:
    - { when: "spine_rounding <= 0.6", cap: 0.70 }
    - { when: "knee_valgus   <= 0.6", cap: 0.75 }
    - { when: "spine_sidebend<= 0.6", cap: 0.80 }

# -------------------------------------------------------------------
# ğŸ§­ ×¨××–×™× ×œ××¡×•×•×’ (×”××¡×™×™×¢×™× ×œ×–×”×•×ª "×¡×§×•×•××˜")
# -------------------------------------------------------------------
match_hints:
  must_have: [pose.available]
  pose_view: ["front", "front_left", "front_right"]
  motion_pattern: ["hip_down", "knee_flexion"]
  joints_focus: ["hips", "knees", "spine"]

# ×”×¢×¨×”: ×”×•×¨×™×× ×˜×™× (bodyweight/dumbbell/barbell)
# ×™×•×¡×™×¤×• ×›××Ÿ ×’× ×¦×™×•×“:
#   must_have: [objdet.bar_present]  ××•  [objdet.dumbbell_present]
#   must_not_have: [objdet.kettlebell_present]
#   meta.equipment: "barbell" / "dumbbell" / "none"

# -------------------------------------------------------------------
# ğŸ” ×¡×¤×™×¨×ª ×—×–×¨×•×ª â€” ×‘×¡×™×¡ ××©×¤×—×ª×™
# -------------------------------------------------------------------
rep_signal:
  source: "value|min|hip_y_px"   # ××‘×•×¡×¡ ×¢×œ ×ª× ×•×¢×ª ×”××’×Ÿ
  thresholds:
    min_rom_good: 60
    min_rep_ms: 500
    max_rep_ms: 7000
