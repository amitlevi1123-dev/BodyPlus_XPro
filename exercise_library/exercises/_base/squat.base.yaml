# -*- coding: utf-8 -*-
# ===================================================================
# squat.base.yaml — משפחת סקוואט (Base)
# ===================================================================
# 🧠 מטרת הקובץ:
#  קובץ בסיס שמגדיר את כללי הציון והבטיחות של משפחת ה־Squat.
#  הוא לא נבחר ישירות באימון (selectable:false) — אלא משמש בסיס
#  שכל הוריאנטים (Bodyweight / Dumbbell / Barbell) יורשים ממנו.
#
# 📡 זרימת זיהוי:
#  1) ObjDet מזהה ציוד (barbell/dumbbell/kettlebell/none)
#  2) המסווג בוחר את הוריאנט הנכון לפי match_hints
#  3) קובץ base מספק את חוקי הניקוד המשותפים לכולם
#
# 💡 חשוב:
#  • כל המפתחות כאן חייבים להיות קנוניים לפי aliases.yaml.
#  • policy.missing=skip מונע ענישה על נתונים שחסרים בתרגילים שאינם רלוונטיים.
# ===================================================================

id: squat.base
family: squat

meta:
  selectable: false
  display_name: "Squat (Base)"

# -------------------------------------------------------------------
# 🧩 קריטריונים — אילו נתונים דרושים לכל מדד
# -------------------------------------------------------------------
criteria:
  # --- בטיחות ---
  spine_rounding:      { requires: [spine_flexion_deg] }                                  # עגילת גב
  knee_valgus:         { requires: [knee_foot_alignment_left_deg, knee_foot_alignment_right_deg] }  # קריסת ברכיים
  spine_sidebend:      { requires: [spine_curvature_side_deg] }                           # עיקום צדדי

  # --- טכניקה ---
  depth:               { requires: [knee_left_deg, knee_right_deg] }                      # עומק סקוואט
  stance_width:        { requires: [features.stance_width_ratio] }                        # רוחב עמידה
  foot_angle:          { requires: [toe_angle_left_deg, toe_angle_right_deg] }            # זווית כפות רגליים
  head_alignment:      { requires: [head_pitch_deg, spine_flexion_deg] }                  # ראש בקו הגב
  heels_grounded:      { requires: [heel_lift_left, heel_lift_right] }                    # עקבים על הקרקע
  tempo:               { requires: [rep.timing_s] }                                       # מהירות חזרה

  # --- מידע נוסף (פידבק בלבד) ---
  posture:             { requires: [torso_forward_deg] }                                  # זווית גו כללית
  dorsiflexion:        { requires: [ankle_dorsi_left_deg, ankle_dorsi_right_deg] }        # תנועת קרסול

# קריטריונים קריטיים — בלעדיהם לא ניתן לנקד תרגיל
critical: [spine_rounding, knee_valgus, depth]

# -------------------------------------------------------------------
# ⚖️ בלוק הניקוד (scoring)
# -------------------------------------------------------------------
scoring:

  policy:
    missing: skip                         # מדד חסר שאינו קריטי → מדלגים עליו
    min_criteria_for_full_quality: 3       # פחות מ־3 קריטריונים זמינים → איכות חלקית

  criteria:

    # --- בטיחות ---
    spine_rounding:
      weight: 2.0
      rule:
        kind: linear_band
        input: spine_flexion_deg
        good_max: 10
        ok_max: 20
        bad_max: 35

    knee_valgus:
      weight: 2.0
      rule:
        kind: symmetric_threshold
        input: "max(abs(knee_foot_alignment_left_deg), abs(knee_foot_alignment_right_deg))"
        ok: 5
        warn: 10
        bad: 20

    spine_sidebend:
      weight: 1.5
      rule:
        kind: symmetric_threshold
        input: "abs(spine_curvature_side_deg)"
        ok: 5
        warn: 10
        bad: 20

    # --- טכניקה ---
    depth:
      weight: 1.2
      rule:
        kind: threshold_window
        input: "min(knee_left_deg, knee_right_deg)"
        target_max: 90       # ≤90° → עומק טוב
        cutoff_max: 150      # ≥150° → גרוע
        direction: lower_is_better

    stance_width:
      weight: 0.8
      rule:
        kind: band_center
        input: features.stance_width_ratio
        min_ok: 0.9
        max_ok: 1.2
        cutoff_min: 0.7
        cutoff_max: 1.5

    foot_angle:
      weight: 0.8
      rule:
        kind: band_center
        input: "mean(abs(toe_angle_left_deg), abs(toe_angle_right_deg))"
        min_ok: 8
        max_ok: 20
        cutoff_min: 0
        cutoff_max: 30

    head_alignment:
      weight: 0.8
      rule:
        kind: symmetric_threshold
        input: "abs(head_pitch_deg - spine_flexion_deg)"
        ok: 10
        warn: 20
        bad: 30

    heels_grounded:
      weight: 0.6
      rule:
        kind: boolean_flag
        input: "(heel_lift_left or heel_lift_right)"   # True אם יש הרמת עקב
        good_when: false                               # אנחנו רוצים False → עקבים נעוצים
        penalty: 0.4                                   # אם True → מוריד ציון ב־40%

    tempo:
      weight: 0.5
      rule:
        kind: tempo_window
        input: rep.timing_s
        min: 0.7
        max: 2.5
        cutoff_min: 0.4
        cutoff_max: 4.0

    dorsiflexion:
      weight: 0.0    # פידבק בלבד, לא משפיע על ציון
      rule:
        kind: threshold_window
        input: "min(ankle_dorsi_left_deg, ankle_dorsi_right_deg)"
        target_min: 25
        cutoff_min: 15
        direction: higher_is_better

  aggregate:
    method: weighted_mean
    weights_source: inline

  safety_caps:
    - { when: "spine_rounding <= 0.6", cap: 0.70 }
    - { when: "knee_valgus   <= 0.6", cap: 0.75 }
    - { when: "spine_sidebend<= 0.6", cap: 0.80 }

# -------------------------------------------------------------------
# 🧭 רמזים למסווג (המסייעים לזהות "סקוואט")
# -------------------------------------------------------------------
match_hints:
  must_have: [pose.available]
  pose_view: ["front", "front_left", "front_right"]
  motion_pattern: ["hip_down", "knee_flexion"]
  joints_focus: ["hips", "knees", "spine"]

# הערה: הוריאנטים (bodyweight/dumbbell/barbell)
# יוסיפו כאן גם ציוד:
#   must_have: [objdet.bar_present]  או  [objdet.dumbbell_present]
#   must_not_have: [objdet.kettlebell_present]
#   meta.equipment: "barbell" / "dumbbell" / "none"

# -------------------------------------------------------------------
# 🔁 ספירת חזרות — בסיס משפחתי
# -------------------------------------------------------------------
rep_signal:
  source: "value|min|hip_y_px"   # מבוסס על תנועת האגן
  thresholds:
    min_rom_good: 60
    min_rep_ms: 500
    max_rep_ms: 7000
