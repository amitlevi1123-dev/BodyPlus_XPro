# =============================================================================
# 🧠 hinge.base.yaml — משפחת תנועות Hinge / Deadlift
# -----------------------------------------------------------------------------
# מטרת המשפחה: למדוד תנועה מבוססת Hinge — דדליפטים, RDL, סטיף-לג, טרפ-בר וכו’.
#
# עקרונות:
# - ROM זוויתי לפי ירך+גו (חסין מרחק/זום; לא מסתמך על פיקסלים)
# - זיהוי פאזות ע"י torso_forward_deg + hip_*_deg; object_y רק כגיבוי
# - ניקוד בטיחות/תבנית/שליטה/עמידה; Top (נעילה/מתח) יוגדר בווריאנטים
# - כל המפתחות קנוניים לפי aliases.yaml
# =============================================================================

meta:
  id: "hinge.base"
  family: "hinge"
  display_name: "תנועת Hinge (בסיס משפחה)"
  selectable: false
  version: 1.0.0
  notes: >
    הווריאנטים (דדליפט רגיל, RDL, סטיף-לג, טרפ-בר, KB/DB, משקל-גוף) יורשים מהבסיס
    ומשנים בעיקר את start_mode/targets ומדיניות ה-Top (נעילה/מתח).

# =============================================================================
# 🧭 רמזים למסווג — בסיס (ווריאנטים ירחיבו לפי ציוד)
# =============================================================================
match_hints:
  must_have: [pose.available]
  pose_view: ["side", "front_left", "front_right"]
  motion_pattern: ["hip_hinge"]
  joints_focus: ["hips", "spine", "knees"]

# =============================================================================
# 🧾 הגדרות כלליות / יעדי ROM ברירת-מחדל (ווריאנטים רשאים לדרוס)
# =============================================================================
defaults:
  lockout_mode: "inherit"   # יוגדר בווריאנט: "full_lockout" / "tension_top"
  targets:
    from_floor:    { hip_deg: 60, torso_deg: 35 }
    from_standing: { hip_deg: 48, torso_deg: 30 }

# =============================================================================
# 🧩 קריטריונים (מה מודדים)
# =============================================================================
criteria:

  # ----- קריטיים (בלעדיהם אין ניקוד חזרה) -----
  critical:
    - pose.available
    - spine_flexion_deg
    - torso_forward_deg
    - hip_left_deg
    - hip_right_deg

  # ----- מקורות עזר לפאזות/ספירה (לא חובה; לפחות אחד) -----
  fallback_sources:
    - object_y
    - hands_center_y
    - hip_y_px

  # ----- תבנית Hinge -----
  hinge_posture:
    requires: [torso_forward_deg, knee_left_deg, knee_right_deg]
    # הגיון: הינג' תקין = הטיית גו משמעותית מול כפיפת ברך מתונה (לא להפוך לסקוואט)

  knee_flex_limit:
    requires: [knee_left_deg, knee_right_deg]
    # יעד טיפוסי ~100–115° (דריסה בווריאנט/בקוד הניקוד)

  # ----- ROM זוויתי (שמרני) -----
  rom_joint:
    requires: [hip_left_deg, hip_right_deg, torso_forward_deg]
    # חישוב בקוד: min( hip_rom/target_hip , torso_rom/target_torso )

  # ----- בטיחות -----
  spine_rounding:   { requires: [spine_flexion_deg] }
  lateral_bend:     { requires: [spine_curvature_side_deg] }
  head_alignment:   { requires: [head_pitch_deg, torso_forward_deg] }

  # ----- עמידה/רגליים -----
  stance_width:     { requires: [features.stance_width_ratio] }
  toe_angle:        { requires: [toe_angle_left_deg, toe_angle_right_deg] }
  knee_valgus:      { requires: [knee_foot_alignment_left_deg, knee_foot_alignment_right_deg] }
  heels_grounded:   { requires: [heel_lift_left, heel_lift_right] }
  foot_contact:     { requires: [foot_contact_left, foot_contact_right] }
  weight_shift:     { requires: [weight_shift] }

  # ----- קצב/פאזות -----
  tempo:            { requires: [rep.timing_s] }
  phase_control:    { requires: [rep.ecc_s, rep.con_s, rep.pause_bottom_s, rep.pause_top_s] }
  phase_balance:    { requires: [rep.ecc_s, rep.con_s] }
  turn_quality:     { requires: [rep.dir, rep.state, rep.phase] }

  # ----- Hook לצמרת (Top) — הווריאנט קובע איך לפרש -----
  top_quality_hook: { requires: [rep.pause_top_s, torso_forward_deg, spine_flexion_deg, heel_lift_left, heel_lift_right] }

# =============================================================================
# ⚖️ SCORING — מדיניות וכללי ניקוד (ברמת הבייס)
# =============================================================================
scoring:

  policy:
    missing: skip
    min_criteria_for_full_quality: 3

  # משקלים מוצעים (0–2) — הנוסחה בקוד מבצעת weighted_mean
  weights:
    spine_rounding: 2.0
    lateral_bend:   1.4
    head_alignment: 1.2

    hinge_posture:  1.8
    knee_flex_limit:1.0

    rom_joint:      1.5

    phase_control:  1.5
    tempo:          1.0
    phase_balance:  0.8

    knee_valgus:    1.4
    heels_grounded: 1.0
    stance_width:   0.8
    toe_angle:      0.6
    foot_contact:   0.6
    weight_shift:   0.6

    turn_quality:   0.5
    top_quality_hook: 1.0

  # תקרות בטיחות כלליות (גבול על לציון הסופי)
  safety_caps:
    - { when: "spine_rounding <= 0.6", cap: 0.85 }
    - { when: "knee_valgus   <= 0.6", cap: 0.90 }
    - { when: "heels_grounded<= 0.5", cap: 0.90 }

# =============================================================================
# 🔁 ספירת חזרות — הגדרות סיגנל וגייט
# =============================================================================
rep_signal:
  # בוחרים סיגנל זוויתי, חסין מרחק/זום:
  source: "angle|min|torso_forward_deg,hip_left_deg,hip_right_deg"
  thresholds:
    phase_delta: 5         # שינוי מינימלי כדי לצאת מ-start
    min_turn_ms: 100       # השהייה מינימלית ב-turn למניעת false-turn
    min_rep_ms: 500
    max_rep_ms: 6000
    # ספי ROM מינימליים לסיווג איכות (במעלות):
    min_rom_good: 25
    min_rom_partial: 18

rep_detection:
  phases: [start, towards, turn, away]
  turn_guard:
    min_rom_fraction: 0.30      # מתחת לזה — לא חזרה
    small_rep_threshold: 0.50   # בין 0.30–0.50 → partial/short (לפי gate)
  description: >
    זיהוי חזרה בעיקר מזוויות; object_y/hands_center_y/hip_y_px משמשים כגיבוי בלבד.
    מדיניות Top (נעילה/מתח) לא נאכפת כאן — תוגדר בווריאנט ותשפיע כמכפיל.

# =============================================================================
# 📣 חיבור לפידבק — מיפוי קריטריונים ↔ קבוצות משפטים קיימות (phrases.yaml)
# =============================================================================
feedback:
  # לכל קריטריון מצוינת קבוצת המשפטים ה"גנרית" הקיימת בקובץ he:
  bindings:
    rom_joint:        range_of_motion           # rep_good / set_good / rep_weak / ...
    tempo:            tempo
    phase_control:    tempo_control
    hinge_posture:    posture                   # שימושי לפידבק על הטיית גו כללית
    spine_rounding:   spine_rounding
    lateral_bend:     spine_sidebend
    head_alignment:   head_alignment

    stance_width:     stance_width
    toe_angle:        toe_angle_target          # 8–20°
    knee_valgus:      knee_alignment
    heels_grounded:   heels_grounded
    foot_contact:     foot_contact
    weight_shift:     weight_shift

  # אירועי סט כלליים (ללא Top) — קיימים כבר אצלך בקובץ (measurement_quality/general)
  set_events:
    pose_missing:     measurement_quality.pose_missing
    visibility_low:   measurement_quality.visibility_low
    not_enough_frames: general.not_enough_frames
    low_confidence:   general.low_pose_confidence

  # Top-policy specific — יוגדרו בווריאנטים (שמות קודים בלבד; הטקסטים ב-phrases):
  variant_placeholders:
    conventional_last_rep_no_full_lockout: "set.last_rep_no_full_lockout"
    rdl_excessive_top_hold:                "set.excessive_top_hold_for_rdl"

# =============================================================================
# 📈 סיכום עקרונות
# =============================================================================
summary:
  - קריטריונים קריטיים מזוויות בלבד → חסינות לשינויים בצילום.
  - ניקוד משוקלל + תקרות בטיחות מונעים “ציון יפה” עם טכניקה מסוכנת.
  - Top (נעילה/מתח) הוא פר ווּריאנט — אין ענישה בבייס.
  - ROM לפי hip+torso עם יעדי ברירת-מחדל, ניתנים לדריסה.

# =============================================================================
# 🚀 שיפורים עתידיים (Roadmap)
# =============================================================================
future_improvements:
  - pelvis_tilt_and_rotation: "לזהות היפראקסטנשן/סטיות אגן בטופ."
  - object_x_tracking:        "מסלול אופקי (bar path) לבדיקת ‘מוט קרוב לגוף’."
  - symmetry_indices:         "איזון ימין/שמאל (hips/shoulders) לזיהוי הטיות."
  - adaptive_targets:         "יעדי ROM/Tempo מותאמים גובה/אורך גפיים."
  - phase_jerk_metrics:       "מדדי ‘קפיצה’ בהיפוך/טופ לפי מהירות/תאוצה."
  - grip_width:               "מדד רוחב אחיזה — יופעל בווריאנטים עם מוט/דאמבלים."

# =============================================================================
# 🧠 הערכת אמינות
# =============================================================================
review:
  summary: >
    הבייס יציב ואמין למצלמה אחת: ROM זוויתי, סיגנל חזרות נקי, וחיבור מלא ל-phrases
    הגנריים. הווריאנטים מוסיפים רק ציוד/start_mode/יעדים ומדיניות Top, בלי לשנות
    את הליבה — מה שמונע באגים בין תרגילים ושומר על עקביות בדוחות.
