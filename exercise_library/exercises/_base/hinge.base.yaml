# =============================================================================
# 🧠 hinge.base.yaml — משפחת תנועות Hinge / Deadlift
# -----------------------------------------------------------------------------
# מטרת המשפחה: למדוד תנועה מבוססת Hinge — דדליפטים, RDL, סטיף-לג, טרפ-בר וכו’.
#
# עקרונות:
# - מדידת טווח תנועה לפי זוויות הירך והגו (לא לפי פיקסלים)
# - זיהוי פאזות ע"י torso_forward_deg + hip_*_deg
# - שליטה בקצב, בטיחות, יישור ברך-כף-רגל ומגע עקבים
# - מצב Top (נעילה/מתח בצמרת) יוגדר בכל וריאנט ספציפי
#
# הערה: קובץ בסיס זה אינו מכריח נעילה מלאה — הוא מספק hooks, והווריאנטים מגדירים מדיניות Top.
# =============================================================================

meta:
  id: "hinge.base"
  family: "hinge"
  display_name: "תנועת Hinge (בסיס משפחה)"
  selectable: false            # לא נבחר ישירות; הווריאנטים יורשים ממנו
  version: 1.0.0
  notes: >
    קובץ זה מגדיר את בסיס המשפחה של תנועות ההינג׳. הווריאנטים (דדליפט רגיל,
    RDL, סטיף-לג, טרפ-בר וכו’) יורשים ממנו ומשנים מדיניות Top לפי הצורך.
    המדידה נשענת על זוויות הירך והגו בלבד — ללא תלות בפיקסלים — מה שמקשה
    על הטיות בגלל מרחק מצלמה/זום/גובה מתאמן.

# =============================================================================
# 🧭 רמזי זיהוי בסיסיים למסווג
# =============================================================================
match_hints:
  must_have: [pose.available]
  pose_view: ["side", "front_left", "front_right"]  # תצפית צד/אלכסון-קדמי עדיפה
  motion_pattern: ["hip_hinge"]
  joints_focus: ["hips", "spine", "knees"]

# =============================================================================
# 🧾 הגדרות כלליות
# =============================================================================
defaults:
  # מצב Top יוגדר בווריאנט ("full_lockout" או "tension_top")
  lockout_mode: "inherit"

  # יעדים כלליים לטווח תנועה — נבחרים לפי start_mode בווריאנט
  targets:
    from_floor:
      hip_deg: 60
      torso_deg: 35
    from_standing:
      hip_deg: 48
      torso_deg: 30

# =============================================================================
# 🧩 קריטריונים ודרישות מדידה
# =============================================================================
criteria:

  # ----- קריטיים (חובה לניקוד חזרה) -----
  critical:
    - pose.available
    - spine_flexion_deg
    - torso_forward_deg
    - hip_left_deg
    - hip_right_deg

  # ----- מקורות עזר לפאזות/ספירה (לא חובה; אחד מהם מספיק במקרה הצורך) -----
  fallback_sources:
    - object_y          # גובה העומס (אם מזוהה עצם)
    - hands_center_y    # גיבוי כשאין ציוד ברור
    - hip_y_px          # חירום לספירה בלבד

  # ----- שלמות תבנית Hinge (שלא יהפוך לסקוואט) -----
  hinge_posture:
    inputs: [torso_forward_deg, knee_left_deg, knee_right_deg]
    description: "בודק יחס גו/ברך; הינג׳ תקין = הטיית גו משמעותית מול כפיפת ברך מתונה."

  # מגבלת כפיפת ברך (לשמור על ברך 'פתוחה' יחסית להבדיל מסקוואט)
  knee_flex_limit:
    inputs: [knee_left_deg, knee_right_deg]
    description: "בודק שהברך אינה נסגרת עמוק; יעד טיפוסי ~100–115°."

  # ----- טווח תנועה לפי זוויות — ללא פיקסלים -----
  rom_joint:
    inputs: [hip_left_deg, hip_right_deg, torso_forward_deg]
    method: "dual_angle_rom"
    description: "ROM שמרני: המינימום בין יחס ה-ROM של ירך לבין זה של הגו מול היעד."

  # ----- בטיחות -----
  safety:
    spine_rounding: spine_flexion_deg                  # עגילת גב (סגיטלי)
    lateral_bend: spine_curvature_side_deg             # עיקום צדדי (פרונטלי)
    head_alignment: [head_pitch_deg, torso_forward_deg]# ראש בקו עם הגו

  # ----- שליטה וקצב -----
  tempo:
    inputs: [rep.timing_s]
  phase_control:
    inputs: [rep.ecc_s, rep.con_s, rep.pause_bottom_s, rep.pause_top_s]
  phase_balance:
    inputs: [rep.ecc_s, rep.con_s]
    description: "איזון בין משכי אקצנטרי/קונצנטרי (ללא קביעה סגנונית קשיחה)."

  # ----- מנח רגליים ויציבות -----
  stance:
    stance_width: features.stance_width_ratio
    toe_angle_left: toe_angle_left_deg
    toe_angle_right: toe_angle_right_deg
    toe_angle_pair: [toe_angle_left_deg, toe_angle_right_deg]
    heels_grounded_inputs: [heel_lift_left, heel_lift_right]
    knee_valgus: [knee_foot_alignment_left_deg, knee_foot_alignment_right_deg]

  # מגע עקבים (קריטריון מפורש)
  heels_grounded:
    inputs: [heel_lift_left, heel_lift_right]
    description: "True כשהעקבים לא מורמים (כלומר אין הרמת עקב)."

  # זווית כפות רגליים כקריטריון זוגי
  toe_angle:
    inputs: [toe_angle_left_deg, toe_angle_right_deg]
    description: "טווח רצוי 5–20° לכל רגל, וא-סימטריה ≤10°."

  # ----- איכות שינוי כיוון -----
  turn_quality:
    inputs: [rep.dir, rep.state, rep.phase]

  # ----- Hook לציון Top (נעילה/מתח) — הווריאנט יגדיר מדיניות -----
  top_quality_hook:
    description: >
      מדד גנרי שישמש לווריאנט כדי לחשב multiplier לפי המדיניות שלו
      (נעילה מלאה ב-Conventional / מתח בצמרת ב-RDL/SLDL).
    inputs:
      - rep.pause_top_s
      - torso_forward_deg
      - spine_flexion_deg
      - heel_lift_left
      - heel_lift_right

# =============================================================================
# ⚖️ משקלים לציון כולל (0–2)
# =============================================================================
weights:
  # בטיחות
  spine_rounding: 2.0
  lateral_bend: 1.4
  head_alignment: 1.2

  # תבנית תנועה
  hinge_posture: 1.8
  knee_flex_limit: 1.0

  # טווח תנועה (ROM)
  rom_joint: 1.5

  # שליטה וקצב
  phase_control: 1.5
  tempo: 1.0
  phase_balance: 0.8

  # רגליים ויציבה
  knee_valgus: 1.4
  heels_grounded: 1.0
  stance_width: 0.8
  toe_angle: 0.6

  # שינוי כיוון וצמרת
  turn_quality: 0.5
  top_quality_hook: 1.0   # יומר למכפיל/בקרת Top בווריאנט

# =============================================================================
# 🧮 מדיניות ניקוד (תיאורית)
# =============================================================================
scoring_logic:
  description: >
    הציון הסופי הוא ממוצע משוקלל של הקריטריונים. קיימות תקרות בטיחות
    שמגבילות ציון סופי כשבטיחות ירודה, כדי שלא 'להבריק' על חשבון בטיחות.
  formula: >
    rep_score_core = weighted_mean(all_criteria)
    # Safety Caps (דוגמה):
    if spine_rounding_score <= 0.6 → rep_score_core *= 0.85
    if knee_valgus_score   <= 0.6 → rep_score_core *= 0.90
    # הווריאנט מוסיף כאן את מדיניות ה-Top (מכפיל):
    # rep_score = rep_score_core * top_policy_multiplier

# =============================================================================
# 🔁 לוגיקת ספירת חזרות
# =============================================================================
rep_detection:
  description: >
    חזרה מזוהה לפי שינוי פאזה (turn) על סמך זוויות הירך והגו. object_y משמש עזר
    בלבד אם יש ציוד. סף ספירה: rom_joint_ratio ≥ 0.30 (אחרת לא נספרת).
  phases: [start, towards, turn, away]
  turn_guard:
    min_rom_fraction: 0.30     # מתחת לזה — לא נספר
    small_rep_threshold: 0.50   # בין 0.30–0.50 — נספר כ'חלקי' ומסומן short

# =============================================================================
# 📈 סיכום עקרונות
# =============================================================================
summary:
  - מדידות קריטיות מזוויות (לא מפיקסלים) → חסינות לסקייל/מרחק מצלמה.
  - קריטריונים מבוססי ROM, יציבה ובטיחות + שליטה בפאזות.
  - מדיניות Top (נעילה/מתח) מוגדרת בווריאנטים, לא בבסיס.
  - מתאים לכל וריאציות ההינג׳ (קונבנציונלי, RDL, סטיף-לג, טרפ-בר וכו’).

# =============================================================================
# 📣 Hooks לדיווח (מיפוי אירועים → קודי משפטים ב-phrases.yaml)
# =============================================================================
phrases:
  # ברירת מחדל למשפחה — הווריאנטים יכולים לדרוס/להוסיף
  namespace: "hinge.common"

  rom_joint_map:
    good:        "hinge.common.rom_joint.rep_good"
    short:       "hinge.common.rom_joint.rep_short"
    too_short:   "hinge.common.rom_joint.rep_too_short"
    set_good:    "hinge.common.rom_joint.set_good"
    set_weak:    "hinge.common.rom_joint.set_weak"
    rep_missing: "hinge.common.rom_joint.rep_missing"
    set_missing: "hinge.common.rom_joint.set_missing"

  turn_map:
    good:        "hinge.common.turn.rep_good"
    weak:        "hinge.common.turn.rep_weak"
    set_good:    "hinge.common.turn.set_good"
    set_weak:    "hinge.common.turn.set_weak"
    rep_missing: "hinge.common.turn.rep_missing"
    set_missing: "hinge.common.turn.set_missing"

  path_hints_map:
    close: "hinge.common.path_hints.rep_close"
    swing: "hinge.common.path_hints.rep_swing"

# =============================================================================
# 🚀 שיפורים עתידיים (Roadmap)
# =============================================================================
future_improvements:
  - pelvis_tilt_and_rotation: "לזהות היפראקסטנשן או סטיות באגן בלוק-אאוט."
  - object_x_tracking: "מעקב אופקי לעומס (bar path) לזיהוי ‘קרוב לגוף’."
  - symmetry_indices: "מדדי איזון R/L (hips/shoulders) לטיוב פידבק."
  - adaptive_targets: "התאמת יעדי ROM/Tempo לפי גובה/אורך גפיים."
  - phase_jerk_metrics: "זיהוי שינויי כיוון חדים מדי (turn/top) על בסיס מהירות/תאוצה."
  - grip_width: "מדד רוחב אחיזה והשפעתו על יציבות כתף/מרפק."

# =============================================================================
# 🧠 הערכת אמינות (סקירה)
# =============================================================================
review:
  summary: >
    המבנה אמין לשימוש במצלמה אחת הודות למדידה מזוויות בלבד. תקרות בטיחות
    מונעות ציונים גבוהים כשיש כשלים יציבתיים. מדיניות Top נשארת בווריאנטים,
    כך שקונבנציונלי מקבל נעילה מלאה ואילו RDL/SLDL מעדיפים מתח בצמרת.
