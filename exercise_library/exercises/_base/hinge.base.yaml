# =============================================================================
# 🧠 hinge.base.yaml — משפחת תנועות Hinge / Deadlift
# -----------------------------------------------------------------------------
# מטרת המשפחה: למדוד תנועה מבוססת Hinge — דדליפטים, RDL, סטיף לג, טרפ-בר וכו’.
#
# עקרונות:
# - מדידת טווח תנועה לפי זוויות הירך והגו (לא לפי פיקסלים)
# - זיהוי פאזות ע"י torso_forward_deg + hip angles
# - שליטה בקצב, בטיחות, יישור רגליים ומנח רגל
# - Top (נעילה / מתח בצמרת) יוגדר בכל וריאנט ספציפי
#
# גרסה זו אינה מניחה נעילה מלאה — אלא מספקת hook למדיניות הווריאנט.
# =============================================================================

meta:
  id: "hinge.base"
  family: "hinge"
  display_name: "תנועת Hinge (בסיס משפחה)"
  selectable: false           # אי אפשר לבחור ישירות; רק דרך וריאנטים
  version: 1.0.0
  notes: >
    קובץ זה מגדיר את בסיס המשפחה של תנועות ההינג׳.  
    הווריאנטים (כמו דדליפט רגיל, RDL, סטיף לג וכו’) יורשים ממנו ומשנים מדיניות Top.
    כל הנתונים מבוססים על מדידה מזוויות הירך והגו בלבד — ללא תלות בפיקסלים.
    בכך המערכת חסינה לשינוי מרחק מצלמה, קנה־מידה, ומיקום מתאמן.

# =============================================================================
# 🧾 הגדרות כלליות
# =============================================================================
defaults:
  # מצב נעילה יוגדר בווריאנט ("full_lockout" או "tension_top")
  lockout_mode: "inherit"

  # יעדים כלליים לטווח תנועה — ישתנו לפי start_mode
  targets:
    from_floor:
      hip_deg: 60
      torso_deg: 35
    from_standing:
      hip_deg: 48
      torso_deg: 30

# =============================================================================
# 🧩 קריטריונים ודרישות מדידה
# =============================================================================
criteria:
  # קריטריונים קריטיים — חובה כדי לחשב ציון מלא
  critical:
    - pose.available
    - spine_flexion_deg
    - torso_forward_deg
    - hip_left_deg
    - hip_right_deg

  # עזר לזיהוי פאזות או ציוד (לפחות אחד מהם נדרש)
  fallback_sources:
    - object_y
    - hands_center_y
    - hip_y_px

  # שלמות תבנית Hinge — יחס גו/ברך (לא להפוך לסקוואט)
  hinge_posture:
    inputs: [torso_forward_deg, knee_left_deg, knee_right_deg]
    description: "בודק שהירך מתכופפת יותר מהברך — כלומר תבנית הינג׳ תקינה"

  # טווח תנועה לפי זוויות — ללא תלות בפיקסלים
  rom_joint:
    inputs: [hip_left_deg, hip_right_deg, torso_forward_deg]
    method: "dual_angle_rom"
    description: "חישוב ROM שמרני לפי מינימום היחס בין ירך לגו"

  # מדדי בטיחות
  safety:
    spine_rounding: spine_flexion_deg
    lateral_bend: spine_curvature_side_deg
    head_alignment: [head_pitch_deg, torso_forward_deg]

  # קצב ושליטה
  tempo:
    inputs: [rep.timing_s]
  phase_control:
    inputs: [rep.ecc_s, rep.con_s, rep.pause_bottom_s, rep.pause_top_s]

  # מנח רגליים ויציבות
  stance:
    stance_width: features.stance_width_ratio
    toe_angle_left: toe_angle_left_deg
    toe_angle_right: toe_angle_right_deg
    heels_grounded: heels_grounded
    knee_valgus: [knee_foot_alignment_left_deg, knee_foot_alignment_right_deg]

  # איכות שינוי כיוון
  turn_quality:
    inputs: [rep.dir, rep.state, rep.phase]

  # Hook לציון ה-Top (נעילה / מתח בצמרת)
  top_quality_hook:
    description: >
      מדד גנרי שישמש לווריאנט כדי לחשב multiplier לפי המדיניות שלו  
      (בין אם זו נעילה מלאה או שמירה על מתח בצמרת).
    inputs:
      - rep.pause_top_s
      - torso_forward_deg
      - spine_flexion_deg
      - heels_grounded

# =============================================================================
# ⚖️ משקלים לציון כולל (0–2)
# =============================================================================
weights:
  # בטיחות
  spine_rounding: 2.0
  lateral_bend: 1.4
  head_alignment: 1.2

  # תבנית תנועה
  hinge_posture: 1.8
  knee_flex_limit: 1.0

  # טווח תנועה (ROM)
  rom_joint: 1.5

  # שליטה וקצב
  phase_control: 1.5
  tempo: 1.0
  phase_balance: 0.8

  # רגליים ויציבה
  knee_valgus: 1.4
  heels_grounded: 1.0
  stance_width: 0.8
  toe_angle: 0.6

  # שינוי כיוון וצמרת
  turn_quality: 0.5
  top_quality_hook: 1.0  # נשתמש בווריאנטים כ-multiplier

# =============================================================================
# 🧮 נוסחת ניקוד (פשטנית להמחשה)
# =============================================================================
scoring_logic:
  description: >
    הציון הסופי מחושב כממוצע משוקלל של כל הקריטריונים  
    עם תקרת בטיחות למניעת ציונים גבוהים כשיש כשל יציבתי או בטיחותי.

  formula: >
    rep_score_core = weighted_mean(all_criteria)
    # Safety Cap:
    if safety_score < 0.6 → rep_score_core *= 0.85
    if knee_valgus_score < 0.6 → rep_score_core *= 0.90
    # הווריאנט מוסיף כאן את הכפלת Top לפי המדיניות שלו:
    # rep_score = rep_score_core * top_policy_multiplier

# =============================================================================
# 🔁 לוגיקת ספירת חזרות
# =============================================================================
rep_detection:
  description: >
    חזרה מזוהה לפי שינוי פאזה (turn) ע"פ זוויות הירך והגו.  
    object_y משמש רק לגיבוי אם יש ציוד.
    סף ספירה: rom_joint_ratio ≥ 0.30, אחרת לא נספרת.
  phases: [start, towards, turn, away]
  turn_guard:
    min_rom_fraction: 0.30
    small_rep_threshold: 0.50

# =============================================================================
# 📈 סיכום עקרונות
# =============================================================================
summary:
  - כל מדידה קריטית נלקחת מזוויות (לא מיקום פיקסלים)
  - קריטריונים מבוססי ROM, יציבה ובטיחות
  - נדרשת שליטה מינימלית בכל פאזה (ecc/con/pause)
  - מדיניות Top (נעילה / מתח) תוגדר בווריאנטים בלבד
  - ציון משפחתי מאוזן, מתאים לכל סוגי הדדליפט

# =============================================================================
# 🚀 שיפורים עתידיים (Roadmap)
# =============================================================================
future_improvements:
  - pelvis_tilt_and_rotation: "לזהות היפראקסטנשן או סטיות באגן בלוק-אאוט"
  - object_x_tracking: "להוסיף מסלול אופקי לבדוק אם המוט קרוב לגוף"
  - symmetry_indices: "להוסיף מדדי איזון בין ימין לשמאל (hips/shoulders)"
  - adaptive_targets: "להתאים יעדי ROM וtempo לפי גובה ואורך גפיים"
  - phase_jerk_metrics: "לזהות שינויי כיוון חדים מדי (ב-turn וב-top)"
  - grip_width: "מדד רוחב אחיזה והשפעתו על יציבות"

# =============================================================================
# 🧠 הערכת אמינות (מאת המפתח)
# =============================================================================
review:
  summary: >
    מבנה המשפחה הזה נחשב אמין מאוד עבור מצלמה אחת, 
    מאחר שכל המדדים קריטיים נלקחים מזוויות (ולא פיקסלים).  
    המעבר למדיניות נעילה בווריאנטים מאפשר גמישות רבה – 
    בדדליפט רגיל המערכת בודקת נעילה מלאה, וברומני היא בודקת שמירת מתח.
    התוצאה: מערכת אמינה, מאוזנת ונגישה ליישום אמיתי בחדר כושר.
