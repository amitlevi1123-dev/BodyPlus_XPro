# -*- coding: utf-8 -*-
# ===================================================================
# curl.base.yaml — בסיס למשפחת כפיפות מרפק (Curl / Elbow Flexion)
# ===================================================================

id: curl.base
family: curl

meta:
  selectable: false
  display_name: "Curl (Base)"
  notes: >
    משפחת כפיפות מרפק (DB/EZ/Cable/Preacher/Incline/Hammer/Concentration).
    מדגישים ROM במרפק, יציבות גו, הימנעות מתנועת כתף קדימה, טמפו נשלט,
    ושורש כף־יד ניטרלי. הווריאנטים ידרסו ציוד/תנוחה/טווחים בהתאם.
    "יציבה" אינה חייבת להיות עמידה — העיקר יציבות (Stable Posture).

phrases:
  namespace: "curl.common"   # לא נדרשת הוספה בקובץ phrases.yaml; משתמשים בקטגוריות קיימות

targets:
  upper:
    pull:
      elbow_rom_deg_target: 90
      elbow_rom_deg_partial: 60
      elbow_rom_deg_cutoff: 40
      shoulder_flexion_ok: 10
      shoulder_flexion_warn: 15
      shoulder_flexion_bad: 20

# ------------------------------------------------------------
# 🧪 קריטריונים — שימוש בשמות שיש להם פרייזים קיימים כשאפשר
# ------------------------------------------------------------
criteria:
  # יציבה/גו/ראש (קיימים ב-phrases)
  posture:            { requires: [torso_forward_deg] }                         # phrases.posture
  spine_rounding:     { requires: [spine_flexion_deg] }                         # phrases.spine_rounding
  head_alignment:     { requires: [head_pitch_deg, torso_forward_deg] }         # phrases.head_alignment

  # ROM עליון (שם כללי עם פרייזים קיימים)
  range_of_motion:    { requires: [elbow_left_deg, elbow_right_deg] }          # phrases.range_of_motion

  # כתף (ענישה ייעודית; ללא פרייז ייעודי – לא נדרש שינוי ב-phrases)
  shoulder_stillness: { requires: [shoulder_left_deg, shoulder_right_deg] }

  # טמפו/פאזות (קיימים ב-phrases)
  tempo:              { requires: [rep.timing_s] }                              # phrases.tempo
  tempo_control:      { requires: [rep.ecc_s, rep.con_s] }                      # phrases.tempo_control
  turn_quality:       { requires: [rep.dir, rep.state, rep.phase] }             # אין טקסט ייעודי – מותר

  # שורש כף־יד (קיים ב-phrases)
  wrist_position:     { requires: [wrist_flex_ext_left_deg, wrist_flex_ext_right_deg] }  # phrases.wrist_position

  # ברכיים רכות (קטן; אין פרייז ייעודי – לא חובה טקסט)
  knees_soft:
    requires: [knee_left_deg, knee_right_deg]
    enable_when: "not variant.posture_fixed"

  # Hooks (ללא צורך בפרייז)
  top_quality_hook:   { requires: [rep.pause_top_s, spine_flexion_deg, torso_forward_deg] }
  grip_width_hook:    { requires: [shoulders_width_px] }

# ------------------------------------------------------------
# ⚠️ קריטיים — תנאי סף לניקוד חזרה
# ------------------------------------------------------------
critical:
  - posture
  - range_of_motion        # חייבים מדידת ROM במרפק כדי למדוד Curl

# ------------------------------------------------------------
# ⚖️ SCORING — כללי ניקוד + תקרות בטיחות
# ------------------------------------------------------------
scoring:
  policy:
    missing: skip
    min_criteria_for_full_quality: 3

  criteria:

    # --- עיקריים למשפחה ---
    range_of_motion:
      weight: 2.0
      rule:
        kind: threshold_window
        input: rep.rom          # מחושב מתוך זוויות המרפק ברמת החזרה
        target: 90
        partial: 60
        cutoff_min: 40

    # כתף לא "בורחת" קדימה
    shoulder_stillness:
      weight: 1.2
      rule:
        kind: symmetric_threshold
        input: "max(abs(shoulder_left_deg - mean(shoulder_left_deg)), abs(shoulder_right_deg - mean(shoulder_right_deg)))"
        ok: 10
        warn: 15
        bad: 20

    # --- יציבה ובטיחות ---
    posture:
      weight: 1.4
      rule:
        kind: symmetric_threshold
        input: "abs(torso_forward_deg - mean(torso_forward_deg))"
        ok: 6
        warn: 10
        bad: 15

    spine_rounding:
      weight: 1.2
      rule: { kind: symmetric_threshold, input: spine_flexion_deg, ok: 10, warn: 20, bad: 30 }

    head_alignment:
      weight: 0.8
      rule: { kind: symmetric_threshold, input: "abs(head_pitch_deg - torso_forward_deg)", ok: 10, warn: 20, bad: 30 }

    # --- טמפו ושליטה ---
    tempo:
      weight: 0.6
      rule: { kind: tempo_window, input: rep.timing_s, min: 0.8, max: 2.5, cutoff_min: 0.6, cutoff_max: 6.0 }

    tempo_control:
      weight: 0.6
      rule: { kind: phase_balance, ecc_min: 0.6, con_min: 0.4, ecc_con_ratio_min: 1.2 }

    turn_quality:
      weight: 0.4
      rule: { kind: jerk_guard, allow_bounce: false }

    # --- יד/אחיזה/ברכיים ---
    wrist_position:
      weight: 0.3
      rule:
        kind: band_center
        input: "(wrist_flex_ext_left_deg,wrist_flex_ext_right_deg)"
        min_ok: -10
        max_ok: 15
        cutoff_min: -25
        cutoff_max: 30

    knees_soft:
      weight: 0.2
      enable_when: "not variant.posture_fixed"
      rule:
        kind: band_center
        input: "(knee_left_deg,knee_right_deg)"
        min_ok: 5
        max_ok: 10
        cutoff_min: 0
        cutoff_max: 25

    # --- Hooks (לא מציגים טקסט; ניקוד בלבד) ---
    top_quality_hook:
      weight: 0.5
      rule: { kind: passthrough }

    grip_width_hook:
      weight: 0.3
      rule: { kind: passthrough }

  aggregate:
    method: weighted_mean
    weights_source: inline

  safety_caps:
    - { when: "posture          <= 0.6", cap: 0.85 }  # סווינג/גו חלש
    - { when: "range_of_motion  <= 0.6", cap: 0.85 }  # ROM חלקי/חסר
    - { when: "head_alignment   <= 0.5", cap: 0.90 }
    - { when: "wrist_position   <= 0.5", cap: 0.90 }

# ------------------------------------------------------------
# 🧭 רמזים למסווג — רק מפתחות שקיימים ב-aliases
# ------------------------------------------------------------
match_hints:
  must_have: [pose.available]
  any_of:
    - objdet.dumbbell_present
    - objdet.bar_present
  pose_view: [front, front_left, side_light]

# ------------------------------------------------------------
# 🔁 אות חזרה (Rep Signal)
# ------------------------------------------------------------
rep_signal:
  source: "angle|auto|min"
  candidates:
    upper: ["elbow_left_deg","elbow_right_deg","shoulder_left_deg","shoulder_right_deg"]
    lower: ["hip_left_deg","hip_right_deg","knee_left_deg","knee_right_deg","torso_forward_deg"]
    core:  ["torso_forward_deg","spine_flexion_deg"]
  thresholds:
    phase_delta: 5
    min_turn_ms: 120
    min_rep_ms: 600
    max_rep_ms: 6000
    min_rom_good: 25
    min_rom_partial: 18

# ------------------------------------------------------------
# 🔄 מקורות גיבוי לפאזות/ספירה
# ------------------------------------------------------------
fallback_sources:
  any_of: ["object_y","hands_center_y"]

# ------------------------------------------------------------
# 📌 הערות מימוש
# • הווריאנט קובע: equipment, pose_view, start_mode, rom_policy, top_policy, posture_fixed.
# • curl.preacher / curl.incline יגדירו posture_fixed: true (מדלג על knees_soft).
# • אפשר לדרוס טווחי ROM/כתף/שורש־כף־יד לכל וריאנט בנפרד.
# • שימוש רק במפתחות קנוניים הקיימים כבר ב-aliases.yaml.
# • שימוש בקטגוריות פרייזים קיימות: range_of_motion, posture, spine_rounding,
#   head_alignment, tempo, tempo_control, wrist_position.
# ------------------------------------------------------------
