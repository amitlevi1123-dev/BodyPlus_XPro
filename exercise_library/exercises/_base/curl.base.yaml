# -*- coding: utf-8 -*-
# ===================================================================
# curl.base.yaml â€” ×‘×¡×™×¡ ×œ××©×¤×—×ª ×›×¤×™×¤×•×ª ××¨×¤×§ (Curl / Elbow Flexion)
# ===================================================================

id: curl.base
family: curl

meta:
  selectable: false
  display_name: "Curl (Base)"
  notes: >
    ××©×¤×—×ª ×›×¤×™×¤×•×ª ××¨×¤×§ (DB/EZ/Cable/Preacher/Incline/Hammer/Concentration).
    ××“×’×™×©×™× ROM ×‘××¨×¤×§, ×™×¦×™×‘×•×ª ×’×•, ×”×™×× ×¢×•×ª ××ª× ×•×¢×ª ×›×ª×£ ×§×“×™××”, ×˜××¤×• × ×©×œ×˜,
    ×•×©×•×¨×© ×›×£Ö¾×™×“ × ×™×˜×¨×œ×™. ×”×•×•×¨×™×× ×˜×™× ×™×“×¨×¡×• ×¦×™×•×“/×ª× ×•×—×”/×˜×•×•×—×™× ×‘×”×ª××.
    "×™×¦×™×‘×”" ××™× ×” ×—×™×™×‘×ª ×œ×”×™×•×ª ×¢××™×“×” â€” ×”×¢×™×§×¨ ×™×¦×™×‘×•×ª (Stable Posture).

phrases:
  namespace: "curl.common"   # ×œ× × ×“×¨×©×ª ×”×•×¡×¤×” ×‘×§×•×‘×¥ phrases.yaml; ××©×ª××©×™× ×‘×§×˜×’×•×¨×™×•×ª ×§×™×™××•×ª

targets:
  upper:
    pull:
      elbow_rom_deg_target: 90
      elbow_rom_deg_partial: 60
      elbow_rom_deg_cutoff: 40
      shoulder_flexion_ok: 10
      shoulder_flexion_warn: 15
      shoulder_flexion_bad: 20

# ------------------------------------------------------------
# ğŸ§ª ×§×¨×™×˜×¨×™×•× ×™× â€” ×©×™××•×© ×‘×©××•×ª ×©×™×© ×œ×”× ×¤×¨×™×™×–×™× ×§×™×™××™× ×›×©××¤×©×¨
# ------------------------------------------------------------
criteria:
  # ×™×¦×™×‘×”/×’×•/×¨××© (×§×™×™××™× ×‘-phrases)
  posture:            { requires: [torso_forward_deg] }                         # phrases.posture
  spine_rounding:     { requires: [spine_flexion_deg] }                         # phrases.spine_rounding
  head_alignment:     { requires: [head_pitch_deg, torso_forward_deg] }         # phrases.head_alignment

  # ROM ×¢×œ×™×•×Ÿ (×©× ×›×œ×œ×™ ×¢× ×¤×¨×™×™×–×™× ×§×™×™××™×)
  range_of_motion:    { requires: [elbow_left_deg, elbow_right_deg] }          # phrases.range_of_motion

  # ×›×ª×£ (×¢× ×™×©×” ×™×™×¢×•×“×™×ª; ×œ×œ× ×¤×¨×™×™×– ×™×™×¢×•×“×™ â€“ ×œ× × ×“×¨×© ×©×™× ×•×™ ×‘-phrases)
  shoulder_stillness: { requires: [shoulder_left_deg, shoulder_right_deg] }

  # ×˜××¤×•/×¤××–×•×ª (×§×™×™××™× ×‘-phrases)
  tempo:              { requires: [rep.timing_s] }                              # phrases.tempo
  tempo_control:      { requires: [rep.ecc_s, rep.con_s] }                      # phrases.tempo_control
  turn_quality:       { requires: [rep.dir, rep.state, rep.phase] }             # ××™×Ÿ ×˜×§×¡×˜ ×™×™×¢×•×“×™ â€“ ××•×ª×¨

  # ×©×•×¨×© ×›×£Ö¾×™×“ (×§×™×™× ×‘-phrases)
  wrist_position:     { requires: [wrist_flex_ext_left_deg, wrist_flex_ext_right_deg] }  # phrases.wrist_position

  # ×‘×¨×›×™×™× ×¨×›×•×ª (×§×˜×Ÿ; ××™×Ÿ ×¤×¨×™×™×– ×™×™×¢×•×“×™ â€“ ×œ× ×—×•×‘×” ×˜×§×¡×˜)
  knees_soft:
    requires: [knee_left_deg, knee_right_deg]
    enable_when: "not variant.posture_fixed"

  # Hooks (×œ×œ× ×¦×•×¨×š ×‘×¤×¨×™×™×–)
  top_quality_hook:   { requires: [rep.pause_top_s, spine_flexion_deg, torso_forward_deg] }
  grip_width_hook:    { requires: [shoulders_width_px] }

# ------------------------------------------------------------
# âš ï¸ ×§×¨×™×˜×™×™× â€” ×ª× ××™ ×¡×£ ×œ× ×™×§×•×“ ×—×–×¨×”
# ------------------------------------------------------------
critical:
  - posture
  - range_of_motion        # ×—×™×™×‘×™× ××“×™×“×ª ROM ×‘××¨×¤×§ ×›×“×™ ×œ××“×•×“ Curl

# ------------------------------------------------------------
# âš–ï¸ SCORING â€” ×›×œ×œ×™ × ×™×§×•×“ + ×ª×§×¨×•×ª ×‘×˜×™×—×•×ª
# ------------------------------------------------------------
scoring:
  policy:
    missing: skip
    min_criteria_for_full_quality: 3

  criteria:

    # --- ×¢×™×§×¨×™×™× ×œ××©×¤×—×” ---
    range_of_motion:
      weight: 2.0
      rule:
        kind: threshold_window
        input: rep.rom          # ××—×•×©×‘ ××ª×•×š ×–×•×•×™×•×ª ×”××¨×¤×§ ×‘×¨××ª ×”×—×–×¨×”
        target: 90
        partial: 60
        cutoff_min: 40

    # ×›×ª×£ ×œ× "×‘×•×¨×—×ª" ×§×“×™××”
    shoulder_stillness:
      weight: 1.2
      rule:
        kind: symmetric_threshold
        input: "max(abs(shoulder_left_deg - mean(shoulder_left_deg)), abs(shoulder_right_deg - mean(shoulder_right_deg)))"
        ok: 10
        warn: 15
        bad: 20

    # --- ×™×¦×™×‘×” ×•×‘×˜×™×—×•×ª ---
    posture:
      weight: 1.4
      rule:
        kind: symmetric_threshold
        input: "abs(torso_forward_deg - mean(torso_forward_deg))"
        ok: 6
        warn: 10
        bad: 15

    spine_rounding:
      weight: 1.2
      rule: { kind: symmetric_threshold, input: spine_flexion_deg, ok: 10, warn: 20, bad: 30 }

    head_alignment:
      weight: 0.8
      rule: { kind: symmetric_threshold, input: "abs(head_pitch_deg - torso_forward_deg)", ok: 10, warn: 20, bad: 30 }

    # --- ×˜××¤×• ×•×©×œ×™×˜×” ---
    tempo:
      weight: 0.6
      rule: { kind: tempo_window, input: rep.timing_s, min: 0.8, max: 2.5, cutoff_min: 0.6, cutoff_max: 6.0 }

    tempo_control:
      weight: 0.6
      rule: { kind: phase_balance, ecc_min: 0.6, con_min: 0.4, ecc_con_ratio_min: 1.2 }

    turn_quality:
      weight: 0.4
      rule: { kind: jerk_guard, allow_bounce: false }

    # --- ×™×“/××—×™×–×”/×‘×¨×›×™×™× ---
    wrist_position:
      weight: 0.3
      rule:
        kind: band_center
        input: "(wrist_flex_ext_left_deg,wrist_flex_ext_right_deg)"
        min_ok: -10
        max_ok: 15
        cutoff_min: -25
        cutoff_max: 30

    knees_soft:
      weight: 0.2
      enable_when: "not variant.posture_fixed"
      rule:
        kind: band_center
        input: "(knee_left_deg,knee_right_deg)"
        min_ok: 5
        max_ok: 10
        cutoff_min: 0
        cutoff_max: 25

    # --- Hooks (×œ× ××¦×™×’×™× ×˜×§×¡×˜; × ×™×§×•×“ ×‘×œ×‘×“) ---
    top_quality_hook:
      weight: 0.5
      rule: { kind: passthrough }

    grip_width_hook:
      weight: 0.3
      rule: { kind: passthrough }

  aggregate:
    method: weighted_mean
    weights_source: inline

  safety_caps:
    - { when: "posture          <= 0.6", cap: 0.85 }  # ×¡×•×•×™× ×’/×’×• ×—×œ×©
    - { when: "range_of_motion  <= 0.6", cap: 0.85 }  # ROM ×—×œ×§×™/×—×¡×¨
    - { when: "head_alignment   <= 0.5", cap: 0.90 }
    - { when: "wrist_position   <= 0.5", cap: 0.90 }

# ------------------------------------------------------------
# ğŸ§­ ×¨××–×™× ×œ××¡×•×•×’ â€” ×¨×§ ××¤×ª×—×•×ª ×©×§×™×™××™× ×‘-aliases
# ------------------------------------------------------------
match_hints:
  must_have: [pose.available]
  any_of:
    - objdet.dumbbell_present
    - objdet.bar_present
  pose_view: [front, front_left, side_light]

# ------------------------------------------------------------
# ğŸ” ××•×ª ×—×–×¨×” (Rep Signal)
# ------------------------------------------------------------
rep_signal:
  source: "angle|auto|min"
  candidates:
    upper: ["elbow_left_deg","elbow_right_deg","shoulder_left_deg","shoulder_right_deg"]
    lower: ["hip_left_deg","hip_right_deg","knee_left_deg","knee_right_deg","torso_forward_deg"]
    core:  ["torso_forward_deg","spine_flexion_deg"]
  thresholds:
    phase_delta: 5
    min_turn_ms: 120
    min_rep_ms: 600
    max_rep_ms: 6000
    min_rom_good: 25
    min_rom_partial: 18

# ------------------------------------------------------------
# ğŸ”„ ××§×•×¨×•×ª ×’×™×‘×•×™ ×œ×¤××–×•×ª/×¡×¤×™×¨×”
# ------------------------------------------------------------
fallback_sources:
  any_of: ["object_y","hands_center_y"]

# ------------------------------------------------------------
# ğŸ“Œ ×”×¢×¨×•×ª ××™××•×©
# â€¢ ×”×•×•×¨×™×× ×˜ ×§×•×‘×¢: equipment, pose_view, start_mode, rom_policy, top_policy, posture_fixed.
# â€¢ curl.preacher / curl.incline ×™×’×“×™×¨×• posture_fixed: true (××“×œ×’ ×¢×œ knees_soft).
# â€¢ ××¤×©×¨ ×œ×“×¨×•×¡ ×˜×•×•×—×™ ROM/×›×ª×£/×©×•×¨×©Ö¾×›×£Ö¾×™×“ ×œ×›×œ ×•×¨×™×× ×˜ ×‘× ×¤×¨×“.
# â€¢ ×©×™××•×© ×¨×§ ×‘××¤×ª×—×•×ª ×§× ×•× ×™×™× ×”×§×™×™××™× ×›×‘×¨ ×‘-aliases.yaml.
# â€¢ ×©×™××•×© ×‘×§×˜×’×•×¨×™×•×ª ×¤×¨×™×™×–×™× ×§×™×™××•×ª: range_of_motion, posture, spine_rounding,
#   head_alignment, tempo, tempo_control, wrist_position.
# ------------------------------------------------------------
