# -*- coding: utf-8 -*-
# ===================================================================
# curl.base.yaml — בסיס למשפחת כפיפות מרפק (Curl / Elbow Flexion)
# ===================================================================
# זרימה: Camera → Pose/ObjDet → Normalizer+Aliases → Canonical Payload
#                                 └→ Classifier (משפחה+ווריאנטים)
# עקרונות:
# • קובץ בסיס: selectable:false — לא נבחר ישירות; הווריאנטים יורשים.
# • משתמשים רק במפתחות קנוניים (ראה aliases.yaml).
# • policy.missing=skip → קריטריון חסר לא מפיל את החזרה; הוא פשוט לא נספר בניקוד.
# • “hooks” למדיניות ייחודית למשפחה/וריאנט (posture_fixed, grip, top).
# • המדידה חכמה: סופרים רק תנועה אמיתית (ROM מינימלי וזמן חזרה סביר).
# ===================================================================

id: curl.base
family: curl

meta:
  selectable: false
  display_name: "Curl (Base)"
  notes: >
    משפחת כפיפות מרפק (DB/EZ/Cable/Preacher/Incline/Hammer/Concentration).
    מדגישים ROM במרפק, יציבות גו, הימנעות מתנועת כתף קדימה, טמפו נשלט,
    ושורש כף־יד ניטרלי. הווריאנטים ידרסו ציוד/תנוחה/טווחים בהתאם.
    "יציבה" אינה חייבת להיות עמידה — העיקר שהיא יציבה (Stable Posture).

# ------------------------------------------------------------
# 🗣️ מרחב מסרים
# ------------------------------------------------------------
phrases:
  namespace: "curl.common"

# ------------------------------------------------------------
# 🎯 יעדי ROM ברירת מחדל (ניתן לדרוס בווריאנטים)
# ------------------------------------------------------------
targets:
  upper:
    pull:
      elbow_rom_deg_target: 90     # יעד אפקטיבי (90–110° מקובל בחדר כושר)
      elbow_rom_deg_partial: 60    # partial
      elbow_rom_deg_cutoff: 40     # מתחת לזה לא נספר
      shoulder_flexion_ok: 10      # יעד שמרני למניעת "מרפק בורח קדימה"
      shoulder_flexion_warn: 15
      shoulder_flexion_bad: 20

# ------------------------------------------------------------
# 🧪 קריטריונים — המנוע ידלג על לא-רלוונטיים/חסרים
# ------------------------------------------------------------
criteria:
  # יציבה/גו/ראש
  posture:            { requires: [torso_forward_deg] }
  spine_rounding:     { requires: [spine_flexion_deg] }
  head_spine:         { requires: [head_pitch_deg, torso_forward_deg] }

  # כתף/מרפק — עיקריים למשפחה
  rom_joint_upper:    { requires: [elbow_left_deg, elbow_right_deg, shoulder_left_deg, shoulder_right_deg] }
  shoulder_stillness: { requires: [shoulder_left_deg, shoulder_right_deg] }

  # טמפו/פאזות
  tempo:              { requires: [rep.timing_s] }
  phase_control:      { requires: [rep.ecc_s, rep.con_s] }
  turn_quality:       { requires: [rep.dir, rep.state, rep.phase] }

  # שורש כף־יד (רצוי; יידלג אם חסר)
  wrist_neutral:      { requires: [wrist_flex_ext_left_deg, wrist_flex_ext_right_deg] }

  # ברכיים רכות (רלוונטי בעיקר בעמידה; וריאנטים בישיבה/שיפוע ידלגו)
  knees_soft:
    requires: [knee_left_deg, knee_right_deg]
    enable_when: "not variant.posture_fixed"    # וריאנט יכול להגדיר posture_fixed=true

  # Hooks
  top_quality_hook:   { requires: [rep.pause_top_s, spine_flexion_deg, torso_forward_deg] }
  grip_width_hook:    { requires: [shoulders_width_px] }  # ימומש בוריאנטים עם מוט/EZ

# ------------------------------------------------------------
# ⚠️ קריטיים — תנאי סף לניקוד חזרה
# ------------------------------------------------------------
critical:
  # חייבים יציבות בסיסית ומדדי ROM עליונים זמינים
  - posture
  - rom_joint_upper

# ------------------------------------------------------------
# ⚖️ SCORING — כללי ניקוד + תקרות בטיחות
# ------------------------------------------------------------
scoring:
  policy:
    missing: skip
    min_criteria_for_full_quality: 3

  criteria:

    # --- עיקריים למשפחה ---
    # ROM מרפק — לב הניקוד
    rom_joint_upper:
      weight: 2.0
      rule:
        kind: threshold_window
        # מודדים ROM מצטבר בפועל (מזוג מכל מרפק; המנוע יודע להפיק rep.rom מהזוויות)
        input: rep.rom
        target: 90
        partial: 60
        cutoff_min: 40

    # כתף לא "בורחת" קדימה לאורך החזרה
    shoulder_stillness:
      weight: 1.2
      rule:
        kind: symmetric_threshold
        input: "max(abs(shoulder_left_deg - baseline.shoulder_left_deg),abs(shoulder_right_deg - baseline.shoulder_right_deg))"
        ok: 10
        warn: 15
        bad: 20

    # --- יציבה ובטיחות ---
    posture:
      weight: 1.4
      rule:
        kind: symmetric_threshold
        input: "abs(delta.torso_forward_deg)"  # שינוי נטיית גו לאורך החזרה
        ok: 6
        warn: 10
        bad: 15

    spine_rounding:
      weight: 1.2
      rule: { kind: symmetric_threshold, input: spine_flexion_deg, ok: 10, warn: 20, bad: 30 }

    head_spine:
      weight: 0.8
      rule: { kind: symmetric_threshold, input: "abs(head_pitch_deg - torso_forward_deg)", ok: 10, warn: 20, bad: 30 }

    # --- טמפו ושליטה ---
    tempo:
      weight: 0.6
      rule: { kind: tempo_window, input: rep.timing_s, min: 0.8, max: 2.5, cutoff_min: 0.6, cutoff_max: 6.0 }

    phase_control:
      weight: 0.6
      rule: { kind: phase_balance, ecc_min: 0.6, con_min: 0.4, ecc_con_ratio_min: 1.2 }

    turn_quality:
      weight: 0.4
      rule: { kind: jerk_guard, allow_bounce: false }

    # --- יד/אחיזה/ברכיים ---
    wrist_neutral:
      weight: 0.3
      rule:
        kind: band_center
        input: "(wrist_flex_ext_left_deg,wrist_flex_ext_right_deg)"
        min_ok: -10
        max_ok: 15
        cutoff_min: -25
        cutoff_max: 30

    knees_soft:
      weight: 0.2
      enable_when: "not variant.posture_fixed"
      rule:
        kind: band_center
        input: "(knee_left_deg,knee_right_deg)"
        min_ok: 5
        max_ok: 10
        cutoff_min: 0
        cutoff_max: 25

    # --- Hooks (ימופו בווריאנטים) ---
    top_quality_hook:
      weight: 0.5
      rule: { kind: passthrough }

    grip_width_hook:
      weight: 0.3
      rule: { kind: passthrough }

  aggregate:
    method: weighted_mean
    weights_source: inline

  safety_caps:
    - { when: "posture        <= 0.6", cap: 0.85 }  # סווינג/גו חלש
    - { when: "rom_joint_upper<= 0.6", cap: 0.85 }  # ROM חלקי/חסר
    - { when: "head_spine     <= 0.5", cap: 0.90 }
    - { when: "wrist_neutral  <= 0.5", cap: 0.90 }

# ------------------------------------------------------------
# 🧭 רמזים למסווג — בסיס; הווריאנטים ירחיבו
# ------------------------------------------------------------
match_hints:
  must_have: [pose.available]
  any_of:
    - objdet.dumbbell_present
    - objdet.bar_present
    - objdet.cable_handle_present
  pose_view: [front, front_left, side_light]

# ------------------------------------------------------------
# 🔁 אות חזרה (Rep Signal) — angle-first עם Auto-Pick
# ------------------------------------------------------------
rep_signal:
  source: "angle|auto|min"   # יעדיף מרפק; יבחר אוטומטית את האמין ביותר
  candidates:
    upper: ["elbow_left_deg","elbow_right_deg","shoulder_left_deg","shoulder_right_deg"]
    lower: ["hip_left_deg","hip_right_deg","knee_left_deg","knee_right_deg","torso_forward_deg"]
    core:  ["torso_forward_deg","spine_flexion_deg"]
  thresholds:
    phase_delta: 5         # שינוי מינ’ כדי להתחיל פאזה
    min_turn_ms: 120       # השהיה מינ’ לאישור turn (נגד "במפ")
    min_rep_ms: 600
    max_rep_ms: 6000
    min_rom_good: 25       # דרישת ROM מינימלית כדי לספור good
    min_rom_partial: 18    # partial (לא נחשב מלא)

# ------------------------------------------------------------
# 🔄 מקורות גיבוי לפאזות/ספירה אם אין זוויות יציבות
# ------------------------------------------------------------
fallback_sources:
  any_of: ["object_y","hands_center_y"]

# ------------------------------------------------------------
# 📌 הערות מימוש
# • הווריאנט קובע: equipment, pose_view, start_mode, rom_policy, top_policy, posture_fixed.
# • curl.preacher / curl.incline יגדירו posture_fixed: true (מדלג על knees_soft).
# • אפשר לדרוס טווחי ROM/כתף/שורש־כף־יד לכל וריאנט בנפרד.
# • שמור את ה-phrases בשם namespace ייחודי לווריאנט: curl.<variant>.*
# ------------------------------------------------------------
