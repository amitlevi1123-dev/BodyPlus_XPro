# -------------------------------------------------------------------
# squat.bodyweight.yaml — סקוואט משקל גוף (Bodyweight Squat)
# -------------------------------------------------------------------
# יורש את חוקי הסקוואט הבסיסיים מ-squat.base, עם התאמות לעומק/טמפו/עמידה.
# דרישה עיקרית: עומק מלא — ברך ≤ 90°; טמפו איטי ומבוקר 2.0–5.0 שניות.
# -------------------------------------------------------------------

id: squat.bodyweight
family: squat
extends: squat.base

meta:
  selectable: true
  display_name: "סקוואט משקל גוף"
  description: "סקוואט ללא ציוד — עומק מלא (≤90°), עקבים נעוצים, וטמפו איטי 2–5 שניות."
  equipment: "none"   # באנגלית — לזיהוי וריאנט ללא ציוד

# -------------------------------------------------------------------
# ⚠️ קריטיים (חובה למדידה לצורך ניקוד חזרה)
# -------------------------------------------------------------------
# אם אחד הקריטריונים הללו חסר → policy.missing=skip ידלג על החזרה.
critical: [spine_rounding, knee_valgus, depth]

# -------------------------------------------------------------------
# ⚖️ התאמות ניקוד (Scoring Overrides)
# -------------------------------------------------------------------
scoring:
  policy:
    missing: skip
    min_criteria_for_full_quality: 3

  criteria:

    # --- עומק (חובה ≤ 90° לציון מלא) ---
    depth:
      weight: 1.3
      rule:
        kind: threshold_window
        input: "min(knee_left_deg, knee_right_deg)"
        target_max: 90          # ≤90° = 1.0
        cutoff_max: 150         # ≥150° = 0.0
        direction: lower_is_better

    # --- טמפו איטי ומבוקר ---
    tempo:
      weight: 1.3               # העלאת משקל הטמפו
      rule:
        kind: tempo_window
        input: rep.timing_s
        min: 2.0                # דרישת מינימום חדשה: 2.0s
        max: 5.0
        cutoff_min: 1.3         # מתחת ל-1.3s נענש חזק (גבולי)
        cutoff_max: 6.0         # מעל 6.0s נופל לציון 0

    # --- רוחב עמידה (יחס לרוחב כתפיים) ---
    stance_width:
      weight: 0.8
      rule:
        kind: band_center
        input: features.stance_width_ratio
        min_ok: 0.85
        max_ok: 1.25
        cutoff_min: 0.65
        cutoff_max: 1.55

    # --- עקבים נעוצים (בינארי) ---
    heels_grounded:
      weight: 0.8
      rule:
        kind: boolean_flag
        input: "(heel_lift_left or heel_lift_right)"   # True = יש הרמת עקב
        good_when: false                                # False = עקבים נעוצים (טוב)
        penalty: 0.50                                   # הורדה של 50% לקריטריון

    # --- בטיחות (יורש שמות מה-base; נשארים פעילים בווריאנט) ---
    spine_rounding:
      weight: 2.0
      rule:
        kind: linear_band
        input: spine_flexion_deg
        good_max: 10
        ok_max:   20
        bad_max:  35

    knee_valgus:
      weight: 2.0
      rule:
        kind: symmetric_threshold
        input: "max(abs(knee_foot_alignment_left_deg), abs(knee_foot_alignment_right_deg))"
        ok:   5
        warn: 10
        bad:  20

    spine_sidebend:
      weight: 1.5
      rule:
        kind: symmetric_threshold
        input: "abs(spine_curvature_side_deg)"
        ok:   5
        warn: 10
        bad:  20

    head_alignment:
      weight: 0.8
      rule:
        kind: symmetric_threshold
        input: "abs(head_pitch_deg - spine_flexion_deg)"
        ok:   10
        warn: 20
        bad:  30

  aggregate:
    method: weighted_mean
    weights_source: inline

  # -----------------------------------------------------------------
  # תקרות בטיחות (Safety Caps) — מגבילות ציון חזרה במצב סיכון
  # -----------------------------------------------------------------
  safety_caps:
    - { when: "spine_rounding <= 0.6", cap: 0.70 }   # גב מתעגל ⇒ cap 70%
    - { when: "knee_valgus   <= 0.6", cap: 0.75 }    # קריסת ברך ⇒ cap 75%
    - { when: "spine_sidebend<= 0.6", cap: 0.80 }    # עיקום צדדי ⇒ cap 80%

# -------------------------------------------------------------------
# 🧭 רמזים לזיהוי אוטומטי (Classifier Hints)
# -------------------------------------------------------------------
# אם קיים infer_equipment שעובד — מספיק must_have: pose.available.
# אם לא, נשמור must_not_have לציוד אחר כדי למנוע טעויות.
match_hints:
  must_have: [pose.available]
  must_not_have: [objdet.bar_present, objdet.kettlebell_present, objdet.dumbbell_present]
  pose_view: ["front", "front_left", "front_right"]
  motion_pattern: ["hip_down", "knee_flexion"]
  joints_focus: ["hips", "knees", "spine"]
  weight: 1.0

# -------------------------------------------------------------------
# 🔁 ספירת חזרות (Rep Signal)
# -------------------------------------------------------------------
# ספירה לפי תנועת האגן (יציב בסקוואט משקל גוף). הטווחים כאן מווסתים רק את הספירה,
# לא את הניקוד (הניקוד נקבע ע"י קריטריון tempo לעיל).
rep_signal:
  source: "value|min|hip_y_px"
  thresholds:
    min_rom_good: 60
    min_rep_ms:   600        # ספירה לא תקלוט פחות מזה (מומלץ מתחת לסף הניקוד)
    max_rep_ms:   8000       # כרית לשהיות ארוכות מבלי לשבור ספירה

# -------------------------------------------------------------------
# 🗣️ פידבק/פרייזס
# -------------------------------------------------------------------
# אין צורך לשנות phrases.yaml — הקריטריונים כאן תואמים למפתחות קיימים:
# depth_knee, tempo, stance_width, heels_grounded, spine_rounding,
# spine_sidebend, knee_valgus, head_alignment וכו'. המערכת תמפה אוטומטית.
