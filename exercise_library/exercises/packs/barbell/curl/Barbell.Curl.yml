# -*- coding: utf-8 -*-
# ===================================================================
# curl.barbell.yaml â€” ×•×¨×™××¦×™×™×ª "×›×¤×™×¤×•×ª ××¨×¤×§×™× ×¢× ××•×˜" (Barbell Curl)
# ===================================================================
# ××‘×•×¡×¡ ×¢×œ <family>.base (Upper). ×“×’×©×™×: ×œ×œ× ×¡×•×•×™× ×’, ×œ×œ× ×”×¨××•×ª ×›×ª×£,
# ×©×œ×™×˜×” ×‘×˜××¤×• ×•×‘×”×™×¤×•×š, ROM ××¨×¤×§ ×¡×‘×™×¨, ×‘×¨×›×™×™× "×¨×›×•×ª" ×œ×™×¦×™×‘×•×ª, ×›×£Ö¾×™×“ × ×™×˜×¨×œ×™×ª.
# ===================================================================

id: curl.barbell
family: curl

meta:
  selectable: true
  display_name: "×›×¤×™×¤×•×ª ××¨×¤×§×™× ×¢× ××•×˜"
  notes: >
    ×–×™×”×•×™ ××•×ª× ×” ×‘× ×•×›×—×•×ª ××•×˜. ××©×§×œ × ×™×§×•×“ ×’×‘×•×” ×œ×‘×˜×™×—×•×ª ×•×©×œ×™×˜×” (×¡×•×•×™× ×’/×›×ª×£),
    ××©×§×œ ××ª×•×Ÿ ×œ-ROM ××¨×¤×§. ×‘×¨×›×™×™× ×¨×›×•×ª ××–×›×•×ª ×‘×‘×•× ×•×¡ ×§×˜×Ÿ ×œ×™×¦×™×‘×•×ª.

inherits: curl.base   # ×× ×§×™×™× base ×œ××©×¤×—×ª curl. ×× ×œ× â€” ××—×§ ×©×•×¨×” ×–×•.

# ------------------------------------------------------------
# ğŸ—£ï¸ ××¨×—×‘ ××¡×¨×™×
# ------------------------------------------------------------
phrases:
  namespace: "curl.barbell"

# ------------------------------------------------------------
# ğŸ§­ ×¨××–×™× ×œ××¡×•×•×’ (Classifier)
# ------------------------------------------------------------
match_hints:
  must_have: [pose.available, objdet.bar_present]
  pose_view: [front, front_left, front_right]
  # ×¦×™×•×“:
  equipment_kind: barbell

# ------------------------------------------------------------
# ğŸ¯ ×™×¢×“×™ ROM/×˜××¤×• (×“×¨×™×¡×ª ×‘×¨×™×¨×•×ªÖ¾××—×“×œ ×œÖ¾Upper)
# ------------------------------------------------------------
targets:
  upper:
    press:  { elbow_rom_deg: 85, shoulder_rom_deg: 0 }  # ×›×ª×£ ×œ× ×××•×¨×” "×œ×’× ×•×‘"
    pull:   { elbow_rom_deg: 85, shoulder_rom_deg: 0 }
  tempo:
    rep_time_s_min: 0.7
    rep_time_s_max: 2.5
    fast_cutoff_s:  0.5
    long_bottom_pause_s: 0.6

# ------------------------------------------------------------
# ğŸ§ª ×§×¨×™×˜×¨×™×•× ×™× (××¤×ª×—×•×ª ×§× ×•× ×™×™× ×‘×œ×‘×“ â€” ×¢"×¤ aliases.yaml)
# ------------------------------------------------------------
criteria:

  # --- ×‘×˜×™×—×•×ª/×©×œ×™×˜×” ×¢×™×§×¨×™×™× ---
  swing_torso:                  { requires: [torso_forward_deg, torso_forward_vel_deg_s, torso_forward_acc_deg_s2] }
  shoulder_stability:           { requires: [shoulder_left_deg, shoulder_right_deg, elbow_left_deg, elbow_right_deg] }

  # --- ×˜××¤×• ×•×©×œ×™×˜×” ×‘×”×™×¤×•×š ---
  tempo:                        { requires: [rep.timing_s] }
  turn_quality:                 { requires: [rep.dir, rep.state, rep.phase] }

  # --- ROM ××¨×¤×§ (××‘×•×¡×¡ ×¢×œ rep.rom ×©× ××“×“ ×¢"×™ ×× ×•×¢ ×”×—×–×¨×•×ª) ---
  rom_elbow:                    { requires: [rep.rom] }

  # --- ×‘×¨×›×™×™× ×¨×›×•×ª ×œ×™×¦×™×‘×•×ª ---
  knees_soft:                   { requires: [knee_left_deg, knee_right_deg] }

  # --- ×©×•×¨×© ×›×£Ö¾×™×“/××—×™×–×” ---
  wrist_neutral:                { requires: [wrist_flex_ext_left_deg, wrist_flex_ext_right_deg, wrist_radial_ulnar_left_deg, wrist_radial_ulnar_right_deg] }

  # --- ×¨×•×—×‘ ××—×™×–×” (hook ×œ×¢×ª×™×“; ×›×¨×’×¢ passthrough/optional) ---
  grip_width_hook:              { requires: [shoulders_width_px] }

  # --- ×¢× ×™×©×” ×œ×¢×¦×™×¨×” ××¨×•×›×” ×‘×ª×—×ª×™×ª (××¤×—×™×ª×” ×¢×•××¡) ---
  bottom_pause_penalty:         { requires: [rep.pause_bottom_s] }

  # --- ×©××™×¨×ª ×’×‘ × ×™×˜×¨×œ×™ (×ª×§×¨×ª ×‘×˜×™×—×•×ª) ---
  spine_rounding:               { requires: [spine_flexion_deg] }

# ------------------------------------------------------------
# âš ï¸ ×§×¨×™×˜×™×™× â€” ×ª× ××™ ×¡×£ ×œ× ×™×§×•×“ ×—×–×¨×”
# ------------------------------------------------------------
critical:
  - posture                      # ××’×™×¢ ××”-base; ×× ××™×Ÿ base ××¤×©×¨ ×œ×”×¡×™×¨
  - any_of: [rom_elbow, tempo]   # ×—×™×™×‘ ×œ×”×™×•×ª ×œ×¤×—×•×ª ××—×“: ROM ××• ×˜××¤×• ×ª×§×™×Ÿ

# ------------------------------------------------------------
# âš–ï¸ SCORING â€” ×›×œ×œ×™ × ×™×§×•×“ + ×—×•×§×™×
# ------------------------------------------------------------
scoring:
  policy:
    missing: skip
    min_criteria_for_full_quality: 3

  criteria:

    # ===== ×‘×˜×™×—×•×ª/×©×œ×™×˜×” (×”×›×™ ×—×©×•×‘×™×) =====
    swing_torso:
      weight: 2.2
      rule:
        kind: jerk_guard
        input: "(torso_forward_vel_deg_s, torso_forward_acc_deg_s2)"
        vel_ok: 35       # deg/s
        acc_ok: 300      # deg/s^2
        allow_bounce: false

    shoulder_stability:
      weight: 2.0
      rule:
        kind: symmetric_threshold
        # ×›×ª×£ ×××•×¨×” ×œ×”×™×©××¨ ×™×¦×™×‘×” ×™×—×¡×™×ª; ×—×¨×™×’×” ××©××¢×•×ª×™×ª ××¨××–×ª ×¢×œ "×’× ×™×‘×”" ××”×›×ª×£
        input: "max(shoulder_left_deg, shoulder_right_deg)"
        ok: 25
        warn: 35
        bad: 45

    # ===== ×˜××¤×• ×•×©×œ×™×˜×” ×‘×”×™×¤×•×š =====
    tempo:
      weight: 1.8
      rule:
        kind: tempo_window
        input: rep.timing_s
        min: 0.7
        max: 2.5
        cutoff_min: 0.5
        cutoff_max: 4.0

    turn_quality:
      weight: 1.6
      rule:
        kind: jerk_guard
        allow_bounce: false
        min_turn_ms: 100

    # ===== ROM ××¨×¤×§ (××©× ×™ ×‘×ª×¨×’×™×œ ×”×–×”) =====
    rom_elbow:
      weight: 1.0
      rule:
        kind: threshold_window
        input: rep.rom      # ROM ×–×•×•×™×ª×™ ×œ×—×–×¨×” (deg) ×›×¤×™ ×©××“×•×•×— ×¢"×™ ×× ×•×¢ ×”×—×–×¨×•×ª
        target_min: 85
        cutoff_min: 70
        direction: higher_is_better

    # ===== ×™×¦×™×‘×•×ª ×›×œ×œ×™×ª =====
    knees_soft:
      weight: 0.5
      rule:
        kind: band_center
        # ×‘×¨×š "×¨×›×”": ×™×¢×“ ×¡×‘×™×‘ 165Â°â€“177Â° (180Â° = × ×¢×™×œ×”; <150Â° = ×›×¤×™×¤×” ×’×“×•×œ×” ××“×™)
        input: "min(knee_left_deg, knee_right_deg)"
        min_ok: 165
        max_ok: 177
        cutoff_min: 150
        cutoff_max: 180

    wrist_neutral:
      weight: 0.4
      rule:
        kind: symmetric_threshold
        input: "max(abs(wrist_flex_ext_left_deg), abs(wrist_flex_ext_right_deg), abs(wrist_radial_ulnar_left_deg), abs(wrist_radial_ulnar_right_deg))"
        ok: 15
        warn: 25
        bad: 35

    grip_width_hook:
      weight: 0.5
      rule:
        kind: passthrough   # ×›××©×¨ ×™×ª×•×•×¡×£ grip_width_px/ratio â€” × ×”×¤×•×š ×œ-band_center

    bottom_pause_penalty:
      weight: 0.4
      rule:
        kind: boolean_flag
        input: "rep.pause_bottom_s > 0.6"
        good_when: false
        penalty: 0.25

    # ===== ×ª×§×¨×•×ª ×‘×˜×™×—×•×ª (× ×¡×¤×¨×™× ×‘××’×¨×’×¦×™×” ×œ××˜×”) =====
    spine_rounding:
      weight: 0.0
      rule:
        kind: symmetric_threshold
        input: spine_flexion_deg
        ok: 10
        warn: 20
        bad: 30

  aggregate:
    method: weighted_mean
    weights_source: inline

  safety_caps:
    - { when: "swing_torso      <= 0.6", cap: 0.85 }
    - { when: "shoulder_stability<= 0.6", cap: 0.88 }
    - { when: "spine_rounding   <= 0.6", cap: 0.90 }

# ------------------------------------------------------------
# ğŸ” ××•×ª ×—×–×¨×” (Rep Signal) â€” Upper (elbow-first) ×¢× Auto-Pick
# ------------------------------------------------------------
rep_signal:
  source: "angle|auto|min"
  candidates:
    upper: ["elbow_left_deg","elbow_right_deg","shoulder_left_deg","shoulder_right_deg"]
  thresholds:
    phase_delta: 5
    min_turn_ms: 100
    min_rep_ms: 500
    max_rep_ms: 6000
    min_rom_good: 70     # ×¢×‘×•×¨ ×—×™×•×•×™ ××™×›×•×ª; ×”×¡×£ ×œ×¦×™×•×Ÿ × ××¦× ×‘-rom_elbow
    min_rom_partial: 55

# ------------------------------------------------------------
# ğŸ”„ ××§×•×¨×•×ª ×’×™×‘×•×™ (×× ×–×•×•×™×•×ª ×œ× ×™×¦×™×‘×•×ª)
# ------------------------------------------------------------
fallback_sources:
  any_of: ["object_y","hands_center_y"]

# ------------------------------------------------------------
# ğŸ“Œ ×”×¢×¨×•×ª ××™××•×©
# â€¢ ××¤×©×¨ ×œ×”×¨×—×™×‘ shoulder_stability ×‘×¢×–×¨×ª ××“×“ ×™×—×¡ ×©×™× ×•×™ ×›×ª×£/××¨×¤×§ (×‘×¢×ª×™×“).
# â€¢ grip_width_hook ×™×•×¤×¢×œ ×›××©×¨ ×™×•×’×“×¨ grip_width_px/ratio ×‘× ×•×¨××œ×™×–×¨.
# â€¢ ×”×”×•×“×¢×•×ª ×™×‘×•××• ×-phrases (namespace: curl.barbell + ×›×œ×œ×™).
# ------------------------------------------------------------
