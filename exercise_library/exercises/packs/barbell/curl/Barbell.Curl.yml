# =====================================================================
# Barbell Curl — Exercise Spec (Hebrew-friendly, no code inside engine)
# תואם aliases.yaml + phrases.yaml (משפחת curl.* והכלליים)
# =====================================================================

id: curl.barbell
display_name: "כפיפות מרפקים עם מוט"
family: curl
variant: barbell
version: 1.0.0
status: stable

detect:
  must_have: [pose.available, objdet.bar_present]   # חובה: גוף + מוט
  nice_to_have: []                                   # אין
  pose_view_preferred: [front, front_left, front_right]
  quality_hints:
    min_pose_confidence: 0.6
    min_person_ratio: 0.25

rep_definition:
  # ספירה מתבצעת רק בתחתית (הארכה) — לא סופרים בחלק העליון
  count_at: bottom_only

  # Ready (התחלה): מותר 175–180°
  ready:
    elbow_ext_ok_deg_min: 175
    elbow_ext_ok_deg_max: 190

  # Start: תחילת תנועה בזווית מרפק
  start:
    elbow_delta_deg_min: 7          # שינוי מינימלי כדי להתחיל חזרה
    window_ms_min: 120              # רצף מינימלי לזיהוי התחלה

  # Turn: היפוך כיוון — יש "החזקת כיוון" קצרה כדי להימנע מבאונס
  turn:
    hold_ms_min: 100                # דיליי מינימלי לאישור היפוך
    jerk_guard_enabled: true

  # Close (סגירת חזרה): בהארכה (למטה) בלבד
  close:
    elbow_ext_deg_min: 160          # אפשר לספור גם ב-160° (לא "מלא", אך נספר)
    count_top: false                # לא סופרים למעלה

  # Timing decomposition (לוג מדדים)
  timing:
    record_ecc_con: true
    record_pauses:  true

targets:
  # Tempo: לפי בקשתך — פחות מ-2.5s נחשב מהיר מדי
  tempo:
    good_min_s: 2.5                 # ≥2.5s טוב
    fast_threshold_s: 2.5           # <2.5s = מהיר
    slow_hint_s: 6.0                # אינדיקציה אינפורמטיבית, לא ענישה קשיחה
  # ROM במרפק: משני; אנשים לרוב מבצעים גדול — נותנים קרדיט חלקי גם אם לא 90°
  rom_elbow:
    flexion_good_deg: 90            # יעד גס לכיפוף
    flexion_min_deg: 70             # מתחת לזה — "קצר"
    extension_full_deg: 170         # "מלא"
    extension_count_min_deg: 160    # ספירה מותרת גם אם לא "מלא"
  # עצירה בתחתית
  pause_bottom:
    penalty_after_s: 1.3            # >1.3s בתחתית — מוריד ציון (מפחית עומס)
  # רוחב אחיזה (יחסי לכתפיים)
  grip_ratio:
    ok_min: 0.9
    ok_max: 1.2

scoring:
  total_points: 10.0

  # חלוקת משקל — דגש על סווינג/כתפיים/טמפו; ROM משני
  criteria:

    - key: torso_swing
      weight: 2.3
      kind: penalty_from_stability
      inputs:
        torso_forward_deg: torso_forward_deg
        torso_forward_vel_deg_s: torso_forward_vel_deg_s
        torso_forward_acc_deg_s2: torso_forward_acc_deg_s2
      logic:
        # אינדקס סווינג מחושב משילוב שינוי זווית + מהירות/תאוצה בעלייה
        swing_turn_phase_bias: true
        swing_warn_delta_deg: 5        # שינוי זווית גו בעלייה >5–8° נחשב חשוד
        swing_warn_vel_abs: 45         # deg/s
        swing_warn_acc_abs: 400        # deg/s^2
      phrases:
        rep_bad: posture.rep_weak

    - key: shoulder_stillness
      weight: 2.1
      kind: penalty_from_drift
      inputs:
        shoulder_left_deg: shoulder_left_deg
        shoulder_right_deg: shoulder_right_deg
        elbow_left_deg: elbow_left_deg
        elbow_right_deg: elbow_right_deg
      logic:
        # פרוקסי ל"גניבה מהכתף": עלייה בזווית כתף ביחס להתקדמות כיפוף מרפק
        drift_ratio_warn: 0.25     # אם תרומת הכתף >25% מתרומת המרפק — הורדה
        drift_ratio_bad:  0.40     # >40% — הורדה חריפה יותר
      phrases:
        rep_bad: curl.common.shoulder_stillness.rep_weak

    - key: tempo
      weight: 2.0
      kind: banded
      inputs:
        rep_timing_s: rep.timing_s
      bands:
        - when: "< 2.5"    # מהיר מדי
          score: 0.35
          flag: flags.rep_quality.fast
          phrase: tempo.rep_fast_short
        - when: ">= 2.5"
          score: 1.0
          phrase: tempo.rep_good

    - key: turn_control
      weight: 1.6
      kind: smooth_turn
      inputs:
        ecc_s: rep.ecc_s
        con_s: rep.con_s
      logic:
        min_hold_ms: 100
        bounce_guard: true
      phrases:
        rep_bad: curl.common.tempo_control.rep_weak

    - key: rom_elbow
      weight: 0.7
      kind: partial_credit
      inputs:
        elbow_min_deg: "min(elbow_left_deg, elbow_right_deg)"   # זווית מינימלית (כיפוף)
        elbow_max_deg: "max(elbow_left_deg, elbow_right_deg)"   # זווית מקסימלית (הארכה)
      credit:
        full_if:
          - elbow_min_deg <= 90
          - elbow_max_deg >= 170
        partial_if:
          - elbow_min_deg <= 100
          - elbow_max_deg >= 160
        none_if:
          - elbow_min_deg > 110
      phrases:
        rep_bad: curl.common.range_of_motion.rep_weak

    - key: knees_soft
      weight: 0.5
      kind: bonus_if
      inputs:
        knee_left_deg: knee_left_deg
        knee_right_deg: knee_right_deg
      logic:
        bonus_if_any_below_deg: 177    # "רכות" = לא נעילה מלאה
        penalize_if_both_above_deg: 179
      phrases:
        rep_bad: curl.common.knees_soft.rep_weak

    - key: grip_width
      weight: 0.5
      kind: ratio_window
      inputs:
        shoulders_width_px: shoulders_width_px
        grip_width_px: grip_width_px   # אופציונלי; אם חסר — ניטרלי
      logic:
        ok_min: 0.9
        ok_max: 1.2
        neutral_if_missing: true
      phrases:
        rep_bad: stance_width.rep_weak   # משתמשים בנוסח כללי "רוחב" (הערה קלה)

    - key: wrist_neutral
      weight: 0.3
      kind: penalty_if
      inputs:
        wrist_flex_ext_left_deg: wrist_flex_ext_left_deg
        wrist_flex_ext_right_deg: wrist_flex_ext_right_deg
      logic:
        warn_abs_deg: 20       # סטייה גדולה -> הורדה קלה
        bad_abs_deg:  30
      phrases:
        rep_bad: curl.common.wrist_position.rep_weak

  # ענישות/תקרות גלובליות (מכפלות)
  global_modifiers:

    # מהירות יתר — פוגע משמעותית
    - when: "rep.timing_s < 2.5"
      apply: "* 0.80"
      phrase: flags.rep_quality.fast

    # עצירה ארוכה בתחתית — פוגע קלות
    - when: "rep.pause_bottom_s > 1.3"
      apply: "* 0.95"
      phrase: tempo_control.rep_weak

  # Caps (תקרות ציון) לפי סיכוני בטיחות
  caps:
    - key: swing_cap
      when_any:
        - "abs(torso_forward_vel_deg_s) > 60 and rep.concentric == true"
        - "(torso_forward_deg_end - torso_forward_deg_start) > 8 and rep.concentric == true"
      cap: 0.85
      phrase: posture.rep_weak

    - key: shoulder_cap
      when_any:
        - "(shoulder_left_deg_end - shoulder_left_deg_start) > 8"
        - "(shoulder_right_deg_end - shoulder_right_deg_start) > 8"
      cap: 0.88
      phrase: curl.common.shoulder_stillness.rep_weak

    - key: spine_rounding_cap
      when: "spine_flexion_deg > 8"
      cap: 0.90
      phrase: spine_rounding.rep_warn_short

feedback:
  # מפות ל־phrases.yaml (he.*)
  good:
    - general.good_rep
  set_good:
    - general.good_set

  hints:
    swing:          posture.rep_weak
    shoulder:       curl.common.shoulder_stillness.rep_weak
    fast:           tempo.rep_fast_short
    bottom_pause:   tempo_control.rep_weak
    knees_soft:     curl.common.knees_soft.rep_hint_short
    wrist:          curl.common.wrist_position.rep_hint_short
    grip:           stance_width.set_weak

  quality_flags:
    fast_rep:       flags.rep_errors.fast_rep
    small_rom:      flags.rep_errors.small_rom
    missing_signal: flags.rep_errors.missing_signal

audit:
  set_visibility:
    enabled: true
    phrases:
      ok: set_visibility_audit.ok
      note: set_visibility_audit.note_medium
      warn: set_visibility_audit.warn_high
    tips:
      - set_visibility_audit.tips.improve_lighting
      - set_visibility_audit.tips.reduce_load
      - set_visibility_audit.tips.more_frames
    stats:
      - set_visibility_audit.stats_hint.visibility_avg
      - set_visibility_audit.stats_hint.max_dt
      - set_visibility_audit.stats_hint.person_ratio

future_notes:
  - "הוספת מדד Object Path: object_x ו-bar.y_px לזיהוי סווינג מדויק."
  - "Shoulder Drift מדויק ביחס למרפק (יחס נגזר, לא רק שינוי מוחלט)."
  - "מדידת grip_width_px אמיתית (לא אמדן), להשוואה ישירה ל-shoulders_width_px."
  - "Adaptive Tempo לפי רמה/עייפות."
  - "Consistency Report (ROM/Tempo) בתוך סט."
