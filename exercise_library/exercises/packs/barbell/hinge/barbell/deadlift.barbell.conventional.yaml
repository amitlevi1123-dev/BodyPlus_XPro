# =============================================================================
# deadlift.barbell.conventional.yaml — דדליפט רגיל עם מוט (Conventional Barbell)
# נתיב: exercises/packs/hinge/barbell/deadlift.barbell.conventional.yaml
# -----------------------------------------------------------------------------
# הווריאנט בנוי מעל hinge.base.yaml:
# • start_mode: from_floor  |  equipment: barbell  |  lockout_mode: full_lockout
# • ROM נמדד מזוויות ירך/גו (לא פיקסלים), עם סף ספירה חלקי/מלא
# • נעילה מלאה מחייבת עצירה קצרה למעלה (≥0.30s) + גב ניטרלי + עקבים במגע
# • משקלי ניקוד 0–2; דגש גבוה על ROM ועל בטיחות עמוד שדרה (spine_rounding)
# =============================================================================

meta:
  id: "deadlift.barbell.conventional"
  family: "hinge"
  display_name: "Deadlift — Barbell (Conventional)"
  selectable: true
  version: 1.0.0

  # מדיניות כללית המגיעה מה-BASE
  lockout_mode: "full_lockout"
  start_mode: "from_floor"
  equipment: "barbell"

  notes: >
    דדליפט קונבנציונלי מהמוט על הרצפה. הווריאנט מנקד חזק את עומק התנועה (ROM
    מזוויות ירך/גו) לצד בטיחות עמוד-השדרה. ציון מלא מתקבל רק כשיש נעילה מלאה
    עם עצירה קצרה למעלה (≥0.30s), גב ניטרלי ויציבה נקייה.

# =============================================================================
# 🧭 רמזים למסווג (Classifier Hints)
# =============================================================================
match_hints:
  must_have: [pose.available]
  any_of: [objdet.bar_present, objdet.object_present]
  ranges:
    objdet.object_kind: ["barbell"]
  pose_view: ["side", "front_left", "front_right"]
  motion_pattern: ["hip_hinge"]
  joints_focus: ["hips", "spine", "knees"]
  weight: 1.0

# =============================================================================
# 🎯 יעדי ROM (מעל ה-base)
# =============================================================================
targets:
  from_floor:
    hip_deg:   62    # יעד ROM בירך לציון 1.0
    torso_deg: 36    # יעד ROM בגו לציון 1.0

# =============================================================================
# ⏱️ חלונות טמפו (הכוונה; הניקוד דרך הקריטריונים)
# =============================================================================
tempo_targets:
  rep_t_s:   [1.2, 4.0]   # זמן חזרה כולל
  ecc_s:     [0.8, 3.0]   # ירידה
  con_s:     [0.6, 2.5]   # עלייה
  pause_bot: [0.0, 0.8]   # סט-אפ קצר מותר
  pause_top: [0.30, 1.0]  # דרישה לעצירה קצרה לנעילה מלאה

# =============================================================================
# 🦶 מנח רגליים (הכוונה; הניקוד דרך הקריטריונים)
# =============================================================================
stance_targets:
  stance_width_ratio: [0.85, 1.15]      # קרוב-לכתפיים
  toe_angle_deg:      [5, 20]           # פישון קל
  knee_toe_alignment_ok_abs_deg: 5      # |סטייה| ≤5° יעד

# =============================================================================
# ⚖️ ניקוד (0–2) — התאמות לווריאנט מעל ה-BASE
# -----------------------------------------------------------------------------
# הדגש המבוקש:
# • ROM זוויתי: גבוה מאוד (1.9)
# • בטיחות עמוד-שדרה (spine_rounding): הגבוה ביותר (2.0)
# שאר המשקלים שמרניים כדי שלא "יעפילו" לחשיבות של ROM/גב.
# =============================================================================
scoring:

  policy:
    missing: skip
    min_criteria_for_full_quality: 3

  criteria:

    # --- בטיחות (הדגשה "קצת יותר" לעיגול גב) ---
    spine_rounding:
      weight: 2.0
      rule:
        kind: symmetric_threshold
        input: spine_flexion_deg
        ok:   8     # ≤8° מצוין
        warn: 15    # 8–15° בינוני
        bad:  25    # ≥25° גרוע

    lateral_bend:
      weight: 1.2
      rule:
        kind: symmetric_threshold
        input: spine_curvature_side_deg
        ok:   5
        warn: 10
        bad:  20

    head_spine:
      weight: 1.0
      rule:
        kind: symmetric_threshold
        input: abs(head_pitch_deg - torso_forward_deg)
        ok:   10
        warn: 20
        bad:  30

    # --- תבנית Hinge (לא סקוואט) ---
    hinge_posture:
      weight: 1.4
      rule:
        kind: linear_band
        input: torso_forward_deg   # הטיה קדימה (יחסית לברך פתוחה) — מדד גנרי
        good_max: 25
        ok_max:   35
        bad_max:  55

    knee_flex_limit:
      weight: 0.8
      rule:
        kind: threshold_window
        input: min(knee_left_deg, knee_right_deg)
        target_min: 100            # "ברך פתוחה" יחסית (גבוה=פתוח)
        cutoff_min:  80
        direction: higher_is_better

    # --- ROM זוויתי (הכי קריטי אחרי גב) ---
    rom_joint:
      weight: 1.9
      rule:
        kind: linear_band
        input: rom_joint_ratio     # min(hip_rom/target_hip, torso_rom/target_torso)
        good_min:   0.95           # 95–100% → עולה ליניארית עד 1.0 (אין "קפיצה" בין 99% ל-100%)
        ok_min:     0.50           # 50–95% → תחום חלקי/בינוני
        cutoff_min: 0.30           # <0.30 → קצר מדי (לא נספר)
        direction: higher_is_better

    # --- שליטה/קצב ---
    phase_control:
      weight: 1.2
      rule:
        kind: tempo_parts_window
        ecc_s: [0.8, 3.0]
        con_s: [0.6, 2.5]
        pause_bottom_s: [0.0, 0.8]
        pause_top_s: [0.0, 1.0]    # ניקוד כללי; דרישת נעילה המינימלית באה במדיניות Lockout

    tempo:
      weight: 0.8
      rule:
        kind: tempo_window
        input: rep.timing_s
        min: 1.2
        max: 4.0
        cutoff_min: 0.6
        cutoff_max: 6.0

    # --- עמידה/רגליים ---
    knee_valgus:
      weight: 1.2
      rule:
        kind: symmetric_threshold
        input: max(abs(knee_foot_alignment_left_deg), abs(knee_foot_alignment_right_deg))
        ok:   5
        warn: 10
        bad:  20

    heels_grounded:
      weight: 0.8
      rule:
        kind: boolean_flag
        input: not heels_grounded
        good_when: false
        penalty: 0.30

    stance_width:
      weight: 0.5
      rule:
        kind: band_center
        input: features.stance_width_ratio
        min_ok: 0.85
        max_ok: 1.15
        cutoff_min: 0.70
        cutoff_max: 1.50

    toe_angle:
      weight: 0.4
      rule:
        kind: symmetric_band_pair
        input: (toe_angle_left_deg, toe_angle_right_deg)
        pair_ok_min: 5
        pair_ok_max: 20
        asymmetry_max: 10
        cutoff_total_max: 40

    # --- איכות היפוך ---
    turn_quality:
      weight: 0.5
      rule:
        kind: turn_guard
        min_turn_ms: 100
        jerk_penalty: 0.20

  aggregate:
    method: weighted_mean
    weights_source: inline

  # תקרות בטיחות מחמירות יחסית (לא מוחקות הישגים אחרים, אבל מגבילות)
  safety_caps:
    - when: "spine_rounding <= 0.6"   # עגילה מורגשת
      cap: 0.80
    - when: "spine_rounding <= 0.4"   # עגילה קשה
      cap: 0.70
    - when: "knee_valgus   <= 0.6"
      cap: 0.90
    - when: "heels_grounded <= 0.5"
      cap: 0.90

# =============================================================================
# 🔁 ספירת חזרות / שער סגירה
# -----------------------------------------------------------------------------
# ספירה נשענת על זוויות (ROM זוויתי). אין "ענישה" על 99% מול 100% — המעבר חלק.
# =============================================================================
rep_counting:
  thresholds:
    min_rom_partial: 0.30
    min_rom_good:    0.50
    min_rep_ms:      500
    max_rep_ms:      6000
    min_turn_ms:     100
  signals:
    prefer_angles: true
    use_object_y_as_aux: true

# =============================================================================
# ✅ מדיניות נעילה (Full Lockout) — מכפילי ציון רכים
# -----------------------------------------------------------------------------
# דרישת עצירה קצרה למעלה כדי לאשר "נעילה מלאה" ולהבדיל ממקרי מאמץ ללא סגירה.
# הפער בין FULL ל-ALMOST גדול, כדי להדגיש את חשיבות הנעילה בדדליפט.
# =============================================================================
policy:
  lockout:
    full:
      hold_s_min: 0.30
      spine_max_deg: 10
      head_line_max_deg: 10
      torso_forward_top_max_deg: 15
      heels_ok: true
      multiplier: 1.00
    almost:
      hold_s_min: 0.15
      spine_max_deg: 10
      head_line_max_deg: 10
      heels_ok: true
      multiplier: 0.65     # פער משמעותי מ-1.00
    clean_no_hold:
      hold_s_min: 0.00
      spine_max_deg: 10
      head_line_max_deg: 10
      heels_ok: true
      multiplier: 0.50
    bad:
      multiplier: 0.30

  # שמירה מפני "החרפת גב" בתחתית (Guard דינמי):
  guards:
    spine_bottom_worsening:
      compare: "spine_flexion_deg@bottom - spine_flexion_deg@setup"
      threshold_deg: 8           # אם החרפה ≥8°, מפחיתים במעט
      multiplier_on_rep: 0.90

# =============================================================================
# 🧮 פוסט-עיבוד ציון (Rep)
# -----------------------------------------------------------------------------
# ציון סופי = ציון ליבה (אחרי safety_caps) × מכפיל נעילה
# =============================================================================
post:
  apply_lockout_policy: true

# =============================================================================
# 📣 חיווט משפטים (phrases)
# =============================================================================
phrases:
  namespace: "hinge.conventional"
  lockout_map:
    full:          "hinge.conventional.lockout.rep_full"
    almost:        "hinge.conventional.lockout.rep_almost"
    clean_no_hold: "hinge.conventional.lockout.rep_no_hold_clean"
    bad:           "hinge.conventional.lockout.rep_bad"
  set_map:
    last_rep_no_full_lockout: "hinge.conventional.set.last_rep_no_full_lockout"
  inherit_common_maps: true  # hinge.common.* (ROM/Turn/Path וכו')

# =============================================================================
# 🧪 בדיקות מומלצות (QA)
# =============================================================================
qa_notes:
  - "השווה סט עם pause_top≈0.35s מול סט עם 0.20s: הציון צריך להיות 1.00 מול 0.65~."
  - "בדוק שחזרה 0.49 ROM לא נספרת, 0.55 נספרת כטובה (בהנחה שהשאר תקין)."
  - "וודא שאין קפיצה בין 0.99 ל-1.00 ב-ROM (מעבר ליניארי חלק)."
  - "בדוק שהcap של spine_rounding מופעל כשעגילה קשה, גם אם שאר המדדים גבוהים."
  - "בדוק שה-guard spine_bottom_worsening מפחית מעט כשבתחתית יש החרפה ביחס ל-setup."
