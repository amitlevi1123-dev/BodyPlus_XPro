# =============================================================================
# ðŸ§  BodyPlus XPro â€” app/runtime/payload.py
# =============================================================================
# ×ž×˜×¨×ª ×”×§×•×‘×¥:
# ×ž× ×”×œ ××ª ×”-"Payload" ×©×œ ×”×ž×¢×¨×›×ª â€” ×–×” ×”××•×‘×™×™×§×˜ (dict) ×©×‘×• × ×©×ž×¨×™× ×›×œ
# ×”× ×ª×•× ×™× ×”×ž×—×•×©×‘×™× ×‘×–×ž×Ÿ ××ž×ª: ×–×•×•×™×•×ª, ×ž×“×“×™×, ××•×‘×™×™×§×˜×™× ×©×–×•×”×•, FPS ×•×›×•â€™.
#
# ×œ×ž×” ×–×” ×‘×˜×•×—:
# ×œ× ×ž×©× ×” ××ª ×ž×‘× ×” ×”-payload, ×¨×§ ×ž×•×¡×™×£ "×¢×˜×™×¤×”" ×©×ž×’×™× ×” ×¢×œ×™×• ×ž×©×™× ×•×™×™×
# ×‘×ž×§×‘×™×œ (thread-safe). ×–××ª ××•×ž×¨×ª, ×’× ×× Thread ×©×œ Flask ×•×’× Thread ×©×œ
# ×ž×¦×œ×ž×” × ×™×’×©×™× ×œ× ×ª×•× ×™× ×™×—×“ â€” ××™×Ÿ ×¡×™×›×•×Ÿ ×œ×©×’×™××ª race.
#
# ×©×™×ž×•×©:
# ×‘×ž×§×•× ×œ×”×—×–×™×§ self._payload ×•-self._pl_lock ×‘×ª×•×š ×”-App,
# ×ž×©×ª×ž×©×™× ×‘×ž×—×œ×§×” PayloadManager:
#
#     self.payload_mgr = PayloadManager()
#     self.payload_mgr.set({...})
#     data = self.payload_mgr.get()
#
# ×©×ª×™ ×”×¤×•× ×§×¦×™×•×ª ×”×™×©× ×•×ª _payload_set / _payload_get × ×©××¨×•×ª, ×›×“×™ ×©×›×œ
# ×©××¨ ×”×§×•×“ ×™×ž×©×™×š ×œ×¢×‘×•×“ ×‘×“×™×•×§ ××•×ª×• ×“×‘×¨.
# =============================================================================

from __future__ import annotations
import threading
from typing import Dict, Any


class PayloadManager:
    """
    ×ž×—×œ×§×” ×œ× ×™×”×•×œ ×”-Payload ×¢× ×ž× ×’× ×•×Ÿ × ×¢×™×œ×” (Lock)
    ×›×“×™ ×œ×ž× ×•×¢ ×”×ª× ×’×©×•×™×•×ª ×‘×–×ž×Ÿ ×¨×™×‘×•×™ ×©×¨×©×•×¨×™×.
    """

    def __init__(self) -> None:
        # × ×¢×™×œ×” ××—×ª ×‘×œ×‘×“ ×œ×›×œ ×”×ž×™×“×¢
        self._lock = threading.Lock()
        # ×›××Ÿ × ×©×ž×¨ ×”-Payload ×¢×¦×ž×• (dictionary)
        self._data: Dict[str, Any] = {}

    def set(self, payload: Dict[str, Any]) -> None:
        """×ž×—×œ×™×£ ××ª ×›×œ ×”-Payload ×‘×‘×ª ××—×ª."""
        with self._lock:
            self._data = payload

    def get(self) -> Dict[str, Any]:
        """×ž×—×–×™×¨ ×¢×•×ª×§ ×©×œ ×”-Payload ×”× ×•×›×—×™ ×œ×§×¨×™××” ×‘×œ×‘×“."""
        with self._lock:
            # dict() ×™×•×¦×¨ ×¢×•×ª×§ ×—×“×© ×›×“×™ ×©×ž×™ ×©×§×•×¨× ×œ× ×™×©× ×” ×‘×˜×¢×•×ª
            return dict(self._data)

    def update(self, patch: Dict[str, Any]) -> None:
        """×ž×¢×“×›×Ÿ ×¨×§ ×—×œ×§ ×ž×”-Keys ×‘×ª×•×š ×”-Payload."""
        with self._lock:
            self._data.update(patch)
