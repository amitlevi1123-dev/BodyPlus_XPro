{% extends "base.html" %}
{% block title %}×•×™×“××• â€” ×¡×˜×¨×™× + Capture Â· BodyPlus XPro{% endblock %}
{% block page_title %}ğŸ¥ ×•×™×“××• (×¡×˜×¨×™× + ×©×™×“×•×¨ ×“×¤×“×¤×Ÿ){% endblock %}

{% block head %}
<style>
  .card{background:#fff;border:1px solid #e5e7eb;border-radius:1rem}
  .card-h{padding:.9rem 1.1rem;border-bottom:1px solid #eef2f7}
  .card-b{padding:1rem 1.1rem}
  .metric{background:#f8fafc;border:1px solid #e5e7eb;border-radius:.8rem;padding:.65rem}
  .metric .v{font-size:18px;font-weight:700;color:#111827}
  .metric .k{font-size:12px;color:#64748b}
  .status-dot{width:10px;height:10px;border-radius:9999px;background:#94a3b8;display:inline-block}
  .status-dot.ok{background:#22c55e}.status-dot.warn{background:#f59e0b}.status-dot.err{background:#ef4444}
  .form{border:1px solid #e5e7eb;border-radius:.6rem;padding:.45rem .6rem}

  /* ××‘×˜×™×— ×©×”×§× ×‘×¡ ×™×”×™×” ××¢×œ ×”×ª××•× ×” ×’× ×× ×”-JS × ×˜×¢×Ÿ ××—×¨×™ */
  #vs-canvas{
    position:absolute;left:0;top:0;width:100%;height:100%;
    pointer-events:none;display:block;
  }
</style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto space-y-6" dir="rtl">

  <!-- A) ×¡×˜×¨×™× MJPEG (××§×•×¨ ×™×—×™×“ ×œ×›×œ ×”××¢×¨×›×ª) -->
  <section class="card">
    <div class="card-h flex items-center justify-between">
      <div class="font-semibold">×–×¨× ×•×™×“××• ××”×©×¨×ª (MJPEG)</div>
      <div class="text-sm text-gray-500 flex items-center gap-3">
        <span>××§×•×¨: <b data-id="v-source">â€”</b></span>
        <span id="vs-dot" class="status-dot" title="×—×™×‘×•×¨"></span>
        <span id="vs-txt">â€”</span>
      </div>
    </div>

    <div class="card-b space-y-3">
      <!-- ×¤×¡ ×‘×§×¨×•×ª ×œ×¡×˜×¨×™× -->
      <div class="flex flex-wrap items-end gap-3 text-sm">
        <div class="flex flex-col">
          <label class="text-gray-600 mb-1">HUD ×‘×¡×˜×¨×™×</label>
          <label class="inline-flex items-center gap-2">
            <input id="vs-hud" type="checkbox" class="scale-110">
            <span>×”×¦×’ HUD</span>
          </label>
        </div>

        <div class="flex flex-col">
          <label class="text-gray-600 mb-1">×”×ª×××ª ×ª×¦×•×’×”</label>
          <select id="vs-fit" class="form">
            <option value="contain" selected>Contain (×©×•××¨ ×™×—×¡)</option>
            <option value="cover">Cover (×××œ× ××–×•×¨)</option>
            <option value="fill">Fill</option>
          </select>
        </div>

        <a class="ml-auto px-3 py-2 rounded-lg bg-gray-50 hover:bg-gray-100 text-sm"
           href="/video/stream.mjpg?hud=1" target="_blank" rel="noopener">×¤×ª×— ×¡×˜×¨×™× â†—</a>
      </div>

      <!-- ×—×œ×•×Ÿ ×”×¡×˜×¨×™× (×§× ×‘×¡ × ×•×¦×¨ ××•×˜×•××˜×™×ª ×¢"×™ ×”-JS ×•××ª×•×•×¡×£ ×œ×ª×•×š ×”×§×•× ×˜×™×™× ×¨) -->
      <div class="relative w-full bg-black rounded-xl overflow-hidden" style="height:420px;">
        <img id="vs-img" src="" class="absolute inset-0 w-full h-full object-contain select-none" alt="MJPEG">
        <!-- ×§× ×‘×¡ ×™×“× ×™ ×œ×’×™×‘×•×™; ×”-JS ×™××ª×¨ ××•×ª×• ××• ×™×™×¦×•×¨ ×—×“×© ×× ×—×¡×¨ -->
        <canvas id="vs-canvas" aria-hidden="true"></canvas>
        <div id="vs-ph" class="absolute inset-0 flex items-center justify-center text-gray-300 text-sm">
          ××™×Ÿ ×–×¨× ×¤×¢×™×œ
        </div>
      </div>
      <div class="text-xs text-gray-500">×˜×™×¤: ×× HUD ××¡×•××Ÿ â€“ ×”-URL ×™×ª×¢×“×›×Ÿ ×¢× <code>?hud=1</code>.</div>
    </div>
  </section>

  <!-- B) Capture (×©×™×“×•×¨ ××”×“×¤×“×¤×Ÿ â†’ /api/ingest_frame) -->
  <section class="card">
    <div class="card-h font-semibold">×©×™×“×•×¨ ××”×“×¤×“×¤×Ÿ (Capture â†’ /api/ingest_frame)</div>
    <div class="card-b grid grid-cols-1 lg:grid-cols-3 gap-4">
      <!-- ×‘×§×¨×” -->
      <div class="space-y-3">
        <div class="grid grid-cols-2 gap-3 text-sm">
          <label class="flex flex-col gap-1">××¦×œ××”
            <select id="cap-camera" class="form"></select>
          </label>
          <label class="flex flex-col gap-1">×¨×–×•×œ×•×¦×™×”
            <select id="cap-res" class="form">
              <option value="640x360">640Ã—360</option>
              <option value="1280x720" selected>1280Ã—720</option>
              <option value="1920x1080">1920Ã—1080</option>
            </select>
          </label>
          <label class="flex flex-col gap-1">FPS ×©×™×“×•×¨
            <input id="cap-fps" type="number" min="1" max="60" value="15" class="form">
          </label>
          <label class="flex flex-col gap-1">JPEG Q (40â€“95)
            <input id="cap-jpgq" type="number" min="40" max="95" value="80" class="form">
          </label>
          <label class="flex items-center gap-2 col-span-2">
            <input id="cap-mirror" type="checkbox" class="scale-110" checked> ××¨××” (Mirror)
          </label>
          <label class="flex flex-col gap-1 col-span-2">Token (××•×¤×¦×™×•× ×œ×™)
            <input id="cap-token" type="text" placeholder="X-Ingest-Token" class="form">
          </label>
        </div>

        <div class="flex items-center gap-2">
          <button id="cap-start" class="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 text-sm">×”×ª×—×œ ×©×™×“×•×¨</button>
          <button id="cap-stop"  class="px-4 py-2 rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300 text-sm" disabled>×¢×¦×•×¨</button>
        </div>

        <label class="flex items-center gap-2">
          <input id="cap-show-preview" type="checkbox" class="scale-110" checked>
          ×”×¦×’ ×¤×¨×™×•×•×™×• Capture
        </label>

        <div id="cap-err" class="text-sm text-red-600 hidden"></div>
        <div class="grid grid-cols-2 gap-3 text-xs text-gray-600">
          <div>Tx FPS: <b id="cap-txfps">0.0</b></div>
          <div>Latency (ms): <b id="cap-lat">â€“</b></div>
          <div>×¨×–×•×œ×•×¦×™×”: <b id="cap-reslbl">â€“</b></div>
          <div>× ×©×œ×—×• ×¤×¨×™×™××™×: <b id="cap-sent">0</b></div>
        </div>
      </div>

      <!-- ×¤×¨×™×•×•×™×• Capture -->
      <div class="lg:col-span-2">
        <div class="relative bg-black rounded-xl overflow-hidden" style="height:360px;">
          <video id="cap-video" autoplay playsinline muted class="absolute inset-0 w-full h-full object-contain"></video>
          <canvas id="cap-canvas" class="hidden"></canvas>
          <div id="cap-hud" class="absolute top-2 left-2 bg-black/50 text-white text-xs rounded px-2 py-1 border border-white/10">
            <b>Capture</b> â€” <span id="cap-state">IDLE</span>
          </div>
        </div>
        <p class="text-xs text-gray-500 mt-2">
          â€œ×”×ª×—×œ ×©×™×“×•×¨â€ ×™×©×œ×— JPEG ××œ <code>/api/ingest_frame</code>. ×—×œ×•×Ÿ ×”-MJPEG ×œ××¢×œ×” ×™×ª×¢×“×›×Ÿ.
        </p>
      </div>
    </div>
  </section>

  <!-- C) ×¡×˜×˜×•×¡/Health/Payload -->
  <section id="video-status-widget" class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <div class="card p-4">
      <h4 class="font-semibold mb-3">×¡×˜×˜×•×¡ ×•×™×“××•</h4>
      <dl class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm">
        <dt class="text-gray-500">××¦×‘:</dt><dd data-id="v-state" class="font-medium">â€”</dd>
        <dt class="text-gray-500">×¨×¥:</dt><dd data-id="v-running">â€”</dd>
        <dt class="text-gray-500">FPS:</dt><dd data-id="v-fps">â€”</dd>
        <dt class="text-gray-500">×’×•×“×œ ×¤×¨×™×™×:</dt><dd data-id="v-size">â€”</dd>
        <dt class="text-gray-500">age(ms):</dt><dd data-id="v-age">â€”</dd>
        <dt class="text-gray-500">×©×’×™××”:</dt><dd data-id="v-error" class="text-red-600">â€”</dd>
        <dt class="text-gray-500">×¢×•×“×›×Ÿ:</dt><dd data-id="v-updated">â€”</dd>
      </dl>
    </div>
    <div class="card p-4">
      <h4 class="font-semibold mb-3">×‘×¨×™××•×ª ×”×©×¨×ª</h4>
      <dl class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm">
        <dt class="text-gray-500">/healthz:</dt><dd data-id="h-ok">â€”</dd>
        <dt class="text-gray-500">×’×¨×¡×”:</dt><dd data-id="h-ver">â€”</dd>
        <dt class="text-gray-500">×©×¢×ª ×©×¨×ª:</dt><dd data-id="h-now">â€”</dd>
        <dt class="text-gray-500">Uptime(sec):</dt><dd data-id="h-uptime">â€”</dd>
      </dl>
      <p class="text-xs text-gray-500 mt-2">×¨×¢× ×•×Ÿ ~1.5 ×©× ×™×•×ª.</p>
    </div>
    <div class="card p-4">
      <h4 class="font-semibold mb-3">Payload (×ª×§×¦×™×¨)</h4>
      <dl class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm">
        <dt class="text-gray-500">×’×¨×¡×ª payload:</dt><dd data-id="p-ver">â€”</dd>
        <dt class="text-gray-500">timestamp:</dt><dd data-id="p-ts">â€”</dd>
        <dt class="text-gray-500">objdet.objects:</dt><dd data-id="p-obj">â€”</dd>
        <dt class="text-gray-500">objdet.tracks:</dt><dd data-id="p-trk">â€”</dd>
        <dt class="text-gray-500">mp.landmarks:</dt><dd data-id="p-lms">â€”</dd>
        <dt class="text-gray-500">fps:</dt><dd data-id="p-fps">â€”</dd>
      </dl>
      <details class="mt-3">
        <summary class="text-xs text-gray-500 cursor-pointer">JSON ××œ×</summary>
        <pre data-id="p-json" class="text-xs bg-gray-50 border rounded p-2 overflow-auto max-h-56 whitespace-pre-wrap">â€”</pre>
      </details>
    </div>
  </section>
</div>
{% endblock %}

{% block scripts %}
<script defer src="{{ url_for('static', filename='js/video_stream.js') }}?v={{ app_version|default('dev', true) }}"></script>
<script defer src="{{ url_for('static', filename='js/capture_sender.js') }}?v={{ app_version|default('dev', true) }}"></script>

<!-- Poll ×§×˜×Ÿ ×œ×¡×˜×˜×•×¡×™× ×•×œ-Payload -->
<script>
(function () {
  'use strict';
  const $ = s => document.querySelector(s);
  function set(el, v){ if (el) el.textContent = (v==null?'â€”':v); }
  function setStateColor(ageMs, running){
    const dot = document.getElementById('vs-dot');
    if (!dot) return;
    dot.classList.remove('ok','warn','err');
    if (!running || ageMs >= 7000) dot.classList.add('err');
    else if (ageMs >= 2000)        dot.classList.add('warn');
    else                           dot.classList.add('ok');
  }
  async function getJson(url){
    try{ const r = await fetch(url,{cache:'no-store'}); if(!r.ok) return null; return await r.json(); }catch(_){ return null; }
  }
  async function refresh(){
    const s = await getJson('/api/video/status');
    if (s){
      set(document.querySelector('[data-id="v-source"]'), s.active_source || 'none');
      set(document.querySelector('[data-id="v-state"]'),  s.active_source ? 'ACTIVE' : 'IDLE');
      set(document.querySelector('[data-id="v-running"]'), s.running ? '×›×Ÿ' : '×œ×');
      set(document.querySelector('[data-id="v-fps"]'),    s.fps!=null ? (s.fps.toFixed ? s.fps.toFixed(1) : s.fps) : 'â€”');
      set(document.querySelector('[data-id="v-size"]'),   Array.isArray(s.size)? (s.size[0]+'Ã—'+s.size[1]) : 'â€”');
      const age = (s.frame && s.frame.age_ms) || (s.age_ms) || null;
      set(document.querySelector('[data-id="v-age"]'), age);
      set(document.querySelector('[data-id="v-error"]'), s.error || (s.errors && s.errors.last) || 'â€”');
      set(document.querySelector('[data-id="v-updated"]'), new Date().toLocaleTimeString());
      const txt = document.getElementById('vs-txt'); if (txt) txt.textContent = (s.running && age<7000)? '×–×¨× ×¤×¢×™×œ' : '××™×Ÿ ×–×¨×';
      setStateColor(age||99999, !!s.running);
    }
    const p = await getJson('/api/payload_last');
    if (p){
      set(document.querySelector('[data-id="p-ver"]'), p.version || p.payload_version || 'â€”');
      set(document.querySelector('[data-id="p-ts"]'),  p.ts || p.timestamp || 'â€”');
      set(document.querySelector('[data-id="p-obj"]'), p.objdet && p.objdet.objects!=null ? p.objdet.objects : 'â€”');
      set(document.querySelector('[data-id="p-trk"]'), p.objdet && p.objdet.tracks!=null ? p.objdet.tracks : 'â€”');
      set(document.querySelector('[data-id="p-lms"]'), p.mp && p.mp.landmarks!=null ? p.mp.landmarks : 'â€”');
      set(document.querySelector('[data-id="p-fps"]'), p.fps!=null ? p.fps : 'â€”');
      const pre = document.querySelector('[data-id="p-json"]'); if (pre) pre.textContent = JSON.stringify(p,null,2);
    }
    const h = await getJson('/healthz');
    if (h){
      set(document.querySelector('[data-id="h-ok"]'),  'OK');
      set(document.querySelector('[data-id="h-ver"]'), h.version || 'â€”');
      set(document.querySelector('[data-id="h-now"]'), h.now || 'â€”');
      set(document.querySelector('[data-id="h-uptime"]'), h.uptime_sec!=null ? h.uptime_sec : 'â€”');
    } else {
      set(document.querySelector('[data-id="h-ok"]'), 'â€”');
    }
  }
  setInterval(refresh, 1500);
  refresh();
})();
</script>
{% endblock %}
