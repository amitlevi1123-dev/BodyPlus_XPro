{% extends "base.html" %}
{% block title %}×•×™×“××• â€” ×¡×˜×¨×™× + Capture{% endblock %}
{% block page_title %}ğŸ¥ ×•×™×“××• ××•×–×¨× + ×©×™×“×•×¨ ××”×“×¤×“×¤×Ÿ{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto space-y-6" dir="rtl">

  <!-- ×ª×¦×•×’×ª ×”×¡×˜×¨×™× (MJPEG) - ×—×œ×•×Ÿ ×™×—×™×“ -->
  <section class="bg-white rounded-2xl shadow p-4">
    <div class="flex items-center justify-between mb-3">
      <h3 class="font-semibold text-lg">×–×¨× ×•×™×“××• ××”×©×¨×ª (MJPEG)</h3>
      <div class="flex items-center gap-2">
        <span id="dotConnected" class="inline-block w-2.5 h-2.5 rounded-full bg-gray-300" title="×—×™×‘×•×¨"></span>
        <span id="txtConnected" class="text-sm text-gray-600">â€”</span>
      </div>
    </div>

    <div class="relative w-full bg-black rounded-xl overflow-hidden" style="height:420px;">
      <img id="video-stream"
           src=""
           class="absolute inset-0 w-full h-full object-contain select-none"
           alt="×•×™×“××• ××•×–×¨× (×©×¨×ª)">
      <div id="video-placeholder"
           class="absolute inset-0 flex items-center justify-center text-gray-300 text-sm text-center">
        ××™×Ÿ ×›×¨×’×¢ ×–×¨× ×•×™×“××• ×¤×¢×™×œ
      </div>
    </div>

    <div class="flex items-center gap-2 mt-3">
      <button type="button" class="px-3 py-2 rounded-lg bg-gray-100 hover:bg-gray-200 text-sm"
              onclick="window.useCameraStream && window.useCameraStream()">××§×•×¨: ××¦×œ××”</button>
      <button type="button" class="px-3 py-2 rounded-lg bg-gray-100 hover:bg-gray-200 text-sm"
              onclick="window.useFileStream && window.useFileStream()">××§×•×¨: ×§×•×‘×¥</button>
      <a class="px-3 py-2 rounded-lg bg-gray-50 hover:bg-gray-100 text-sm"
         href="/video/stream.mjpg?hud=1" target="_blank" rel="noopener">×¤×ª×— ×¡×˜×¨×™× ×‘×˜××‘ â†—</a>
    </div>
  </section>

  <!-- ×¤× ×œ Capture (×©×™×“×•×¨ ××”×“×¤×“×¤×Ÿ â†’ /api/ingest_frame) -->
  <section class="bg-white rounded-2xl shadow p-4">
    <h4 class="font-semibold mb-3">×©×™×“×•×¨ ××”×“×¤×“×¤×Ÿ (Capture â†’ /api/ingest_frame)</h4>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
      <!-- ×‘×§×¨×” -->
      <div class="lg:col-span-1 space-y-3">
        <div class="grid grid-cols-2 gap-3 text-sm">
          <label class="flex flex-col gap-1">
            ××¦×œ××”
            <select id="cap-camera" class="border rounded px-2 py-1"></select>
          </label>
          <label class="flex flex-col gap-1">
            ×¨×–×•×œ×•×¦×™×”
            <select id="cap-res" class="border rounded px-2 py-1">
              <option value="640x360">640Ã—360</option>
              <option value="1280x720" selected>1280Ã—720</option>
              <option value="1920x1080">1920Ã—1080</option>
            </select>
          </label>
          <label class="flex flex-col gap-1">
            FPS ×©×™×“×•×¨
            <input id="cap-fps" type="number" min="1" max="60" value="15" class="border rounded px-2 py-1">
          </label>
          <label class="flex flex-col gap-1">
            JPEG Q (40â€“95)
            <input id="cap-jpgq" type="number" min="40" max="95" value="80" class="border rounded px-2 py-1">
          </label>
          <label class="flex items-center gap-2 col-span-2">
            <input id="cap-mirror" type="checkbox" class="scale-110" checked>
            ××¨××” (Mirror)
          </label>
          <label class="flex flex-col gap-1 col-span-2">
            Token (××•×¤×¦×™×•× ×œ×™)
            <input id="cap-token" type="text" placeholder="X-Ingest-Token" class="border rounded px-2 py-1">
          </label>
        </div>

        <div class="flex items-center gap-2">
          <button id="cap-start" class="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 text-sm">×”×ª×—×œ ×©×™×“×•×¨</button>
          <button id="cap-stop"  class="px-4 py-2 rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300 text-sm" disabled>×¢×¦×•×¨</button>
        </div>

        <div id="cap-err" class="text-sm text-red-600 hidden"></div>

        <div class="grid grid-cols-2 gap-3 text-xs text-gray-600">
          <div>Tx FPS: <b id="cap-txfps">0.0</b></div>
          <div>Latency (ms): <b id="cap-lat">â€“</b></div>
          <div>×¨×–×•×œ×•×¦×™×”: <b id="cap-reslbl">â€“</b></div>
          <div>× ×©×œ×—×• ×¤×¨×™×™××™×: <b id="cap-sent">0</b></div>
        </div>
      </div>

      <!-- ×ª×¦×•×’×ª Capture ××§×•××™×ª -->
      <div class="lg:col-span-2">
        <div class="relative bg-black rounded-xl overflow-hidden" style="height:360px;">
          <video id="cap-video" autoplay playsinline muted class="absolute inset-0 w-full h-full object-contain"></video>
          <canvas id="cap-canvas" class="hidden"></canvas>
          <div id="cap-hud"
               class="absolute top-2 left-2 bg-black/50 text-white text-xs rounded px-2 py-1 border border-white/10">
            <b>Capture</b> â€” <span id="cap-state">IDLE</span>
          </div>
        </div>
        <p class="text-xs text-gray-500 mt-2">
          â€œ×”×ª×—×œ ×©×™×“×•×¨â€ ×™×©×œ×— ×¤×¨×™×™××™× ×‘×ª×•×¨ JPEG ××œ <code>/api/ingest_frame</code>. ×”Ö¾IMG ×œ××¢×œ×”, ×©××¦×™×’ <code>/video/stream.mjpg</code>, ×™×ª×¢×“×›×Ÿ (×›×•×œ×œ HUD ×× ××•×¤×¢×œ).
        </p>
      </div>
    </div>
  </section>

  <!-- ×¡×˜×˜×•×¡/×‘×¨×™××•×ª/×¤×™×™×¤×œ×™×™×Ÿ -->
  <section id="video-status-widget" class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <div class="bg-white rounded-2xl shadow p-4">
      <h4 class="font-semibold mb-3">×¡×˜×˜×•×¡ ×•×™×“××•</h4>
      <dl class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm">
        <dt class="text-gray-500">××¦×‘:</dt>                <dd data-id="v-state"   class="font-medium">â€”</dd>
        <dt class="text-gray-500">×¤×ª×•×— (opened):</dt>      <dd data-id="v-opened">â€”</dd>
        <dt class="text-gray-500">×¨×¥ (running):</dt>       <dd data-id="v-running">â€”</dd>
        <dt class="text-gray-500">FPS:</dt>                <dd data-id="v-fps">â€”</dd>
        <dt class="text-gray-500">×’×•×“×œ ×¤×¨×™×™×:</dt>        <dd data-id="v-size">â€”</dd>
        <dt class="text-gray-500">××§×•×¨:</dt>              <dd data-id="v-source">â€”</dd>
        <dt class="text-gray-500">××¦×‘ ×ª××•×¨×”:</dt>         <dd data-id="v-light">â€”</dd>
        <dt class="text-gray-500">×—×œ×•×Ÿ Preview ×¤×ª×•×—:</dt> <dd data-id="v-preview">â€”</dd>
        <dt class="text-gray-500">×©×’×™××” ××—×¨×•× ×”:</dt>      <dd data-id="v-error" class="text-red-600">â€”</dd>
        <dt class="text-gray-500">×¢×•×“×›×Ÿ:</dt>              <dd data-id="v-updated">â€”</dd>
      </dl>
    </div>

    <div class="bg-white rounded-2xl shadow p-4">
      <h4 class="font-semibold mb-3">×‘×¨×™××•×ª ×”×©×¨×ª</h4>
      <dl class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm">
        <dt class="text-gray-500">/healthz:</dt>      <dd data-id="h-ok">â€”</dd>
        <dt class="text-gray-500">×’×¨×¡×ª ××¤×œ×™×§×¦×™×”:</dt><dd data-id="h-ver">â€”</dd>
        <dt class="text-gray-500">×©×¢×ª ×©×¨×ª:</dt>       <dd data-id="h-now">â€”</dd>
        <dt class="text-gray-500">×–××Ÿ ×¨×™×¦×” (sec):</dt><dd data-id="h-uptime">â€”</dd>
      </dl>
      <p class="text-xs text-gray-500 mt-2">× ×¨×¢× ×Ÿ ×›×œ ~1.5 ×©× ×™×•×ª.</p>
    </div>

    <div class="bg-white rounded-2xl shadow p-4">
      <h4 class="font-semibold mb-3">Payload (×ª×§×¦×™×¨)</h4>
      <dl class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm">
        <dt class="text-gray-500">×’×¨×¡×ª payload:</dt> <dd data-id="p-ver">â€”</dd>
        <dt class="text-gray-500">timestamp:</dt>     <dd data-id="p-ts">â€”</dd>
        <dt class="text-gray-500">objdet.objects:</dt><dd data-id="p-obj">â€”</dd>
        <dt class="text-gray-500">objdet.tracks:</dt> <dd data-id="p-trk">â€”</dd>
        <dt class="text-gray-500">mp.landmarks:</dt>  <dd data-id="p-lms">â€”</dd>
        <dt class="text-gray-500">fps (×× ×§×™×™×):</dt> <dd data-id="p-fps">â€”</dd>
      </dl>
      <details class="mt-3">
        <summary class="text-xs text-gray-500 cursor-pointer">JSON ××œ×</summary>
        <pre data-id="p-json" class="text-xs bg-gray-50 border rounded p-2 overflow-auto max-h-56 whitespace-pre-wrap">â€”</pre>
      </details>
    </div>
  </section>
</div>
{% endblock %}

{% block scripts %}
  <!-- ××•×ª×• ×§×•×‘×¥ JS (×”×©× × ×©××¨) -->
  <script defer src="{{ url_for('static', filename='js/video_stream.js') }}?v={{ app_version|default('dev', true) }}"></script>

  <!-- ×•×•×™×“×’×³×˜ ×¡×˜×˜×•×¡/×‘×¨×™××•×ª/×¤×™×™×¤×œ×™×™×Ÿ -->
  <script>
  (function(){
    'use strict';
    const root = document.getElementById('video-status-widget');
    if (!root) return;

    const q   = (key) => root.querySelector('[data-id="'+key+'"]');
    const set = (key, val) => { const el = q(key); if (el) el.textContent = (val ?? 'â€”'); };

    async function fetchJson(url, timeoutMs){
      const ctrl = new AbortController();
      const t = setTimeout(()=>ctrl.abort(), timeoutMs||4000);
      try{
        const r = await fetch(url, { cache:'no-store', signal: ctrl.signal });
        if(!r.ok) throw new Error('HTTP '+r.status);
        return await r.json();
      }catch(_){ return null; } finally{ clearTimeout(t); }
    }

    function setVideoState(s){
      set('v-state',   s?.state || 'â€”');
      set('v-opened',  String(!!s?.opened));
      set('v-running', String(!!s?.running));
      set('v-fps',     (s?.fps ?? 'â€”'));
      set('v-size',    (Array.isArray(s?.size) && s.size.length===2) ? (s.size[0]+'Ã—'+s.size[1]) : 'â€”');
      set('v-source',  s?.source || 'â€”');
      set('v-light',   s?.light_mode || 'â€”');
      set('v-preview', String(!!s?.preview_window_open));
      set('v-error',   (s?.error ? String(s.error).trim() : 'â€”'));
      set('v-updated', new Date().toLocaleTimeString());
    }

    function setHealth(h){
      set('h-ok', (h && (h.ok===true || h.ok==='true')) ? 'OK' : 'NOT OK');
      set('h-ver', h?.ver || h?.version || '{{ app_version|default("dev", true) }}');
      set('h-now', h?.now ? new Date((h.now*1000)||Date.now()).toLocaleTimeString() : new Date().toLocaleTimeString());
      const up = (h?.uptime_sec ?? h?.uptime);
      set('h-uptime', Number.isFinite(up) ? String(up) : 'â€”');
    }

    function setPayload(p){
      p = p || {};
      set('p-ver', p.payload_version ?? 'â€”');
      set('p-ts',  p.ts ? String(p.ts) : 'â€”');
      const od   = (p.objdet && typeof p.objdet==='object') ? p.objdet : {};
      const objs = Array.isArray(od.objects) ? od.objects.length : 0;
      const trks = Array.isArray(od.tracks)  ? od.tracks.length  : 0;
      const mp   = (p.mp && typeof p.mp==='object') ? p.mp : {};
      const lms  = Array.isArray(mp.landmarks) ? mp.landmarks.length : 0;
      set('p-obj', String(objs));
      set('p-trk', String(trks));
      set('p-lms', String(lms));
      set('p-fps', (p.fps ?? p?.meta?.fps_est ?? 'â€”'));
      const pre = q('p-json'); if (pre) { try{ pre.textContent = JSON.stringify(p, null, 2); }catch(_){ pre.textContent='â€”'; } }
    }

    async function tick(){
      const st = await fetchJson('/api/video/status', 3000); if (st) setVideoState(st);
      const h  = await fetchJson('/healthz', 3000);          if (h)  setHealth(h);
      const p  = await fetchJson('/payload', 3000);          if (p)  setPayload(p);
    }

    tick();
    setInterval(tick, 1500);
  })();
  </script>
{% endblock %}
