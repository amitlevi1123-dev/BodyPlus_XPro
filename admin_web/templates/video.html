{% extends "base.html" %}
{% block title %}×•×™×“××• ××•×–×¨× â€” ××™× ×“×™×§×¦×™×•×ª{% endblock %}
{% block page_title %}ğŸ¥ ×•×™×“××• ××•×–×¨× â€” ××™× ×“×™×§×¦×™×•×ª ××œ××•×ª{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto space-y-6" dir="rtl">

  <!-- ×ª×¦×•×’×ª ×”×•×•×™×“××• (××•×§×˜×Ÿ ×œ×’×•×‘×” ×§×‘×•×¢) -->
  <section class="bg-white rounded-2xl shadow p-4">
    <div class="flex items-center justify-between mb-3">
      <h3 class="font-semibold text-lg">×–×¨× ×•×™×“××• ××”×©×¨×ª (MJPEG)</h3>
      <div class="flex items-center gap-2">
        <span id="dotConnected" class="inline-block w-2.5 h-2.5 rounded-full bg-gray-300" title="×—×™×‘×•×¨"></span>
        <span id="txtConnected" class="text-sm text-gray-600">â€”</span>
      </div>
    </div>

    <!-- ×’×•×‘×” ×§×‘×•×¢ ~420px -->
    <div class="relative w-full bg-black rounded-xl overflow-hidden" style="height:420px;">
      <img id="video-stream"
           src=""
           class="absolute inset-0 w-full h-full object-contain select-none"
           alt="×•×™×“××• ××•×–×¨× (×©×¨×ª)">
      <div id="video-placeholder"
           class="absolute inset-0 flex items-center justify-center text-gray-300 text-sm text-center">
        ××™×Ÿ ×›×¨×’×¢ ×–×¨× ×•×™×“××• ×¤×¢×™×œ
      </div>
    </div>
  </section>

  <!-- ×œ×•×— ×©×œ×™×˜×” ×‘×¢×•××¡×™×/××™×›×•×ª (×¤×¨×•×¤×™×œ×™× + ×™×“× ×™) -->
  <section class="bg-white rounded-2xl shadow p-4">
    <h4 class="font-semibold mb-3">×©×œ×™×˜×” ×‘×¢×•××¡/××™×›×•×ª</h4>

    <!-- ×¤×¨×•×¤×™×œ×™× ××”×™×¨×™× -->
    <div class="flex flex-wrap gap-2 mb-4">
      <button type="button" class="px-3 py-2 rounded-lg bg-gray-100 hover:bg-gray-200 text-sm" data-profile="Eco">Eco (×—×¡×›×•× ×™)</button>
      <button type="button" class="px-3 py-2 rounded-lg bg-gray-100 hover:bg-gray-200 text-sm" data-profile="Balanced">Balanced (×‘×¨×™×¨×ª ××—×“×œ)</button>
      <button type="button" class="px-3 py-2 rounded-lg bg-gray-100 hover:bg-gray-200 text-sm" data-profile="Quality">Quality (××™×›×•×ª)</button>
    </div>

    <!-- ×¤×¨××˜×¨×™× ×™×“× ×™×™× -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-3 text-sm">
      <label class="flex flex-col gap-1">
        JPEG Q (40â€“95)
        <input id="inJpegQ" type="number" min="40" max="95" value="70" class="border rounded px-2 py-1">
      </label>
      <label class="flex flex-col gap-1">
        encode_fps (0=×œ×œ× ×”×’×‘×œ×”)
        <input id="inEncodeFps" type="number" min="0" max="60" value="15" class="border rounded px-2 py-1">
      </label>
      <label class="flex flex-col gap-1">
        target_fps (×§×¦×‘ ×§×¨×™××”)
        <input id="inTargetFps" type="number" min="1" max="60" value="20" class="border rounded px-2 py-1">
      </label>
      <label class="flex flex-col gap-1">
        decimation (×“×™×œ×•×’ ×¤×¨×™×™××™×)
        <input id="inDecimation" type="number" min="1" max="8" value="1" class="border rounded px-2 py-1">
      </label>
    </div>

    <div class="flex items-center gap-2 relative">
      <button id="btnApplyParams" type="button"
              class="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 text-sm">
        ×”×—×œ ×™×“× ×™
      </button>

      <!-- ×›×¤×ª×•×¨: ×©×™× ×•×™ ×¨×–×•×œ×•×¦×™×” (×¤×•×ª×— ×ª×¤×¨×™×˜ 3 ××¤×©×¨×•×™×•×ª) -->
      <button id="btnResMenu" type="button"
              class="px-3 py-2 rounded-lg bg-gray-100 hover:bg-gray-200 text-sm">
        ×©×™× ×•×™ ×¨×–×•×œ×•×¦×™×”
      </button>

      <!-- ×ª×¤×¨×™×˜ ×¨×–×•×œ×•×¦×™×•×ª -->
      <div id="resMenu"
           class="hidden absolute top-full mt-2 right-24 z-20 w-56 bg-white border rounded-xl shadow-lg overflow-hidden">
        <button type="button" class="w-full text-right px-3 py-2 hover:bg-gray-100 text-sm" data-res="low">× ××•×›×” â€” 640Ã—360</button>
        <button type="button" class="w-full text-right px-3 py-2 hover:bg-gray-100 text-sm" data-res="medium">×‘×™× ×•× ×™×ª â€” 1280Ã—720</button>
        <button type="button" class="w-full text-right px-3 py-2 hover:bg-gray-100 text-sm" data-res="high">×’×‘×•×”×” â€” 1920Ã—1080</button>
      </div>

      <span id="applyStatus" class="text-sm text-gray-600">â€”</span>
    </div>

    <!-- ××™× ×“×™×§×¦×™×” ×—×™×” -->
    <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
      <div class="border rounded-xl p-3">
        <h5 class="font-semibold mb-2 text-sm">Intent (××” ×‘×™×§×©× ×•)</h5>
        <div class="text-xs space-y-1">
          <div>×¤×¨×•×¤×™×œ: <span id="stIntentProfile">â€”</span></div>
          <div>jpeg_q: <span id="stIntentJpegQ">â€”</span></div>
          <div>encode_fps: <span id="stIntentEncodeFps">â€”</span></div>
          <div>target_fps: <span id="stIntentTargetFps">â€”</span></div>
          <div>decimation: <span id="stIntentDecimation">â€”</span></div>
        </div>
      </div>
      <div class="border rounded-xl p-3">
        <h5 class="font-semibold mb-2 text-sm">Effective (××” ×‘×¤×•×¢×œ)</h5>
        <div class="text-xs space-y-1">
          <div>×’×•×“×œ: <span id="stEffSize">â€”</span></div>
          <div>FPS ×‘×¤×•×¢×œ: <span id="stEffFps">â€”</span></div>
          <div>×¢×•×“×›×Ÿ: <span id="stUpdatedAt">â€”</span></div>
        </div>
      </div>
    </div>
  </section>

  <!-- ××™× ×“×™×§×¦×™×•×ª ××¤×•×¨×˜×•×ª -->
  <section class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <div class="bg-white rounded-2xl shadow p-4">
      <h4 class="font-semibold mb-3">×¡×˜×˜×•×¡ ×•×™×“××•</h4>
      <dl class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm">
        <dt class="text-gray-500">××¦×‘:</dt>                <dd id="v-state" class="font-medium">â€”</dd>
        <dt class="text-gray-500">×¤×ª×•×— (opened):</dt>      <dd id="v-opened">â€”</dd>
        <dt class="text-gray-500">×¨×¥ (running):</dt>       <dd id="v-running">â€”</dd>
        <dt class="text-gray-500">FPS:</dt>                <dd id="v-fps">â€”</dd>
        <dt class="text-gray-500">×’×•×“×œ ×¤×¨×™×™×:</dt>        <dd id="v-size">â€”</dd>
        <dt class="text-gray-500">××§×•×¨:</dt>              <dd id="v-source">â€”</dd>
        <dt class="text-gray-500">××¦×‘ ×ª××•×¨×”:</dt>         <dd id="v-light">â€”</dd>
        <dt class="text-gray-500">×—×œ×•×Ÿ Preview ×¤×ª×•×—:</dt> <dd id="v-preview">â€”</dd>
        <dt class="text-gray-500">×©×’×™××” ××—×¨×•× ×”:</dt>      <dd id="v-error" class="text-red-600">â€”</dd>
        <dt class="text-gray-500">×¢×•×“×›×Ÿ:</dt>              <dd id="v-updated">â€”</dd>
      </dl>
    </div>

    <div class="bg-white rounded-2xl shadow p-4">
      <h4 class="font-semibold mb-3">×‘×¨×™××•×ª ×”×©×¨×ª</h4>
      <dl class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm">
        <dt class="text-gray-500">/healthz:</dt>      <dd id="h-ok">â€”</dd>
        <dt class="text-gray-500">×’×¨×¡×ª ××¤×œ×™×§×¦×™×”:</dt><dd id="h-ver">â€”</dd>
        <dt class="text-gray-500">×©×¢×ª ×©×¨×ª:</dt>       <dd id="h-now">â€”</dd>
        <dt class="text-gray-500">×–××Ÿ ×¨×™×¦×” (sec):</dt><dd id="h-uptime">â€”</dd>
      </dl>
      <p class="text-xs text-gray-500 mt-2">× ×¨×¢× ×Ÿ ×›×œ ~1.5 ×©× ×™×•×ª.</p>
    </div>

    <div class="bg-white rounded-2xl shadow p-4">
      <h4 class="font-semibold mb-3">Payload (×ª×§×¦×™×¨)</h4>
      <dl class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm">
        <dt class="text-gray-500">×’×¨×¡×ª payload:</dt> <dd id="p-ver">â€”</dd>
        <dt class="text-gray-500">timestamp:</dt>     <dd id="p-ts">â€”</dd>
        <dt class="text-gray-500">objdet.objects:</dt><dd id="p-obj">â€”</dd>
        <dt class="text-gray-500">objdet.tracks:</dt> <dd id="p-trk">â€”</dd>
        <dt class="text-gray-500">mp.landmarks:</dt>  <dd id="p-lms">â€”</dd>
        <dt class="text-gray-500">fps (×× ×§×™×™×):</dt> <dd id="p-fps">â€”</dd>
      </dl>
      <details class="mt-3">
        <summary class="text-xs text-gray-500 cursor-pointer">JSON ××œ×</summary>
        <pre id="p-json" class="text-xs bg-gray-50 border rounded p-2 overflow-auto max-h-56 whitespace-pre-wrap">â€”</pre>
      </details>
    </div>
  </section>
</div>
{% endblock %}

{% block scripts %}
  <!-- ×§×‘×¦×™ ×©×œ×™×˜×”/×–×¨×™××” -->
  <script defer src="{{ url_for('static', filename='js/video_stream.js') }}?v={{ app_version|default('dev', true) }}"></script>
  <script defer src="{{ url_for('static', filename='js/video_controls.js') }}?v={{ app_version|default('dev', true) }}"></script>

  <!-- ×—×™×‘×•×¨ ×”Ö¾IMG ×œÖ¾/video/stream.mjpg + ××™× ×“×™×§×¦×™×™×ª ×—×™×‘×•×¨ -->
  <script>
  (function(){
    'use strict';
    var img = document.getElementById('video-stream');
    var ph  = document.getElementById('video-placeholder');
    var dot = document.getElementById('dotConnected');
    var txt = document.getElementById('txtConnected');

    function setConn(on){
      dot.classList.toggle('bg-green-500', !!on);
      dot.classList.toggle('bg-gray-300', !on);
      txt.textContent = on ? '×–×¨× ×¤×¢×™×œ' : '××™×Ÿ ×–×¨× ×¤×¢×™×œ';
    }

    function setSrc(){
      // cache-buster ×›×“×™ ×œ×× ×•×¢ ×§××©/×‘××¤×¨×™× ×’ ×©×œ ×“×¤×“×¤×Ÿ/×¤×¨×•×§×¡×™
      var url = '/video/stream.mjpg?_=' + Date.now();
      img.src = url;
    }

    img.addEventListener('load', function(){
      // ×‘Ö¾IMG ×©×œ MJPEG load ××ª×§×‘×œ ××™×™×“×™×ª (×œ× ×›×œ ×¤×¨×™×™×) â€” ××¡×¤×™×§ ×œ× ×• ×œ××™× ×“×™×§×¦×™×”
      if (ph) ph.classList.add('hidden');
      setConn(true);
    });

    img.addEventListener('error', function(){
      if (ph) ph.classList.remove('hidden');
      setConn(false);
      // × ×¡×” ×œ×”×ª×—×‘×¨ ×©×•×‘ ××—×¨×™ ×¨×’×¢
      setTimeout(setSrc, 1200);
    });

    // ×”×ª×—×œ
    setSrc();
  })();
  </script>

  <!-- ××™× ×“×™×§×¦×™×•×ª ×›×œ×œ×™×•×ª (×¡×˜×˜×•×¡/health/payload) -->
  <script>
  (function(){
    'use strict';
    function $(id){ return document.getElementById(id); }

    function setVideoState(s){
      $('v-state').textContent   = (s && s.state) || 'â€”';
      $('v-opened').textContent  = String(!!(s && s.opened));
      $('v-running').textContent = String(!!(s && s.running));
      $('v-fps').textContent     = (s && (s.fps ?? 'â€”'));
      $('v-size').textContent    = (s && s.size && s.size.length === 2) ? (s.size[0] + 'Ã—' + s.size[1]) : 'â€”';
      $('v-source').textContent  = (s && s.source) || 'â€”';
      $('v-light').textContent   = (s && s.light_mode) || 'â€”';
      $('v-preview').textContent = String(!!(s && s.preview_window_open));
      $('v-error').textContent   = (s && s.error ? String(s.error).trim() : 'â€”');
      $('v-updated').textContent = new Date().toLocaleTimeString();

      var connected = !!(s && (s.opened || s.running));
      var dot = $('dotConnected'), txt = $('txtConnected');
      if (dot){
        dot.classList.toggle('bg-green-500', connected);
        dot.classList.toggle('bg-gray-300', !connected);
      }
      if (txt) txt.textContent = connected ? '×–×¨× ×¤×¢×™×œ' : '××™×Ÿ ×–×¨× ×¤×¢×™×œ';
    }

    function setHealth(h){
      $('h-ok').textContent  = (h && (h.ok === true || h.ok === 'true')) ? 'OK' : 'NOT OK';
      $('h-ver').textContent = (h && (h.ver || h.version)) || '{{ app_version|default("dev", true) }}';
      $('h-now').textContent = h && h.now ? new Date(h.now*1000).toLocaleTimeString() : new Date().toLocaleTimeString();
      var up = h && h.uptime_sec;
      $('h-uptime').textContent = (Number.isFinite(up) ? String(up) : 'â€”');
    }

    function setPayload(p){
      p = p || {};
      $('p-ver').textContent = p.payload_version ?? 'â€”';
      $('p-ts').textContent  = p.ts ? String(p.ts) : 'â€”';
      var od   = (p.objdet && typeof p.objdet === 'object') ? p.objdet : {};
      var objs = Array.isArray(od.objects) ? od.objects.length : 0;
      var trks = Array.isArray(od.tracks)  ? od.tracks.length  : 0;
      var mp   = (p.mp && typeof p.mp === 'object') ? p.mp : {};
      var lms  = Array.isArray(mp.landmarks) ? mp.landmarks.length : 0;
      $('p-obj').textContent = String(objs);
      $('p-trk').textContent = String(trks);
      $('p-lms').textContent = String(lms);
      $('p-fps').textContent = (p.fps ?? (p.meta && p.meta.fps_est) ?? 'â€”');
      try { $('p-json').textContent = JSON.stringify(p, null, 2); } catch(_){ $('p-json').textContent = 'â€”'; }
    }

    async function fetchJson(url, timeoutMs){
      timeoutMs = timeoutMs || 4000;
      var ctrl = new AbortController();
      var t = setTimeout(function(){ try{ ctrl.abort(); }catch(_){ } }, timeoutMs);
      try{
        var r = await fetch(url, { cache:'no-store', signal: ctrl.signal });
        if(!r.ok) throw new Error('HTTP '+r.status);
        return await r.json();
      }catch(_){ return null; } finally { clearTimeout(t); }
    }

    async function tick(){
      var st = await fetchJson('/api/video/status', 3000);
      if (st) setVideoState(st);
      var h  = await fetchJson('/healthz', 3000);
      setHealth(h);
      var p  = await fetchJson('/payload', 3000);
      if (p) setPayload(p);
    }

    tick();
    setInterval(tick, 1500);
  })();
  </script>
{% endblock %}
