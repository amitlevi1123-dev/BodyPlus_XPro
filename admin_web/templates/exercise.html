{% extends "base.html" %}
{% block title %}זיהוי תרגיל · BodyPlus XPro{% endblock %}
{% block page_title %}זיהוי תרגיל{% endblock %}

{% block head %}
<style>
  :root{
    --border:#e5e7eb; --muted:#6b7280; --ink:#111827; --bg:#fff;
    --subtle:#f8fafc; --chip:#f1f5f9; --chip-border:#e5e7eb;
    --ok:#22c55e; --warn:#f97316; --bad:#ef4444; --muted2:#9ca3af;
  }
  html[dir="rtl"] .ltr { direction:ltr }

  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
  .card{background:var(--bg);border:1px solid var(--border);border-radius:1rem}
  .card-h{padding:.9rem 1.1rem;border-bottom:1px solid #eef2f7}
  .card-b{padding:1rem 1.1rem}

  /* 🔵 Gauges */
  .gauge{width:128px;height:128px}
  .gauge .bg{stroke:#e5e7eb}
  .gauge .fg{stroke-linecap:round;transition:stroke-dashoffset .6s ease, stroke .25s ease}
  .gauge .label{font-size:14px;fill:#6b7280}
  .gauge .value{font-size:22px;font-weight:700;fill:#111827}

  /* Modal */
  .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:flex-start; justify-content:center; padding:4vh 1rem; z-index:60; }
  .modal-backdrop.show{ display:flex; }
  .modal-card{ width:min(1080px, 96vw); max-height:92vh; overflow:auto; background:#fff; border:1px solid #e5e7eb; border-radius:1rem; box-shadow:0 10px 25px rgba(0,0,0,.12); }
  .modal-tabs{ display:flex; gap:.25rem; border-bottom:1px solid var(--border); padding:0 .5rem }
  .modal-tab{ padding:.55rem .8rem; border:1px solid transparent; border-radius:.6rem .6rem 0 0; cursor:pointer; color:#475569 }
  .modal-tab.active{ background:#fff; border-color:var(--border) var(--border) #fff var(--border); color:#111827; }

  .pill{ display:inline-flex; align-items:center; gap:.3rem; padding:.2rem .55rem; border-radius:9999px; font-size:.75rem; }
  .pill-k{ background:#eef2ff; color:#3730a3; }
  .pill-r{ background:#fee2e2; color:#991b1b; }
  .chip{display:inline-flex;align-items:center;background:var(--chip);border:1px solid var(--chip-border);border-radius:9999px;padding:.2rem .55rem;font-size:.75rem;color:#334155}

  .status-dot{width:10px;height:10px;border-radius:9999px;background:#ef4444;display:inline-block}
  .status-dot.connected{background:#22c55e}

  /* Tables (לא גולשות) */
  .table-wrap{ overflow-x:auto; }
  .mtable{
    width:100%; border-collapse:separate; border-spacing:0; border:1px solid var(--border);
    border-radius:.8rem; overflow:hidden; table-layout:fixed; /* חשוב נגד גלישות */
    min-width:720px;
  }
  .mtable th, .mtable td{
    padding:.5rem .6rem; border-bottom:1px solid var(--border); font-size:.875rem; vertical-align:middle;
    overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
  }
  .mtable thead th{ background:#f8fafc; color:#334155; font-weight:600 }
  .mtable tr:last-child td{ border-bottom:none }

  /* Key/Value grids */
  .kv-grid{ display:grid; grid-template-columns: 1fr auto; gap:.35rem .8rem }
  .kv-key{ color:#475569 }
  .kv-val{ font-weight:600; color:#1f2937; direction:ltr }

  .hint{ font-size:.8rem; color:#64748b }
  .badge{display:inline-flex;align-items:center;gap:.35rem;padding:.2rem .55rem;border-radius:9999px;font-size:.75rem;background:#f1f5f9;border:1px solid #e5e7eb}
  .score-badge{font-weight:700}

  /* עיגול צבעוני לכל חזרה */
  .rep-badge{ display:inline-flex; align-items:center; gap:.45rem; }
  .rep-dot{ width:10px; height:10px; border-radius:9999px; background:#9ca3af; flex:none; }
  .rep-dot.red{ background:#ef4444; }
  .rep-dot.orange{ background:#f97316; }
  .rep-dot.green{ background:#22c55e; }
  .rep-dot.gray{ background:#9ca3af; }

  /* סיכום סט */
  .set-summary{ background:#f8fafc; border:1px solid var(--border); border-radius:.8rem; padding:.6rem .75rem; }
  .set-summary .sub{ color:#64748b; font-size:.85rem }
</style>
{% endblock %}

{% block content %}

<!-- כותרת עליונה: זיהוי + בורר שפה + פרטי תרגיל -->
<div class="card mb-6">
  <div class="card-h flex items-center justify-between">
    <div class="flex items-center gap-3">
      <div class="font-semibold">זיהוי תרגיל</div>
      <div class="text-xs text-gray-500">מציג שמות ויחידות מתוך <span class="mono">aliases.yaml</span></div>
    </div>
    <div class="flex items-center gap-2">
      <span class="text-sm text-gray-600">שפה:</span>
      <select id="langSelect" class="form-select rounded-lg border-gray-300">
        <option value="he" selected>עברית</option>
        <option value="en">English</option>
      </select>
    </div>
  </div>
  <div class="card-b">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
      <div class="border rounded-xl p-3">
        <div class="text-xs text-gray-500 mb-1">תרגיל</div>
        <div class="flex items-center justify-between">
          <div>
            <div class="font-semibold" id="exNameHe">—</div>
            <div class="text-sm text-gray-500" id="exNameEn">—</div>
          </div>
          <span class="badge"><span class="rep-dot green"></span><span id="exerciseId">—</span></span>
        </div>
      </div>
      <div class="border rounded-xl p-3">
        <div class="text-xs text-gray-500 mb-1">משפחה</div>
        <div class="flex items-center justify-between">
          <div>
            <div class="font-semibold" id="familyHe">—</div>
            <div class="text-sm text-gray-500" id="familyEn">—</div>
          </div>
          <span class="badge" id="familyKey">—</span>
        </div>
      </div>
      <div class="border rounded-xl p-3">
        <div class="text-xs text-gray-500 mb-1">ציוד</div>
        <div class="flex items-center justify-between">
          <div>
            <div class="font-semibold" id="equipHe">—</div>
            <div class="text-sm text-gray-500" id="equipEn">—</div>
          </div>
          <span class="badge" id="equipmentKey">—</span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- שורת עליונה: וידאו חי + סטטוס -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
  <!-- וידאו חי -->
  <div class="lg:col-span-2 card overflow-hidden">
    <div class="card-h flex items-center justify-between">
      <div class="font-semibold">וידאו חי</div>
      <div class="text-sm text-gray-500">
        מקור: <span id="vidSource">—</span> · FPS: <span id="vidFps">—</span> · גודל: <span id="vidSize">—</span>
      </div>
    </div>
    <div class="card-b">
      <img id="videoFeed" src="/video/stream.mjpg" alt="Video stream"
           class="w-full h-[380px] object-contain bg-gray-50 rounded-lg border border-gray-200" />
      <div class="text-xs text-gray-500 mt-2">אם לא רואים וידאו: ודא שהסטרימר פעיל (בדף <span class="mono">/video</span>).</div>
    </div>
  </div>

  <!-- סטטוס חיבור + מדדי ציון -->
  <div class="card">
    <div class="card-h font-semibold">סטטוס · ציונים חיים</div>
    <div class="card-b">
      <div class="space-y-3">
        <div class="flex items-center gap-3">
          <span class="status-dot" id="exerciseStatusDot"></span>
          <div class="text-sm text-gray-600">חיבור API / מצב סטרים</div>
        </div>

        <div class="flex items-center gap-3">
          <span class="status-dot" id="healthDot"></span>
          <div class="text-sm text-gray-600">בריאות מערכת (healthz)</div>
          <span class="text-xs text-gray-500" id="healthInfo">—</span>
        </div>
        <div class="flex items-center gap-3">
          <span class="status-dot" id="readyDot"></span>
          <div class="text-sm text-gray-600">מוכנות (readyz)</div>
          <span class="text-xs text-gray-500" id="readyInfo">—</span>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div class="flex flex-col items-center gap-1">
            <div id="gaugeRep" class="gauge" title=""></div>
            <div class="text-sm text-gray-600">חזרה אחרונה</div>
          </div>
          <div class="flex flex-col items-center gap-1">
            <div id="gaugeSet" class="gauge" title=""></div>
            <div class="text-sm text-gray-600">סט אחרון</div>
          </div>
        </div>

        <div class="text-xs text-gray-500">
          מדרג צבעים:
          <span class="font-medium text-red-600">אדום</span> (0–60%)
          · <span class="font-medium text-orange-500">כתום</span> (60–75%)
          · <span class="font-medium text-green-600">ירוק</span> (75–100%)
        </div>
      </div>
    </div>
  </div>
</div>

<!-- פאנל “נמדד מול יעד” — סט -->
<div class="card mt-6">
  <div class="card-h flex items-center justify-between">
    <div class="font-semibold">סט — נמדד מול יעד (לפי thresholds)</div>
    <div class="text-sm text-gray-500">תצוגה דו־לשונית לפי <span class="mono">aliases.yaml</span></div>
  </div>
  <div class="card-b">
    <div class="table-wrap">
      <table class="mtable" id="setTargetsTable">
        <thead>
          <tr>
            <th style="width:24%">קריטריון</th>
            <th style="width:18%">נמדד</th>
            <th style="width:26%">יעד</th>
            <th style="width:16%">% ציון</th>
            <th style="width:16%">הערה</th>
          </tr>
        </thead>
        <tbody>
          <tr><td colspan="5" class="py-6 text-center text-gray-400">— אין נתונים —</td></tr>
        </tbody>
      </table>
    </div>
    <div class="mt-3 text-sm">
      <span class="score-badge">סיכום סט: </span><span id="setSummaryHe">—</span>
      <span class="text-gray-400 mx-2">|</span>
      <span id="setSummaryEn" class="text-gray-500">—</span>
    </div>
  </div>
</div>

<!-- פאנל “נמדד מול יעד” — חזרה -->
<div class="card mt-6">
  <div class="card-h flex items-center justify-between">
    <div class="font-semibold">חזרה — נמדד מול יעד</div>
    <div class="text-sm text-gray-500">לחיצה על חזרה תפתח פירוט</div>
  </div>
  <div class="card-b">
    <div class="table-wrap">
      <table class="mtable" id="repTargetsTable">
        <thead>
          <tr>
            <th style="width:8%">סט</th>
            <th style="width:8%">חזרה</th>
            <th style="width:24%">קריטריון</th>
            <th style="width:18%">נמדד</th>
            <th style="width:26%">יעד</th>
            <th style="width:16%">% ציון</th>
          </tr>
        </thead>
        <tbody>
          <tr><td colspan="6" class="py-6 text-center text-gray-400">— אין נתונים —</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- פאנל סימולטור -->
<div class="card mt-6">
  <div class="card-h flex items-center justify-between">
    <div class="font-semibold">סימולטור חזרות/סטים (UI בלבד)</div>
    <div class="text-sm text-gray-500">מייצר דוחות מדומים לבדיקה ויזואלית</div>
  </div>
  <div class="card-b space-y-4">
    <div class="grid grid-cols-1 lg:grid-cols-6 gap-3">
      <label class="flex items-center gap-2">
        <span class="w-24 text-sm text-gray-600">סטים</span>
        <input id="simSets" type="number" min="1" max="10" value="2" class="form-input w-28 rounded-lg border-gray-300"/>
      </label>
      <label class="flex items-center gap-2">
        <span class="w-24 text-sm text-gray-600">חזרות/סט</span>
        <input id="simReps" type="number" min="1" max="30" value="5" class="form-input w-28 rounded-lg border-gray-300"/>
      </label>
      <label class="flex items-center gap-2">
        <span class="w-24 text-sm text-gray-600">מצב</span>
        <select id="simMode" class="form-select w-40 rounded-lg border-gray-300">
          <option value="good">Good (דוגמה טובה)</option>
          <option value="shallow">Shallow (עומק חלש)</option>
          <option value="missing">Missing Critical</option>
          <option value="mixed" selected>Mixed (משולב)</option>
        </select>
      </label>
      <label class="flex items-center gap-2">
        <span class="w-24 text-sm text-gray-600">% רעש</span>
        <input id="simNoise" type="number" step="0.01" min="0" max="0.5" value="0.25" class="form-input w-28 rounded-lg border-gray-300"/>
      </label>
      <div class="flex items-center gap-2 lg:col-span-2">
        <button id="btnSimRun" class="px-4 py-2 rounded-lg text-white bg-primary hover:opacity-90">התחל סימולציה</button>
        <button id="btnSimClear" class="px-4 py-2 rounded-lg border border-gray-300 hover:bg-gray-50">נקה טבלה</button>
        <button id="btnServerScore" class="px-4 py-2 rounded-lg text-white bg-indigo-600 hover:opacity-90">דוח ניקוד (שרת)</button>
        <button id="btnOpenLastJson" class="px-4 py-2 rounded-lg border border-gray-300 hover:bg-gray-50">פתח JSON אחרון</button>
      </div>
    </div>

    <div class="table-wrap border rounded-xl">
      <table class="mtable">
        <thead>
          <tr class="text-gray-600">
            <th>סט</th>
            <th>חזרה</th>
            <th>תרגיל</th>
            <th>% ציון</th>
            <th>איכות</th>
            <th>Unscored</th>
            <th>הערה</th>
            <th>JSON</th>
            <th>פירוט</th>
          </tr>
        </thead>
        <tbody id="simTbody">
          <tr><td colspan="9" class="py-6 text-center text-gray-400">אין נתונים — הרץ סימולציה</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- דיאגנוסטיקה -->
<div class="card mt-6">
  <div class="card-h font-semibold">דיאגנוסטיקות חיות (SSE)</div>
  <div class="card-b">
    <div class="flex items-center gap-2">
      <button id="btnDiagStart" class="px-3 py-1.5 rounded-lg border border-gray-300 hover:bg-gray-50">SSE הפעל</button>
      <button id="btnDiagStop" class="px-3 py-1.5 rounded-lg border border-gray-300 hover:bg-gray-50">עצור</button>
      <button id="btnDiagSnap" class="px-3 py-1.5 rounded-lg border border-gray-300 hover:bg-gray-50">Snapshot</button>
      <span class="text-sm text-gray-500">נתיב: <span class="mono">/api/exercise/diag/stream</span></span>
    </div>
    <pre id="diagBox" class="mono text-xs text-gray-700 mt-3 border rounded-xl p-3 max-h-64 overflow-auto bg-gray-50">—</pre>
  </div>
</div>

<!-- Modal: פירוט -->
<div id="details-modal" class="modal-backdrop" role="dialog" aria-modal="true">
  <div class="modal-card">
    <div class="p-4 border-b">
      <div class="flex items-center justify-between">
        <div>
          <div class="text-lg font-semibold">פירוט ביצוע</div>
          <div id="details-sub" class="text-sm text-gray-500">—</div>
        </div>
        <button id="details-close" class="px-3 py-2 rounded-lg bg-gray-100 hover:bg-gray-200">סגור</button>
      </div>
      <div class="modal-tabs mt-3">
        <div class="modal-tab active" data-tab="crit">קריטריונים</div>
        <div class="modal-tab" data-tab="metrics">מדדים</div>
        <div class="modal-tab" data-tab="raw">Raw</div>
      </div>
    </div>

    <div class="p-4">
      <!-- Tab: קריטריונים -->
      <div id="tab-crit">
        <div id="details-chips" class="flex flex-wrap items-center gap-2 mb-3"></div>
        <div id="details-lists" class="space-y-3"></div>
      </div>

      <!-- Tab: metrics_detail -->
      <div id="tab-metrics" style="display:none">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
          <div class="card">
            <div class="card-h font-semibold">טמפו (per-rep)</div>
            <div class="card-b">
              <div id="md-tempo-table">—</div>
              <div class="hint mt-2">מציג רק שדות זמינים מתוך ה־payload.</div>
            </div>
          </div>
          <div class="lg:col-span-2 card">
            <div class="card-h font-semibold">מדדים נבחרים</div>
            <div class="card-b grid grid-cols-1 lg:grid-cols-3 gap-6">
              <div>
                <div class="font-semibold mb-2">מפרקים</div>
                <div id="md-joints" class="kv-grid"></div>
              </div>
              <div>
                <div class="font-semibold mb-2">עמידה</div>
                <div id="md-stance" class="kv-grid"></div>
              </div>
              <div>
                <div class="font-semibold mb-2">אחר</div>
                <div id="md-other" class="kv-grid"></div>
              </div>
            </div>
            <div class="px-4 pb-3">
              <details>
                <summary class="cursor-pointer text-sm text-gray-500">יעדים (targets)</summary>
                <pre id="md-targets" class="mono text-xs text-gray-700 p-3 bg-gray-50 rounded-xl border mt-2">—</pre>
              </details>
            </div>
          </div>
        </div>
      </div>

      <!-- Tab: Raw JSON -->
      <div id="tab-raw" style="display:none">
        <pre id="details-raw" class="mono text-xs text-gray-600 max-h-[55vh] overflow-auto border rounded-xl p-3 bg-gray-50">—</pre>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/exercise.js') }}?v={{ app_version|default('dev', true) }}"></script>
{% endblock %}
