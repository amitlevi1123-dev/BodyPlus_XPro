{% extends "base.html" %}
{% block title %}×©×™×“×•×¨ ××¦×œ××” Â· BodyPlus XPro{% endblock %}
{% block page_title %}×©×™×“×•×¨ ××¦×œ××” (Ingest){% endblock %}

{% block head %}
<style>
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
  .card{background:#fff;border:1px solid #e5e7eb;border-radius:1rem}
  .card-h{padding:.9rem 1.1rem;border-bottom:1px solid #eef2f7}
  .card-b{padding:1rem 1.1rem}

  .status-dot{width:10px;height:10px;border-radius:9999px;background:#94a3b8;display:inline-block}
  .status-dot.ok{background:#22c55e}.status-dot.warn{background:#f59e0b}.status-dot.err{background:#ef4444}

  .metric{background:#f8fafc;border:1px solid #e5e7eb;border-radius:.8rem;padding:.65rem}
  .metric .v{font-size:18px;font-weight:700;color:#111827}
  .metric .k{font-size:12px;color:#64748b}

  details.topic{background:#fff;border:1px solid #e5e7eb;border-radius:.9rem;padding:.6rem .8rem}
  details.topic + details.topic{margin-top:.6rem}
  details.topic summary{cursor:pointer;list-style:none;outline:none;font-weight:600;color:#111827}
  .topic-body{margin-top:.6rem;display:grid;gap:.6rem;grid-template-columns: repeat(auto-fit,minmax(200px,1fr))}
  .topic-actions{display:flex;gap:.5rem;flex-wrap:wrap}

  /* ×§×œ×˜×™× */
  .form{background:#fff;border:1px solid #e5e7eb;border-radius:.65rem;padding:.5rem .7rem}
  .chk{transform:scale(1.1);}

  /* ××–×•×¨ ×”×¤×¨×™×•×•×™×• */
  .preview-wrap{position:relative;overflow:hidden;border-radius:1rem;border:1px solid #e5e7eb}
  #video,#canvas{width:100%;max-height:70vh;background:#000;display:block;border-bottom-left-radius:1rem;border-bottom-right-radius:1rem}
  .hud{position:absolute;top:10px;left:10px;background:rgba(0,0,0,.45);padding:.45rem .6rem;border-radius:.6rem;font-size:12px;color:#e5e7eb;border:1px solid rgba(255,255,255,.08)}

  .errbox{background:#fff1f2;border:1px solid #fecaca;color:#991b1b;padding:.6rem .8rem;border-radius:.7rem}
  .hint{color:#64748b;font-size:.85rem}
  code{background:#f1f5f9;padding:.15rem .35rem;border-radius:.4rem;border:1px solid #e2e8f0}

  /* × ×§×•×“×•×ª ××¦×‘ ××™××™×Ÿ */
  .dot{width:10px;height:10px;border-radius:9999px;background:#94a3b8;display:inline-block}
  .dot.ok{background:#22c55e}.dot.warn{background:#f59e0b}.dot.err{background:#ef4444}
</style>
{% endblock %}

{% block content %}
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
  <!-- ×©×××œ: ×‘×§×¨×•×ª + ×¤×¨×™×•×•×™×• -->
  <div class="lg:col-span-2 space-y-4">
    <!-- ×‘×§×¨×•×ª ×œ×¤×™ × ×•×©× -->
    <div class="card">
      <div class="card-h font-semibold">×‘×§×¨×•×ª</div>
      <div class="card-b space-y-3">
        <!-- × ×•×©×: ××§×•×¨ ××¦×œ××” -->
        <details class="topic" open>
          <summary>ğŸ“· ××§×•×¨ ××¦×œ××”</summary>
          <div class="topic-body">
            <label class="block">
              <div class="text-sm text-gray-600 mb-1">××¦×œ××”</div>
              <select id="cameraSelect" class="form w-full"></select>
            </label>
            <label class="block">
              <div class="text-sm text-gray-600 mb-1">×¨×–×•×œ×•×¦×™×”</div>
              <select id="resSelect" class="form w-full">
                <option value="640x360">640Ã—360</option>
                <option value="1280x720" selected>1280Ã—720</option>
                <option value="1920x1080">1920Ã—1080</option>
              </select>
            </label>
            <label class="inline-flex items-center gap-2 mt-1">
              <input id="mirror" type="checkbox" class="chk" checked />
              <span class="text-sm text-gray-700">××¨××” (Mirror)</span>
            </label>
          </div>
        </details>

        <!-- × ×•×©×: ×©×™×“×•×¨ ×•××™×›×•×ª -->
        <details class="topic" open>
          <summary>ğŸ“¡ ×©×™×“×•×¨ ×•××™×›×•×ª</summary>
          <div class="topic-body">
            <label class="block">
              <div class="text-sm text-gray-600 mb-1">FPS ×©×™×“×•×¨</div>
              <input id="fpsInput" type="number" min="1" max="60" value="15" class="form w-full" />
            </label>
            <label class="block">
              <div class="text-sm text-gray-600 mb-1">××™×›×•×ª JPEG</div>
              <input id="jpgQ" type="number" min="40" max="95" value="80" class="form w-full" />
            </label>
            <label class="inline-flex items-center gap-2 mt-1">
              <input id="hudToggle" type="checkbox" class="chk" checked />
              <span class="text-sm text-gray-700">HUD ×‘×¤×¨×™×•×•×™×•</span>
            </label>
          </div>
        </details>

        <!-- × ×•×©×: ××‘×˜×—×”/×˜×•×§×Ÿ -->
        <details class="topic">
          <summary>ğŸ” ××‘×˜×—×” / ×˜×•×§×Ÿ</summary>
          <div class="topic-body" style="grid-template-columns:minmax(260px,1fr)">
            <label class="block">
              <div class="text-sm text-gray-600 mb-1">Token (××•×¤×¦×™×•× ×œ×™)</div>
              <input id="token" type="text" placeholder="X-Ingest-Token" class="form w-full" />
            </label>
          </div>
        </details>

        <!-- × ×•×©×: ×¤×¢×•×œ×•×ª -->
        <details class="topic" open>
          <summary>â–¶ï¸ ×¤×¢×•×œ×•×ª</summary>
          <div class="topic-actions">
            <button id="startBtn" class="px-4 py-2 rounded-lg text-white bg-blue-600 hover:opacity-90">×”×ª×—×œ ×©×™×“×•×¨</button>
            <button id="stopBtn" class="px-4 py-2 rounded-lg border border-gray-300 hover:bg-gray-50" disabled>×¢×¦×•×¨</button>
          </div>
        </details>
      </div>
    </div>

    <!-- ×¤×¨×™×•×•×™×• ×•×™×“××• -->
    <div class="card overflow-hidden">
      <div class="card-h flex items-center justify-between">
        <div class="font-semibold">×¤×¨×™×•×•×™×• ××¦×œ××”</div>
        <div class="text-sm text-gray-500">
          ××¦×‘: <span id="state">IDLE</span> Â· Tx FPS: <span id="txFps">0.0</span> Â· Latency: <span id="latMs">â€“</span> ms Â· Frame: <span id="frameSize">â€“</span>
        </div>
      </div>
      <div class="card-b">
        <div class="preview-wrap">
          <video id="video" autoplay playsinline muted></video>
          <canvas id="canvas" style="display:none"></canvas>
          <div class="hud" id="hudBox" hidden>
            <div><b>××¦×‘:</b> <span id="state_hud">IDLE</span></div>
            <div><b>Tx FPS:</b> <span id="txFps_hud">0.0</span></div>
            <div><b>Latency:</b> <span id="latMs_hud">â€“</span> ms</div>
            <div><b>Frame:</b> <span id="frameSize_hud">â€“</span></div>
          </div>
        </div>
        <div id="err" class="errbox mt-3 hidden"></div>
        <div class="hint mt-2">
          ×˜×™×¤: ×¤×ª×—/×™ ×‘×˜××‘ × ×•×¡×£ ××ª <code>/video/stream.mjpg?hud=1</code> ×›×“×™ ×œ×¨××•×ª ××ª ×”×–×¨×™××” ×©××ª×¤×¨×¡××ª ×œ×©×¨×ª.
        </div>
      </div>
    </div>
  </div>

  <!-- ×™××™×Ÿ: ×¡×˜×˜×•×¡ + ××“×“×™× + ×§×™×¦×•×¨×™ ×“×¨×š -->
  <div class="space-y-4">
    <div class="card">
      <div class="card-h font-semibold">×¡×˜×˜×•×¡</div>
      <div class="card-b flex items-center gap-3">
        <span class="dot" id="dot"></span>
        <div id="statusText" class="text-sm text-gray-700">×××ª×™×Ÿ ×œ×”×ª×—×œ×”â€¦</div>
      </div>
    </div>

    <div class="card">
      <div class="card-h font-semibold">××“×“×™×</div>
      <div class="card-b grid grid-cols-2 gap-3">
        <div class="metric">
          <div class="v" id="m_tx">0.0</div>
          <div class="k">Tx FPS (× ×©×œ×—)</div>
        </div>
        <div class="metric">
          <div class="v" id="m_lat">â€“</div>
          <div class="k">Latency (ms)</div>
        </div>
        <div class="metric">
          <div class="v" id="m_res">â€“</div>
          <div class="k">×¨×–×•×œ×•×¦×™×”</div>
        </div>
        <div class="metric">
          <div class="v" id="m_sent">0</div>
          <div class="k">×¤×¨×™×™××™× ×©× ×©×œ×—×•</div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-h font-semibold">×§×™×¦×•×¨×™ ×“×¨×š</div>
      <div class="card-b grid gap-2 text-blue-700">
        <a href="/video/stream.mjpg?hud=1" target="_blank" class="hover:underline">/video/stream.mjpg?hud=1</a>
        <a href="/api/video/status" target="_blank" class="hover:underline">/api/video/status</a>
        <a href="/version" target="_blank" class="hover:underline">/version</a>
        <a href="/healthz" target="_blank" class="hover:underline">/healthz</a>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
(() => {
  const el = (id) => document.getElementById(id);

  const video = el('video');
  const canvas = el('canvas');
  const hudBox = el('hudBox');
  const stateEl = el('state');
  const txFpsEl = el('txFps');
  const latEl = el('latMs');
  const fsizeEl = el('frameSize');
  const dot = el('dot');
  const statusText = el('statusText');

  /* ××¨××•×ª ×’× ×‘×ª×•×š HUD ×›×“×™ ×©×œ× × ×¦×˜×¨×š ×œ×©× ×•×ª ×œ×•×’×™×§×” ×§×™×™××ª */
  const stateHud = el('state_hud');
  const txFpsHud = el('txFps_hud');
  const latHud = el('latMs_hud');
  const frameHud = el('frameSize_hud');

  const m_tx = el('m_tx');
  const m_lat = el('m_lat');
  const m_res = el('m_res');
  const m_sent = el('m_sent');

  const cameraSelect = el('cameraSelect');
  const resSelect    = el('resSelect');
  const fpsInput     = el('fpsInput');
  const jpgQ         = el('jpgQ');
  const mirror       = el('mirror');
  const hudToggle    = el('hudToggle');
  const tokenInp     = el('token');

  const startBtn = el('startBtn');
  const stopBtn  = el('stopBtn');
  const errBox   = el('err');

  let stream = null;
  let sending = false;
  let sentCount = 0;
  let txTimes = [];

  function showErr(msg){
    if(!msg){ errBox.classList.add('hidden'); errBox.textContent=''; return; }
    errBox.classList.remove('hidden'); errBox.textContent = msg;
  }

  function setDot(mode){
    dot.classList.remove('ok','warn','err');
    if(mode) dot.classList.add(mode);
  }
  function setState(s){
    stateEl.textContent = s;
    statusText.textContent = s;
    if(stateHud) stateHud.textContent = s;
  }
  function setHudVisible(v){ hudBox.hidden = !v; }

  async function listCameras(){
    const devices = await navigator.mediaDevices.enumerateDevices();
    const cams = devices.filter(d => d.kind === 'videoinput');
    cameraSelect.innerHTML = '';
    cams.forEach((d,i)=>{
      const o = document.createElement('option');
      o.value = d.deviceId;
      o.textContent = d.label || `××¦×œ××” ${i+1}`;
      cameraSelect.appendChild(o);
    });
    const back = cams.find(d => /back|rear/i.test(d.label));
    if(back) cameraSelect.value = back.deviceId;
  }

  function parseRes(val){
    const [w,h] = (val||'1280x720').split('x').map(v => parseInt(v,10));
    return {width:w||1280, height:h||720};
  }

  async function openCamera(){
    const {width, height} = parseRes(resSelect.value);
    const deviceId = cameraSelect.value || undefined;
    const constraints = {
      audio:false,
      video:{
        width:{ideal:width}, height:{ideal:height},
        frameRate:{ideal:30, max:60},
        ...(deviceId ? { deviceId:{exact:deviceId} } : {}),
        facingMode: deviceId ? undefined : { ideal:"environment" }
      }
    };
    if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
    try{
      showErr('');
      const s = await navigator.mediaDevices.getUserMedia(constraints);
      stream = s;
      video.srcObject = s;
      await video.play();
      const vw = video.videoWidth, vh = video.videoHeight;
      canvas.width = vw; canvas.height = vh;
      fsizeEl.textContent = `${vw}Ã—${vh}`;
      if(frameHud) frameHud.textContent = `${vw}Ã—${vh}`;
      m_res.textContent = `${vw}Ã—${vh}`;
    }catch(e){
      console.error(e);
      showErr('×œ× × ×™×ª×Ÿ ×œ×¤×ª×•×— ××¦×œ××”. ×•×“× ×©×”×“×£ ×¢×œ HTTPS ×•×©×™×© ×”×¨×©××•×ª ××¦×œ××”.');
      throw e;
    }
  }

  function drawToCanvas(){
    const ctx = canvas.getContext('2d');
    const vw = video.videoWidth || canvas.width;
    const vh = video.videoHeight || canvas.height;
    canvas.width = vw; canvas.height = vh;
    ctx.save();
    if(mirror.checked){
      ctx.scale(-1,1); ctx.drawImage(video, -vw, 0, vw, vh);
    }else{
      ctx.drawImage(video, 0, 0, vw, vh);
    }
    ctx.restore();
  }

  function updateTxFps(){
    const now = performance.now();
    txTimes.push(now);
    while(txTimes.length && (now - txTimes[0]) > 2000) txTimes.shift();
    const fps = txTimes.length >= 2 ? (txTimes.length-1) / ((txTimes[txTimes.length-1]-txTimes[0])/1000) : 0;
    const v = fps.toFixed(1);
    txFpsEl.textContent = v;
    if(txFpsHud) txFpsHud.textContent = v;
    m_tx.textContent = v;
  }

  const sleep = (ms)=> new Promise(r=>setTimeout(r,ms));

  async function sendLoop(){
    const endpoint = '/api/ingest_frame';
    const targetFps = Math.max(1, Math.min(60, parseInt(fpsInput.value||'15',10)));
    const frameInterval = 1000 / targetFps;
    const quality = Math.max(40, Math.min(95, parseInt(jpgQ.value||'80',10))) / 100;

    setState(`SENDING @ ${targetFps} FPS`);
    setDot('ok');
    setHudVisible(hudToggle.checked);

    while(sending){
      const tStart = performance.now();
      try{
        drawToCanvas();
        const blob = await new Promise(res => canvas.toBlob(res, 'image/jpeg', quality));
        const ab = await blob.arrayBuffer();

        const headers = { 'Content-Type': 'image/jpeg' };
        const tok = (tokenInp.value||'').trim();
        if(tok) headers['X-Ingest-Token'] = tok;

        const r = await fetch(endpoint, { method:'POST', headers, body:ab, keepalive:true });
        if(!r.ok){
          let msg = `${r.status} ${r.statusText}`;
          try{ const j = await r.json(); if(j && j.error) msg += ` | ${j.error}` }catch(_){}
          throw new Error(msg);
        }

        const j = await r.json();
        const serverTs = j.ts_ms || 0;
        const nowMs = Date.now();
        if(serverTs){
          const lat = Math.max(0, nowMs - serverTs);
          latEl.textContent = lat;
          if(latHud) latHud.textContent = lat;
          m_lat.textContent = lat;
        }else{
          latEl.textContent = 'â€“'; if(latHud) latHud.textContent = 'â€“'; m_lat.textContent = 'â€“';
        }

        sentCount += 1;
        m_sent.textContent = String(sentCount);
        updateTxFps();
        showErr('');
      }catch(e){
        console.error('send error', e);
        showErr('×©×œ×™×—×ª ×¤×¨×™×™× × ×›×©×œ×”: ' + (e?.message || e));
        setDot('warn');
        await sleep(200);
      }

      const elapsed = performance.now() - tStart;
      const wait = Math.max(0, frameInterval - elapsed);
      if(wait>0) await sleep(wait);
    }

    setState('IDLE');
    setHudVisible(false);
    setDot('');
  }

  async function start(){
    try{
      await openCamera();
      sending = true;
      sentCount = 0;
      txTimes = [];
      startBtn.disabled = true;
      stopBtn.disabled = false;
      await sendLoop();
    }catch(_e){
      sending = false;
      startBtn.disabled = false;
      stopBtn.disabled = true;
    }
  }

  function stop(){
    sending = false;
    stopBtn.disabled = true;
    startBtn.disabled = false;
    if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
  }

  // ××™×¨×•×¢×™×
  startBtn.addEventListener('click', start);
  stopBtn.addEventListener('click', stop);
  hudToggle.addEventListener('change', ()=> setHudVisible(hudToggle.checked));
  resSelect.addEventListener('change', async ()=>{ if(sending) await openCamera(); });
  cameraSelect.addEventListener('change', async ()=>{ if(sending) await openCamera(); });

  // ××ª×—×•×œ
  (async ()=>{
    try{ await navigator.mediaDevices.getUserMedia({video:true,audio:false}); }catch(_){}
    try{ await listCameras(); }catch(e){ console.warn(e); }
    setState('IDLE'); setHudVisible(false);
  })();

  // × ×™×§×•×™
  window.addEventListener('beforeunload', ()=>{
    sending = false;
    if(stream) stream.getTracks().forEach(t=>t.stop());
  });
})();
</script>
{% endblock %}
